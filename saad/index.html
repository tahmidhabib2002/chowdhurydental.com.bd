<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes, viewport-fit=cover">
    <title>চৌধুরী ডেন্টাল কেয়ার</title>
    
    <!-- Fonts and Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+Bengali:wght@400;500;600;700&family=Hind+Siliguri:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#1a4d4a">

    <style>
        /* আপনার বিদ্যমান সকল CSS এখানে থাকবে, শুধু প্রয়োজনীয় কিছু সংযোজন */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Hind Siliguri', 'Noto Serif Bengali', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary: #1a4d4a;
            --primary-dark: #0e3a37;
            --primary-light: #e8f3f2;
            --primary-soft: #d4e9e7;
            --secondary: #c7a25c;
            --secondary-light: #faf3e5;
            --success: #2c6b3f;
            --success-light: #e6f3ea;
            --danger: #b44343;
            --danger-light: #fee9e9;
            --warning: #c78a2b;
            --warning-light: #fff4e0;
            --info: #3a6b9e;
            --info-light: #e3ecf5;
            --gray: #5f6b7a;
            --light-gray: #eef2f6;
            --dark: #1e2b3a;
            --white: #ffffff;
            --shadow-sm: 0 4px 12px rgba(0,0,0,0.05);
            --shadow-md: 0 8px 20px rgba(0,0,0,0.08);
            --shadow-lg: 0 15px 30px rgba(0,0,0,0.12);
            --border-radius: 24px;
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }

        body {
            background: #f8fafd;
            min-height: 100vh;
            padding-bottom: 85px;
            padding-top: var(--safe-top);
            opacity: 0;
            animation: fadeIn 0.4s ease forwards;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-30px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        .fade-in { animation: fadeIn 0.4s ease; }
        .slide-up { animation: slideUp 0.4s ease; }
        .slide-down { animation: slideDown 0.4s ease; }
        .scale-in { animation: scaleIn 0.3s ease; }
        .pulse { animation: pulse 2s infinite; }

        /* --- হেডার ও নেভিগেশন (আপনার বিদ্যমান স্টাইল) --- */
        .mobile-header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 22px 20px;
            border-radius: 0 0 32px 32px;
            box-shadow: var(--shadow-lg);
            position: sticky;
            top: 0;
            z-index: 100;
            padding-top: calc(22px + var(--safe-top));
            transition: all 0.3s ease;
        }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .clinic-name { font-size: 1.9rem; font-weight: 700; font-family: 'Noto Serif Bengali', serif; line-height: 1.2; letter-spacing: -0.5px; }
        .clinic-sub { font-size: 0.95rem; opacity: 0.9; margin-top: 4px; display: flex; align-items: center; gap: 6px; }
        .menu-btn { background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.25); color: white; width: 48px; height: 48px; border-radius: 20px; display: flex; align-items: center; justify-content: center; font-size: 1.4rem; cursor: pointer; backdrop-filter: blur(10px); transition: all 0.2s ease; }
        
        /* --- সার্চ বার (নতুন) --- */
        .search-container {
            padding: 15px 20px 5px 20px;
        }
        .search-box {
            display: flex;
            align-items: center;
            background: white;
            border-radius: 30px;
            padding: 5px 5px 5px 20px;
            box-shadow: var(--shadow-md);
            border: 2px solid var(--primary-light);
        }
        .search-box i {
            color: var(--primary);
            font-size: 1.2rem;
        }
        .search-box input {
            flex: 1;
            border: none;
            padding: 15px 10px;
            font-size: 1rem;
            outline: none;
            background: transparent;
        }
        .search-box button {
            background: var(--primary);
            border: none;
            color: white;
            padding: 12px 25px;
            border-radius: 30px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .search-box button:hover { background: var(--primary-dark); }

        /* --- স্ট্যাটস ও অ্যাকশন গ্রিড (আপনার বিদ্যমান স্টাইল) --- */
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; padding: 20px; margin-top: -15px; }
        .stat-card { background: white; padding: 22px 18px; border-radius: var(--border-radius); box-shadow: var(--shadow-md); display: flex; align-items: center; gap: 18px; border-bottom: 4px solid var(--primary); transition: all 0.3s ease; animation: slideUp 0.4s ease; cursor: pointer; }
        .stat-card.danger { border-bottom-color: var(--danger); }
        .stat-icon { width: 60px; height: 60px; background: var(--primary-light); border-radius: 20px; display: flex; align-items: center; justify-content: center; color: var(--primary); font-size: 1.8rem; transition: all 0.3s ease; }
        .stat-card:hover .stat-icon { transform: scale(1.1) rotate(5deg); }
        .stat-info h3 { font-size: 0.95rem; color: var(--gray); font-weight: 500; }
        .stat-number { font-size: 1.8rem; font-weight: 700; color: var(--dark); line-height: 1.2; }

        .action-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; padding: 0 20px 20px; }
        .action-card { background: white; border-radius: 20px; padding: 18px 8px; text-align: center; box-shadow: var(--shadow-sm); cursor: pointer; transition: all 0.3s ease; border: 2px solid transparent; animation: scaleIn 0.4s ease; }
        .action-card:hover { transform: translateY(-5px); border-color: var(--primary); box-shadow: var(--shadow-md); }
        .action-card:active { transform: scale(0.95); }
        .action-icon { width: 52px; height: 52px; background: var(--primary-light); border-radius: 18px; display: flex; align-items: center; justify-content: center; margin: 0 auto 12px; color: var(--primary); font-size: 1.6rem; transition: all 0.3s ease; }
        .action-card:hover .action-icon { transform: rotate(360deg); }
        .action-title { font-weight: 700; color: var(--dark); margin-bottom: 4px; font-size: 1rem; }
        .action-desc { font-size: 0.7rem; color: var(--gray); }

        /* --- সেকশন কার্ড (আপনার বিদ্যমান স্টাইল) --- */
        .section-card { background: white; border-radius: 32px; padding: 24px; margin: 0 20px 25px; box-shadow: var(--shadow-md); transition: all 0.3s ease; animation: slideUp 0.4s ease; }
        .section-title { display: flex; align-items: center; gap: 14px; margin-bottom: 22px; font-size: 1.4rem; font-weight: 700; color: var(--primary-dark); border-bottom: 2px solid var(--light-gray); padding-bottom: 18px; }

        /* --- ফর্ম এলিমেন্টস (আপনার বিদ্যমান স্টাইল) --- */
        .form-group { margin-bottom: 22px; animation: slideUp 0.3s ease; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--dark); font-size: 0.95rem; }
        .form-control { width: 100%; padding: 15px 18px; border: 2px solid var(--light-gray); border-radius: 18px; font-size: 1rem; transition: all 0.2s ease; background: white; }
        .form-control:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 5px rgba(26, 77, 74, 0.1); transform: translateY(-2px); }

        /* আপডেট: নম্বর ইনপুট থেকে ডিফল্ট স্পিনার সরানো */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type=number] { -moz-appearance: textfield; }

        .gender-group { display: flex; gap: 25px; align-items: center; background: #f8fafc; padding: 14px 18px; border-radius: 18px; border: 2px solid var(--light-gray); }
        .problem-container { margin-bottom: 20px; }
        .problem-item { background: #f8fafc; border-radius: 24px; padding: 22px; margin-bottom: 18px; border: 1px solid var(--light-gray); position: relative; transition: all 0.3s ease; animation: slideUp 0.4s ease; }
        .problem-item:hover { border-color: var(--primary); box-shadow: var(--shadow-md); }
        .problem-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 18px; }
        .problem-badge { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 6px 18px; border-radius: 40px; font-size: 0.9rem; font-weight: 600; }
        .remove-problem { background: none; border: none; color: var(--danger); font-size: 1.3rem; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s ease; }
        .remove-problem:hover { background: var(--danger-light); transform: rotate(90deg); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-bottom: 14px; }
        .crown-options { background: linear-gradient(135deg, #f8f4ff, #f0eaff); border-radius: 20px; padding: 18px; margin-top: 15px; display: none; animation: scaleIn 0.3s ease; border: 2px solid var(--primary-light); }
        .crown-options.active { display: block; }
        .shade-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 15px 0; }
        .shade-item { background: white; border: 2px solid var(--light-gray); border-radius: 14px; padding: 12px 5px; text-align: center; font-weight: 600; font-size: 0.95rem; cursor: pointer; transition: all 0.2s ease; }
        .shade-item.active { background: var(--primary); color: white; border-color: var(--primary); animation: pulse 1s; }
        .image-upload-area { border: 3px dashed var(--primary); border-radius: 24px; padding: 30px; text-align: center; background: var(--primary-light); margin: 25px 0; cursor: pointer; transition: all 0.3s ease; }
        .image-preview { display: flex; flex-wrap: wrap; gap: 12px; margin-top: 18px; }
        .preview-img { width: 80px; height: 80px; object-fit: cover; border-radius: 16px; border: 3px solid var(--primary); transition: all 0.3s ease; animation: scaleIn 0.3s ease; cursor: pointer; }
        .total-section { background: linear-gradient(145deg, #f8fafc, #f0f5fa); border-radius: 24px; padding: 22px; margin: 25px 0; animation: scaleIn 0.4s ease; }
        .total-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #dee2e6; transition: all 0.2s ease; }
        .grand-total { font-size: 1.8rem; color: var(--primary); }
        .due-amount { color: var(--danger); font-size: 2rem; font-weight: 700; }
        .submit-btn { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; border: none; padding: 20px; border-radius: 24px; font-size: 1.3rem; font-weight: 700; width: 100%; display: flex; align-items: center; justify-content: center; gap: 15px; cursor: pointer; box-shadow: var(--shadow-lg); margin-top: 25px; transition: all 0.3s ease; position: relative; overflow: hidden; }

        /* --- প্রোফাইল সেকশন (আপনার বিদ্যমান স্টাইল) --- */
        .profile-header { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; border-radius: 32px; padding: 28px 22px; margin: 0 20px 20px; box-shadow: var(--shadow-lg); position: relative; overflow: hidden; animation: slideDown 0.4s ease; }
        .header-nav { display: flex; justify-content: space-between; margin-bottom: 25px; position: relative; z-index: 2; }
        .nav-btn { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; width: 48px; height: 48px; border-radius: 18px; display: flex; align-items: center; justify-content: center; font-size: 1.3rem; cursor: pointer; backdrop-filter: blur(10px); transition: all 0.2s ease; }
        .patient-name { font-size: 2.2rem; font-weight: 700; margin-bottom: 20px; line-height: 1.3; position: relative; z-index: 2; text-shadow: 2px 2px 4px rgba(0,0,0,0.2); }
        .info-grid { display: flex; flex-direction: column; gap: 15px; position: relative; z-index: 2; }
        .info-item { display: flex; align-items: center; gap: 14px; font-size: 1rem; opacity: 0.95; padding: 8px 12px; background: rgba(255,255,255,0.1); border-radius: 16px; backdrop-filter: blur(5px); }
        .patient-switcher { background: rgba(0,0,0,0.2); border-radius: 24px; padding: 14px 20px; margin-top: 25px; display: flex; justify-content: space-between; align-items: center; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); position: relative; z-index: 2; }
        .switch-btn { background: white; border: none; padding: 10px 22px; border-radius: 40px; color: var(--primary); font-weight: 600; cursor: pointer; transition: all 0.2s ease; }
        .profile-stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin: 20px; }
        .profile-stat { background: white; border-radius: 24px; padding: 20px; box-shadow: var(--shadow-md); text-align: center; transition: all 0.3s ease; animation: scaleIn 0.4s ease; border-bottom: 4px solid transparent; }
        .profile-stat.primary { border-bottom-color: var(--primary); }
        .profile-stat.success { border-bottom-color: var(--success); }
        .profile-stat.danger { border-bottom-color: var(--danger); }
        .profile-stat-value { font-size: 2.2rem; font-weight: 700; color: var(--dark); }
        .profile-actions { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin: 20px; }

        /* --- মেসেজ বাটন (আপডেট করা হয়েছে) --- */
        .message-action-btn {
            background: linear-gradient(135deg, var(--info), #2d4b7a);
            color: white;
            border: none;
            border-radius: 30px;
            padding: 18px 24px;
            margin: 0 20px 25px;
            width: calc(100% - 40px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: var(--shadow-md);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        /* --- মোডাল (আপনার বিদ্যমান স্টাইল) --- */
        .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: none; align-items: flex-end; z-index: 2000; backdrop-filter: blur(8px); }
        .modal.active { display: flex; animation: fadeIn 0.3s ease; }
        .modal-content { background: white; width: 100%; border-radius: 40px 40px 0 0; padding: 30px 25px; max-height: 85vh; overflow-y: auto; animation: slideUp 0.4s ease; }
        .modal-title { font-size: 1.7rem; color: var(--primary); margin-bottom: 25px; display: flex; align-items: center; gap: 15px; }

        /* --- মেসেজ মোডাল (আপডেট) --- */
        .message-preview {
            background: #f8fafc;
            border-radius: 16px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid var(--primary);
            font-size: 1rem;
            line-height: 1.6;
            white-space: pre-wrap; /* লাইন ব্রেক রাখার জন্য */
        }

        /* --- বটম নেভিগেশন --- */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; display: flex; justify-content: space-around; padding: 14px 15px; box-shadow: 0 -5px 25px rgba(0,0,0,0.1); border-radius: 35px 35px 0 0; padding-bottom: calc(14px + var(--safe-bottom)); z-index: 1000; }
        .nav-item { display: flex; flex-direction: column; align-items: center; text-decoration: none; color: var(--gray); font-size: 0.85rem; gap: 5px; padding: 10px 12px; border-radius: 20px; transition: all 0.3s ease; flex: 1; cursor: pointer; }
        .nav-item.active { color: var(--primary); background: var(--primary-light); }
        .nav-icon { font-size: 1.6rem; }

        /* --- লোডিং ওভারলে, ইমেজ ভিউয়ার, এম্পটি স্টেট (আপনার বিদ্যমান) --- */
        .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.95); display: none; justify-content: center; align-items: center; z-index: 9999; backdrop-filter: blur(5px); }
        .loading-overlay.active { display: flex; }
        .spinner { width: 60px; height: 60px; border: 5px solid var(--primary-light); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .image-viewer-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.95); display: none; justify-content: center; align-items: center; z-index: 2000; padding: 20px; }
        .image-viewer-modal.active { display: flex; }
        .empty-state { text-align: center; padding: 50px 20px; color: var(--gray); }
        .empty-state i { font-size: 4rem; margin-bottom: 20px; color: var(--light-gray); }

        /* --- রেসপন্সিভ --- */
        @media (max-width: 480px) {
            .action-grid { grid-template-columns: repeat(2, 1fr); }
            .profile-actions { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <!-- লোডিং ওভারলে -->
    <div class="loading-overlay" id="loadingOverlay"><div class="spinner"></div></div>

    <!-- মেসেজ কন্টেইনার -->
    <div id="messageContainer"></div>

    <!-- ইমেজ ভিউয়ার মোডাল -->
    <div class="image-viewer-modal" id="imageViewerModal" onclick="if(event.target===this) this.classList.remove('active')">
        <div class="image-viewer-content">
            <button class="close-viewer" onclick="document.getElementById('imageViewerModal').classList.remove('active')"><i class="fas fa-times"></i></button>
            <img id="viewerImage" src="" alt="">
        </div>
    </div>

    <!-- মোবাইল হেডার -->
    <header class="mobile-header">
        <div class="header-top">
            <div>
                <div class="clinic-name">চৌধুরী ডেন্টাল</div>
                <div class="clinic-sub"><i class="fas fa-tooth"></i><span>সম্পূর্ণ ব্যবস্থাপনা</span></div>
            </div>
            <button class="menu-btn" id="logoutBtn"><i class="fas fa-sign-out-alt"></i></button>
        </div>
    </header>

    <!-- সার্চ বার (নতুন) -->
    <div class="search-container">
        <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="searchPhoneInput" placeholder="মোবাইল নাম্বার দিয়ে খুঁজুন (যেমন: 01XXXXXXXXX)" inputmode="numeric">
            <button id="searchBtn"><i class="fas fa-arrow-right"></i></button>
        </div>
    </div>

    <!-- স্ট্যাটস কার্ড -->
    <div class="stats-grid" id="homeStats">
        <div class="stat-card" onclick="document.querySelector('[data-section=\"home\"]').click()">
            <div class="stat-icon"><i class="fas fa-users"></i></div>
            <div class="stat-info"><h3>মোট রোগী</h3><div class="stat-number" id="totalPatients">0</div></div>
        </div>
        <div class="stat-card danger" onclick="document.querySelector('[data-section=\"home\"]').click()">
            <div class="stat-icon"><i class="fas fa-exclamation-triangle"></i></div>
            <div class="stat-info"><h3>মোট বকেয়া</h3><div class="stat-number" id="totalDue">৳ 0</div></div>
        </div>
    </div>

    <!-- অ্যাকশন বাটন (প্রোফাইল বাটন সরিয়ে সার্চের সাথে রিপ্লেস করা হয়েছে) -->
    <div class="action-grid">
        <div class="action-card" id="newPatientBtn"><div class="action-icon"><i class="fas fa-user-plus"></i></div><div class="action-title">রোগী এড</div><div class="action-desc">নতুন এন্ট্রি</div></div>
        <div class="action-card" id="patientHistoryBtn"><div class="action-icon"><i class="fas fa-history"></i></div><div class="action-title">হিস্ট্রি</div><div class="action-desc">আগের চিকিৎসা</div></div>
        <div class="action-card" id="phoneNumbersBtn"><div class="action-icon"><i class="fas fa-phone"></i></div><div class="action-title">নাম্বার লিস্ট</div><div class="action-desc">সকল নাম্বার</div></div>
        <!-- "প্রোফাইল দেখুন" বাটনটি সরিয়ে দেওয়া হয়েছে -->
    </div>

    <!-- হোম সেকশন -->
    <div id="homeSection">
        <div class="section-card" id="recentSection">
            <div class="section-title"><i class="fas fa-history"></i><span>সর্বশেষ রোগী</span></div>
            <div class="recent-list" id="recentPatientsList"><div class="empty-state"><i class="fas fa-spinner fa-spin fa-3x"></i><p>লোড হচ্ছে...</p></div></div>
        </div>
    </div>

    <!-- নতুন রোগী ফর্ম সেকশন -->
    <div class="section-card" id="newPatientSection" style="display: none;">
        <div class="section-title"><i class="fas fa-user-plus"></i><span>নতুন রোগী এন্ট্রি</span></div>
        <form id="patientForm">
            <input type="hidden" id="editPatientId" value="">
            <input type="hidden" id="fromProfileId" value="">
            
            <div class="form-group"><label class="form-label">রোগীর নাম *</label><input type="text" id="patientName" class="form-control" placeholder="যেমন: মোঃ রফিকুল ইসলাম" required></div>

            <div class="form-row">
                <div class="form-group"><label class="form-label">বয়স</label><input type="number" id="patientAge" class="form-control" placeholder="বয়স" min="0" max="120"></div>
                <div class="form-group"><label class="form-label">লিঙ্গ</label><div class="gender-group"><label><input type="radio" name="gender" value="পুরুষ"> পুরুষ</label><label><input type="radio" name="gender" value="মহিলা"> মহিলা</label></div></div>
            </div>

            <div class="form-group"><label class="form-label">মোবাইল নাম্বার *</label><input type="tel" id="patientPhone" class="form-control" placeholder="01XXXXXXXXX" required></div>
            <div class="form-group"><label class="form-label">ঠিকানা</label><input type="text" id="patientAddress" class="form-control" placeholder="বিস্তারিত ঠিকানা"></div>

            <!-- একাধিক সমস্যা সেকশন -->
            <div class="problem-container" id="problemsContainer">
                <div class="problem-item" id="problemTemplate">
                    <div class="problem-header"><span class="problem-badge">চিকিৎসা #১</span><button type="button" class="remove-problem" style="display: none;"><i class="fas fa-times"></i></button></div>
                    
                    <div class="form-group">
                        <label class="form-label">চিকিৎসার ধরন *</label>
                        <select class="form-control problem-type" required>
                            <option value="">নির্বাচন করুন</option>
                            <option value="রুট ক্যানাল">রুট ক্যানাল</option>
                            <option value="দাঁত তোলা">দাঁত তোলা</option>
                            <option value="লাইট কিউর ফিলিং">লাইট কিউর ফিলিং</option>
                            <option value="স্কেলিং ও পলিশিং">স্কেলিং ও পলিশিং</option>
                            <option value="ডেন্টাল ক্রাউন">ডেন্টাল ক্রাউন</option>
                            <option value="অন্যান্য">অন্যান্য</option>
                        </select>
                    </div>

                    <!-- ক্রাউন অপশন -->
                    <div class="crown-options crown-section">
                        <div class="form-group"><label class="form-label">ক্রাউনের ধরন</label><select class="form-control crown-type"><option value="পোর্সেলিন">পোর্সেলিন ক্রাউন</option><option value="জিরকোনিয়া">জিরকোনিয়া</option><option value="মেটাল">মেটাল</option></select></div>
                        <label class="form-label">শেড</label>
                        <div class="shade-grid">
                            <div class="shade-item active" data-shade="A2">A2</div>
                            <div class="shade-item" data-shade="A3">A3</div>
                            <div class="shade-item" data-shade="B1">B1</div>
                            <div class="shade-item" data-shade="B2">B2</div>
                        </div>
                        <input type="hidden" class="crown-shade" value="A2">

                        <div class="form-row">
                            <div class="form-group"><label class="form-label">কয়টি</label><input type="number" class="form-control crown-qty" min="1" value="1"></div>
                            <div class="form-group"><label class="form-label">প্রতি দাম (৳)</label><input type="number" class="form-control crown-price" min="0" placeholder="মূল্য"></div>
                        </div>
                    </div>

                    <div class="form-group"><label class="form-label">বিস্তারিত</label><textarea class="form-control problem-desc" rows="2" placeholder="বিশেষ তথ্য (যদি থাকে)"></textarea></div>
                    <!-- আপডেট: placeholder যোগ করা হয়েছে, value="0" সরানো হয়েছে -->
                    <div class="form-group"><label class="form-label">মোট খরচ (৳) *</label><input type="number" class="form-control problem-cost" min="0" placeholder="যেমন: ৫০০০" required></div>

                    <div class="form-row">
                        <div class="form-group"><label class="form-label">ডিসকাউন্ট (%)</label><input type="number" class="form-control discount-percent" min="0" max="100" placeholder="শতাংশ"></div>
                        <div class="form-group"><label class="form-label">ডিসকাউন্ট (৳)</label><input type="number" class="form-control discount-amount" min="0" placeholder="টাকায়"></div>
                    </div>

                    <div class="form-group"><label class="form-label">আজকের জমা (৳)</label><input type="number" class="form-control problem-paid" min="0" placeholder="জমার পরিমাণ"></div>
                </div>
            </div>

            <button type="button" class="add-problem-btn" id="addProblemBtn" style="background: var(--primary-light); border: 2px dashed var(--primary); border-radius: 18px; padding: 16px; width: 100%; color: var(--primary); font-weight: 600; cursor: pointer; margin-bottom: 20px; transition: all 0.3s ease;"><i class="fas fa-plus-circle"></i> আরেকটি সমস্যা যোগ করুন</button>

            <div class="image-upload-area" id="imageUploadArea"><i class="fas fa-cloud-upload-alt"></i><p>প্রেসক্রিপশনের ছবি আপলোড করুন</p><input type="file" id="prescriptionImages" accept="image/*" multiple style="display: none;"></div>
            <div class="image-preview" id="imagePreview"></div>
            <input type="hidden" id="uploadedImages" value="">

            <!-- টোটাল সেকশন -->
            <div class="total-section">
                <div class="total-row"><span class="total-label">মোট বিল</span><span class="total-amount" id="totalBillAmount">৳ 0</span></div>
                <div class="total-row"><span class="total-label">মোট ডিসকাউন্ট</span><span class="total-amount" id="totalDiscount">৳ 0</span></div>
                <div class="total-row"><span class="total-label">নেট বিল</span><span class="total-amount grand-total" id="netBill">৳ 0</span></div>
                <div class="total-row"><span class="total-label">মোট জমা</span><span class="total-amount" id="totalPaid">৳ 0</span></div>
                <div class="total-row"><span class="total-label">বাকি</span><span class="due-amount" id="totalDueAmount">৳ 0</span></div>
            </div>

            <button type="submit" class="submit-btn" id="submitBtn"><i class="fas fa-save"></i> সংরক্ষণ করুন</button>
        </form>
    </div>

    <!-- প্রোফাইল সেকশন -->
    <div id="profileSection" style="display: none;">
        <div class="profile-header">
            <div class="header-nav">
                <button class="nav-btn" id="backFromProfile"><i class="fas fa-arrow-left"></i></button>
                <button class="nav-btn" id="homeFromProfile"><i class="fas fa-home"></i></button>
            </div>
            <h1 class="patient-name" id="profilePatientName">—</h1>
            <div class="info-grid">
                <div class="info-item"><i class="fas fa-phone-alt"></i> <span id="profilePatientPhone">মোবাইল: —</span></div>
                <div class="info-item"><i class="fas fa-map-marker-alt"></i> <span id="profilePatientAddress">ঠিকানা: —</span></div>
                <div class="info-item"><i class="fas fa-calendar-alt"></i> <span id="profilePatientAge">বয়স: —</span></div>
            </div>
            <div class="patient-switcher" id="patientSwitcher" style="display: none;"><div><i class="fas fa-users"></i> <span id="patientCount">১/১</span></div><button class="switch-btn" id="switchPatientBtn">পরিবর্তন</button></div>
        </div>

        <div class="profile-stats">
            <div class="profile-stat primary"><div class="profile-stat-value" id="profileTotalBill">৳০</div><div class="profile-stat-label">মোট বিল</div></div>
            <div class="profile-stat success"><div class="profile-stat-value" id="profileTotalPaid">৳০</div><div class="profile-stat-label">জমা</div></div>
            <div class="profile-stat danger"><div class="profile-stat-value" id="profileTotalDue">৳০</div><div class="profile-stat-label">বকেয়া</div></div>
            <div class="profile-stat primary"><div class="profile-stat-value" id="profileTotalTreatments">০</div><div class="profile-stat-label">চিকিৎসা</div></div>
        </div>

        <div class="profile-actions">
            <button class="profile-action" id="profileAddPayment"><i class="fas fa-coins"></i><span>টাকা জমা</span></button>
            <button class="profile-action" id="profileAddTreatment"><i class="fas fa-tooth"></i><span>নতুন চিকিৎসা</span></button>
            <button class="profile-action" id="profileEditPatient"><i class="fas fa-user-edit"></i><span>সম্পাদনা</span></button>
            <button class="profile-action" id="profileDiscountBtn"><i class="fas fa-percentage"></i><span>ডিসকাউন্ট</span></button>
        </div>

        <!-- মেসেজ বাটন (আপডেট করা হয়েছে) -->
        <button class="message-action-btn" id="openMessageModalBtn">
            <span><i class="fas fa-comment-dots"></i> মেসেজ পাঠান</span>
            <i class="fas fa-chevron-right"></i>
        </button>

        <!-- অন্যান্য প্রোফাইল এলিমেন্ট (গ্যালারি, প্রেসক্রিপশন, হিস্ট্রি) -->
        <div class="image-gallery-section"><div class="section-header"><h3><i class="fas fa-images"></i> প্রেসক্রিপশনের ছবি</h3><span class="treatment-count" id="imageCount">০ টি</span></div><div id="imageGallery" class="image-gallery"><div class="empty-state"><i class="fas fa-images"></i><p>কোনো ছবি নেই</p></div></div></div>
        <div class="prescription-section"><div class="section-header"><h3><i class="fas fa-prescription"></i> সর্বশেষ প্রেসক্রিপশন</h3></div><div class="prescription-card" id="prescriptionCard"></div></div>
        <div class="history-section"><div class="section-header"><h3><i class="fas fa-notes-medical"></i> চিকিৎসার ইতিহাস</h3><span class="treatment-count" id="historyCount">০ টি</span></div><div class="filter-tabs"><button class="filter-tab active" data-filter="all">সকল</button><button class="filter-tab" data-filter="due">বকেয়া</button><button class="filter-tab" data-filter="paid">পরিশোধিত</button></div><div class="history-list" id="treatmentHistory"><div class="empty-state"><i class="fas fa-spinner fa-spin fa-3x"></i><p>লোড হচ্ছে...</p></div></div></div>
    </div>

    <!-- মোডালগুলি -->
    <div class="modal" id="paymentModal"><div class="modal-content"><h2 class="modal-title"><i class="fas fa-hand-holding-usd"></i> টাকা জমা দিন</h2><form id="paymentForm"><div class="form-group"><label>পরিমাণ (৳)</label><input type="number" id="paymentAmount" class="form-control" min="1" required></div><div class="form-group"><label>মন্তব্য</label><textarea id="paymentNotes" class="form-control" rows="3" placeholder="ঐচ্ছিক"></textarea></div><div style="display: flex; gap: 12px;"><button type="submit" class="submit-btn" style="flex: 2; padding: 16px;">জমা দিন</button><button type="button" class="submit-btn" style="flex: 1; background: var(--danger);" onclick="closeModal('paymentModal')">বাতিল</button></div></form></div></div>
    <div class="modal" id="discountModal"><div class="modal-content"><h2 class="modal-title"><i class="fas fa-percentage"></i> ডিসকাউন্ট দিন</h2><form id="discountForm"><div class="form-group"><label>চিকিৎসা নির্বাচন</label><select id="treatmentSelect" class="form-control" required><option value="">নির্বাচন করুন</option></select></div><div class="form-group"><label>পরিমাণ (৳)</label><input type="number" id="discountAmount" class="form-control" min="1" required></div><div style="display: flex; gap: 12px;"><button type="submit" class="submit-btn" style="flex: 2; padding: 16px;">প্রয়োগ করুন</button><button type="button" class="submit-btn" style="flex: 1; background: var(--danger);" onclick="closeModal('discountModal')">বাতিল</button></div></form></div></div>
    
    <!-- মেসেজ মোডাল (আপডেট) -->
    <div class="modal" id="messageModal">
        <div class="modal-content">
            <h2 class="modal-title"><i class="fas fa-comment-dots"></i> মেসেজ পাঠান</h2>
            
            <!-- প্রিভিউ সেকশন (এখন এখানে রোগীর নাম ও বয়স স্বয়ংক্রিয়ভাবে বসবে) -->
            <div class="message-preview" id="messagePreview">
                <div id="previewText">রোগীর নাম ও বয়স এখানে দেখাবে...</div>
            </div>

            <!-- শুধুমাত্র কাস্টম মেসেজ ফিল্ড -->
            <div class="form-group">
                <label>আপনার মেসেজ লিখুন</label>
                <textarea id="customMessage" class="form-control" rows="6" placeholder="আপনার মেসেজ এখানে লিখুন..."></textarea>
            </div>

            <div style="display: flex; gap: 12px;">
                <button class="submit-btn" id="sendMessageBtn" style="flex: 2;"><i class="fas fa-paper-plane"></i> হোয়াটসঅ্যাপে পাঠান</button>
                <button class="submit-btn" style="flex: 1; background: var(--danger);" onclick="closeModal('messageModal')">বাতিল</button>
            </div>
        </div>
    </div>

    <div class="modal" id="historyModal"><div class="modal-content"><h2 class="modal-title"><i class="fas fa-history"></i><span>চিকিৎসার ইতিহাস</span></h2><input type="text" class="form-control" id="searchHistory" placeholder="খুঁজুন..." style="margin-bottom: 20px;"><div class="patient-list" id="historyList"></div></div></div>
    <div class="modal" id="numbersModal"><div class="modal-content"><h2 class="modal-title"><i class="fas fa-phone"></i><span>সকল ফোন নাম্বার</span></h2><button class="submit-btn" id="copyAllNumbers" style="margin-bottom: 20px; background: var(--info);"><i class="fas fa-copy"></i> সব কপি করুন</button><div class="patient-list" id="numbersList"></div></div></div>

    <!-- FAB মেনু (আপনার বিদ্যমান) -->
    <div class="fab-menu" id="fabMenu"><button class="fab-btn" id="fabProfileBtn"><i class="fas fa-user"></i></button><div class="fab-label" id="fabLabel">সর্বশেষ রোগী</div></div>

    <!-- নিচের নেভিগেশন -->
    <nav class="bottom-nav">
        <a class="nav-item active" data-section="home"><i class="fas fa-home nav-icon"></i><span>হোম</span></a>
        <a class="nav-item" data-section="new"><i class="fas fa-user-plus nav-icon"></i><span>নতুন</span></a>
        <a class="nav-item" data-section="profile"><i class="fas fa-user-md nav-icon"></i><span>প্রোফাইল</span></a>
        <a class="nav-item" data-section="numbers"><i class="fas fa-phone nav-icon"></i><span>নাম্বার</span></a>
    </nav>

    <script>
        // Firebase Config (আপনার প্রদত্ত)
        const firebaseConfig = {
            apiKey: "AIzaSyAxz46ug-CAywevI-PzmOp7ba5iiCK9dfM",
            authDomain: "plasma-raceway-465016-v0.firebaseapp.com",
            projectId: "plasma-raceway-465016-v0",
            storageBucket: "plasma-raceway-465016-v0.firebasestorage.app",
            messagingSenderId: "23620370976",
            appId: "1:23620370976:web:3bb119ceb9e15608a33245"
        };

        const CLOUDINARY_CONFIG = { cloudName: 'dsdca3db1', uploadPreset: 'Dental' };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Global Variables
        let uploadedImageUrls = [];
        let problemCount = 1;
        let currentPatient = null;
        let allPatientsWithSamePhone = [];
        let currentPatientIndex = 0;
        let allTreatments = [];
        let currentFilter = 'all';

        // Utility Functions
        function showLoading() { document.getElementById('loadingOverlay').classList.add('active'); }
        function hideLoading() { document.getElementById('loadingOverlay').classList.remove('active'); }

        function showMessage(msg, type = 'info') {
            const container = document.getElementById('messageContainer');
            const msgDiv = document.createElement('div');
            msgDiv.className = `message-box message-${type}`;
            msgDiv.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i> ${msg}`;
            container.appendChild(msgDiv);
            setTimeout(() => { msgDiv.style.animation = 'fadeOut 0.3s ease'; setTimeout(() => msgDiv.remove(), 300); }, 3000);
        }

        function escapeHtml(unsafe) { /* ... আপনার বিদ্যমান ফাংশন ... */ if (!unsafe) return unsafe; return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); }

        window.closeModal = function(modalId) { document.getElementById(modalId).classList.remove('active'); };

        // মোডালের বাইরে ক্লিক করলে বন্ধ হবে
        document.querySelectorAll('.modal').forEach(modal => { modal.addEventListener('click', function(e) { if (e.target === this) this.classList.remove('active'); }); });

        window.viewImage = function(imageUrl) { document.getElementById('viewerImage').src = imageUrl; document.getElementById('imageViewerModal').classList.add('active'); };

        // --- প্রোফাইল দেখানোর ফাংশন (আপডেট) ---
        window.showProfile = async function(profileId) {
            showLoading();
            try {
                const doc = await db.collection("patients").doc(profileId).get();
                if (doc.exists) {
                    const data = doc.data();
                    currentPatient = { id: doc.id, data: data };
                    
                    // সেকশন পরিবর্তন
                    document.getElementById('homeSection').style.display = 'none';
                    document.getElementById('newPatientSection').style.display = 'none';
                    document.getElementById('profileSection').style.display = 'block';
                    
                    // নেভিগেশন আপডেট
                    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                    document.querySelector('[data-section="profile"]').classList.add('active');
                    
                    // প্রোফাইল ডেটা দেখান
                    displayPatientData(data);
                    
                    // একই ফোন নম্বরের রোগী চেক
                    const phone = data.phone;
                    if (phone) {
                        const q = await db.collection("patients").where("phone", "==", phone).get();
                        allPatientsWithSamePhone = [];
                        q.forEach(d => { allPatientsWithSamePhone.push({ id: d.id, data: d.data() }); });
                        
                        if (allPatientsWithSamePhone.length > 1) {
                            currentPatientIndex = allPatientsWithSamePhone.findIndex(p => p.id === doc.id);
                            document.getElementById('patientSwitcher').style.display = 'flex';
                            document.getElementById('patientCount').textContent = `${currentPatientIndex+1}/${allPatientsWithSamePhone.length}`;
                        } else { document.getElementById('patientSwitcher').style.display = 'none'; }
                    }
                } else { showMessage('রোগী পাওয়া যায়নি', 'error'); }
            } catch (err) { console.error('Profile error:', err); showMessage('প্রোফাইল লোড করতে সমস্যা', 'error'); } finally { hideLoading(); }
        };

        // --- সার্চ ফাংশন (নতুন) ---
        async function searchPatientByPhone(phone) {
            if (!phone || phone.length < 11) { // মোটামুটি ১১ ডিজিটের ভ্যালিডেশন
                showMessage(' সঠিক ১১ ডিজিটের মোবাইল নাম্বার দিন', 'warning');
                return;
            }
            showLoading();
            try {
                // ঠিক ফোন নাম্বার ম্যাচ করার জন্য কোয়েরি
                const snapshot = await db.collection("patients").where("phone", "==", phone).get();
                if (snapshot.empty) {
                    showMessage('এই নাম্বারের কোনো রোগী পাওয়া যায়নি', 'info');
                } else {
                    // প্রথম ম্যাচ পাওয়া রোগীর প্রোফাইল দেখাও
                    const firstDoc = snapshot.docs[0];
                    showProfile(firstDoc.id);
                }
            } catch (err) {
                console.error('Search error:', err);
                showMessage('সার্চ করতে সমস্যা', 'error');
            } finally {
                hideLoading();
            }
        }

        // --- Cloudinary Upload, Image Handler, Problem Handlers (আপনার বিদ্যমান, অপরিবর্তিত) ---
        async function uploadToCloudinary(file) { /* ... */ }
        document.getElementById('imageUploadArea')?.addEventListener('click', () => { document.getElementById('prescriptionImages').click(); });
        document.getElementById('prescriptionImages')?.addEventListener('change', async function(e) { /* ... */ });

        function toggleCrownOptions(problemItem, show) { /* ... */ }
        function handleProblemTypeChange(e) { /* ... */ }
        function discountInputHandler(e) { /* ... */ }
        function attachShadeListeners(container) { /* ... */ }
        function calculateTotals() { /* ... */ }

        // Add Problem Button
        document.getElementById('addProblemBtn')?.addEventListener('click', () => {
            const template = document.getElementById('problemTemplate');
            const clone = template.cloneNode(true);
            problemCount++;
            clone.id = '';
            clone.querySelector('.problem-badge').textContent = `চিকিৎসা #${problemCount}`;
            // সব ফিল্ড রিসেট (value="" করে দেওয়া)
            clone.querySelectorAll('input, select, textarea').forEach(el => { if (el.type !== 'hidden') { if (el.type === 'checkbox') el.checked = false; else el.value = ''; } });
            // ডিফল্ট ভ্যালু সেট (শুধু প্রয়োজনীয়)
            clone.querySelector('.crown-qty').value = '1';
            clone.querySelector('.crown-price').value = '';
            clone.querySelector('.problem-cost').value = '';
            clone.querySelector('.discount-percent').value = '';
            clone.querySelector('.discount-amount').value = '';
            clone.querySelector('.problem-paid').value = '';
            clone.querySelector('.crown-options').classList.remove('active');
            
            const removeBtn = clone.querySelector('.remove-problem');
            removeBtn.style.display = 'flex';
            attachShadeListeners(clone);
            clone.querySelector('.problem-type').addEventListener('change', handleProblemTypeChange);
            clone.querySelector('.discount-percent').addEventListener('input', discountInputHandler);
            clone.querySelector('.discount-amount').addEventListener('input', discountInputHandler);
            clone.querySelectorAll('.problem-cost, .problem-paid, .crown-qty, .crown-price').forEach(el => { el.addEventListener('input', calculateTotals); });
            removeBtn.addEventListener('click', function() { clone.remove(); calculateTotals(); problemCount = document.querySelectorAll('.problem-item').length; const firstRemoveBtn = document.querySelector('#problemsContainer .problem-item:first-child .remove-problem'); if (firstRemoveBtn) firstRemoveBtn.style.display = 'none'; });
            document.getElementById('problemsContainer').appendChild(clone);
            calculateTotals();
        });

        // ফর্ম সাবমিট (আপনার বিদ্যমান, কিন্তু ইনপুট ফিল্ডে value="" সেট করা আছে, তাই সাবমিটে NaN এড়াতে parseFloat-এর আগে || 0 ব্যবহার করুন)
        document.getElementById('patientForm')?.addEventListener('submit', async (e) => { /* ... আপনার বিদ্যমান কোড ... তবে নিশ্চিত করুন parseFloat-এর আগে || 0 ব্যবহার করছেন। যেমন: const cost = parseFloat(p.querySelector('.problem-cost')?.value) || 0; */ });

        // ড্যাশবোর্ড ও রিসেন্ট লোড (আপনার বিদ্যমান)
        async function loadDashboardStats() { /* ... */ }
        function animateNumber(elementId, start, end, duration, prefix = '') { /* ... */ }
        async function loadRecentPatients() { /* ... */ }
        async function openHistoryModal() { /* ... */ }
        async function openNumbersModal() { /* ... */ }

        // প্রোফাইল ডেটা ডিসপ্লে (আপডেট করা হয়েছে, মেসেজের জন্য ডিফল্ট টেক্সট তৈরি এখানে)
        function displayPatientData(data) {
            if (!data) return;
            
            document.getElementById('profilePatientName').textContent = escapeHtml(data.name) || '—';
            document.getElementById('profilePatientPhone').textContent = `মোবাইল: ${escapeHtml(data.phone) || '—'}`;
            document.getElementById('profilePatientAddress').textContent = `ঠিকানা: ${escapeHtml(data.address) || '—'}`;
            document.getElementById('profilePatientAge').textContent = `বয়স: ${escapeHtml(data.age) || '—'} বছর`;
            
            // ... বাকি হিসাবনিকাশ আপনার বিদ্যমান ...
            let totalBill = 0, totalPaid = 0, totalDue = 0;
            allTreatments = (data.treatments || []).map((t, index) => { /* ... */ }).reverse();
            // ... স্ট্যাট আপডেট ...

            // মেসেজের জন্য ডিফল্ট টেক্সট তৈরি করে রাখা (পরবর্তীতে মডাল খোলার সময় ব্যবহার হবে)
            // এখানে কিছু করার দরকার নেই, কারণ মডাল খোলার সময় তৈরি হবে।
        }

        // --- মেসেজ মোডাল খোলার ফাংশন (আপডেট) ---
        document.getElementById('openMessageModalBtn').addEventListener('click', () => {
            if (!currentPatient) {
                showMessage('কোনো রোগী নির্বাচন করা হয়নি', 'warning');
                return;
            }
            
            const modal = document.getElementById('messageModal');
            const previewDiv = document.getElementById('previewText');
            const customMessageArea = document.getElementById('customMessage');
            
            // রোগীর তথ্য থেকে নাম ও বয়স বের করা
            const patientName = currentPatient.data.name || 'রোগী';
            const patientAge = currentPatient.data.age ? `${currentPatient.data.age} বছর` : 'বয়স উল্লেখ নেই';
            
            // ডিফল্ট মেসেজ তৈরি (শুধু নাম ও বয়স)
            const defaultMessage = `${patientName}\n${patientAge}`;
            
            // প্রিভিউতে দেখানো এবং কাস্টম এরিয়াতে বসানো
            previewDiv.innerText = defaultMessage;
            customMessageArea.value = defaultMessage; // কাস্টম এরিয়াতেও ডিফল্ট বসবে, যা ইউজার এডিট করতে পারবেন
            
            modal.classList.add('active');
        });

        // --- মেসেজ পাঠানোর ফাংশন (আপডেট) ---
        document.getElementById('sendMessageBtn').addEventListener('click', async () => {
            if (!currentPatient) {
                showMessage('রোগী নির্বাচন করুন', 'warning');
                return;
            }
            
            // কাস্টম এরিয়া থেকে মেসেজ নেওয়া (যেখানে ইউজার যা ইচ্ছে লিখতে পারেন)
            const messageToSend = document.getElementById('customMessage').value.trim();
            
            if (!messageToSend) {
                showMessage('মেসেজ লিখুন', 'warning');
                return;
            }
            
            const phone = currentPatient.data.phone;
            if (!phone || phone === '—') {
                showMessage('মোবাইল নম্বর নেই', 'error');
                return;
            }
            
            const cleanPhone = phone.replace(/\D/g, '');
            const url = `https://wa.me/${cleanPhone}?text=${encodeURIComponent(messageToSend)}`;
            
            window.open(url, '_blank');
            closeModal('messageModal');
        });

        // --- নেভিগেশন ও বাটন ইভেন্ট (আপডেট) ---
        // হিস্ট্রি মডাল থেকে প্রোফাইল ওপেন করার সময় মডাল বন্ধ হবে
        window.showProfile = async function(profileId) {
            // ... উপরের showProfile ফাংশন ...
            // (এটি ইতিমধ্যে আপডেট করা আছে। এটিকে আবার পুরোটা এখানে না লিখে, 
            // আমরা নিশ্চিত করছি যে এটি কল হলে মডাল বন্ধ হয়ে যাবে। 
            // নিচের লাইনটি showProfile-এর ভেতরে যোগ করতে হবে, কিন্তু আমরা ইতিমধ্যে উপরে showProfile আপডেট করেছি।
            // তাই শুধু নিশ্চিত করার জন্য নিচের লাইনটি showProfile-এর শুরুতে যোগ করুন:)
            // closeModal('historyModal'); // এই লাইনটি showProfile ফাংশনের শুরুতে যোগ করুন (যেমন উপরে আমরা আপডেট করেছি)
        }

        // উপরের showProfile-এ আমরা এটি যোগ করিনি। তাই এখানে একটি ছোট মডিফিকেশন দরকার।
        // চলুন showProfile ফাংশনটি আবার এখানে সম্পূর্ণ আপডেট করে দিচ্ছি (সংক্ষেপে) এবং এতে closeModal যোগ করছি।

        // নিচের window.showProfile = async function(profileId) { ... } পুরোটা রিপ্লেস করুন এই আপডেট ভার্সন দিয়ে:

        window.showProfile = async function(profileId) {
            // ** নতুন লাইন: যেকোনো খোলা মডাল বন্ধ করো **
            closeModal('historyModal');
            closeModal('numbersModal');
            // *************************

            showLoading();
            try {
                const doc = await db.collection("patients").doc(profileId).get();
                if (doc.exists) {
                    const data = doc.data();
                    currentPatient = { id: doc.id, data: data };
                    
                    document.getElementById('homeSection').style.display = 'none';
                    document.getElementById('newPatientSection').style.display = 'none';
                    document.getElementById('profileSection').style.display = 'block';
                    
                    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                    document.querySelector('[data-section="profile"]').classList.add('active');
                    
                    displayPatientData(data);
                    
                    const phone = data.phone;
                    if (phone) {
                        const q = await db.collection("patients").where("phone", "==", phone).get();
                        allPatientsWithSamePhone = [];
                        q.forEach(d => { allPatientsWithSamePhone.push({ id: d.id, data: d.data() }); });
                        
                        if (allPatientsWithSamePhone.length > 1) {
                            currentPatientIndex = allPatientsWithSamePhone.findIndex(p => p.id === doc.id);
                            document.getElementById('patientSwitcher').style.display = 'flex';
                            document.getElementById('patientCount').textContent = `${currentPatientIndex+1}/${allPatientsWithSamePhone.length}`;
                        } else { document.getElementById('patientSwitcher').style.display = 'none'; }
                    }
                } else { showMessage('রোগী পাওয়া যায়নি', 'error'); }
            } catch (err) { console.error('Profile error:', err); showMessage('প্রোফাইল লোড করতে সমস্যা', 'error'); } finally { hideLoading(); }
        };


        // অন্যান্য ইভেন্ট লিসেনার (আপনার বিদ্যমান)
        document.querySelectorAll('.nav-item').forEach(item => { /* ... */ });
        document.getElementById('newPatientBtn').addEventListener('click', () => { document.querySelector('[data-section="new"]').click(); });
        document.getElementById('patientHistoryBtn').addEventListener('click', openHistoryModal);
        document.getElementById('phoneNumbersBtn').addEventListener('click', openNumbersModal);
        document.getElementById('backFromProfile').addEventListener('click', () => { document.querySelector('[data-section="home"]').click(); });
        document.getElementById('homeFromProfile').addEventListener('click', () => { document.querySelector('[data-section="home"]').click(); });
        document.getElementById('switchPatientBtn').addEventListener('click', () => { /* ... */ });
        document.getElementById('profileAddPayment').addEventListener('click', () => { /* ... */ });
        document.getElementById('profileAddTreatment').addEventListener('click', () => { /* ... */ });
        document.getElementById('profileEditPatient').addEventListener('click', () => { /* ... */ });
        document.getElementById('profileDiscountBtn').addEventListener('click', () => { /* ... */ });
        document.getElementById('paymentForm').addEventListener('submit', async (e) => { /* ... */ });
        document.getElementById('discountForm').addEventListener('submit', async (e) => { /* ... */ });
        document.querySelectorAll('.filter-tab').forEach(tab => { /* ... */ });
        document.getElementById('logoutBtn').addEventListener('click', async () => { /* ... */ });

        // সার্চ বাটন ইভেন্ট (নতুন)
        document.getElementById('searchBtn').addEventListener('click', () => {
            const phone = document.getElementById('searchPhoneInput').value.trim();
            searchPatientByPhone(phone);
        });
        // এন্টার চাপলেও সার্চ হবে
        document.getElementById('searchPhoneInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const phone = e.target.value.trim();
                searchPatientByPhone(phone);
            }
        });

        // অটো লগইন ও ডাটা লোড
        auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
            .then(() => {
                auth.onAuthStateChanged((user) => {
                    if (!user) { window.location.href = "log.html"; } 
                    else {
                        console.log('User logged in:', user.email);
                        loadDashboardStats();
                        loadRecentPatients();
                        // checkUrlParams(); // আপনার যদি থাকে
                    }
                });
            })
            .catch((error) => { console.error('Persistence error:', error); });
    </script>
</body>
</html>
