<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes, viewport-fit=cover">
    <title>চৌধুরী ডেন্টাল - সম্পূর্ণ সিস্টেম</title>
    
    <!-- Fonts and Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+Bengali:wght@400;500;600;700&family=Hind+Siliguri:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <!-- এইটুকুই যথেষ্ট PWA চালু করতে -->
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#064635">



    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Hind Siliguri', 'Noto Serif Bengali', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary: #0a5c4b;
            --primary-dark: #064635;
            --primary-light: #e0f2e9;
            --success: #1e7e34;
            --success-dark: #146b2a;
            --success-light: #e8f5e9;
            --danger: #b22234;
            --danger-light: #ffebee;
            --warning: #bf8c2b;
            --warning-light: #fff8e1;
            --gray: #5a6b7a;
            --light-gray: #e9ecef;
            --dark: #2d3e50;
            --border-radius: 20px;
            --box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }

        body {
            background: #f4f7fb;
            min-height: 100vh;
            padding-bottom: 85px;
            padding-top: var(--safe-top);
        }

        /* মোবাইল হেডার */
        .mobile-header {
            background: linear-gradient(145deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 22px 20px;
            border-radius: 0 0 28px 28px;
            box-shadow: 0 10px 20px rgba(6, 70, 53, 0.15);
            position: sticky;
            top: 0;
            z-index: 100;
            padding-top: calc(22px + var(--safe-top));
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .clinic-name {
            font-size: 1.8rem;
            font-weight: 700;
            font-family: 'Noto Serif Bengali', serif;
            line-height: 1.2;
        }

        .clinic-sub {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-top: 4px;
        }

        .menu-btn {
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            width: 48px;
            height: 48px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            cursor: pointer;
            backdrop-filter: blur(10px);
        }

        .menu-btn:active {
            transform: scale(0.92);
            background: rgba(255,255,255,0.25);
        }

        /* স্ট্যাটস গ্রিড */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            padding: 20px;
            margin-top: -15px;
        }

        .stat-card {
            background: white;
            padding: 20px 15px;
            border-radius: 20px;
            box-shadow: var(--box-shadow);
            display: flex;
            align-items: center;
            gap: 15px;
            border-bottom: 4px solid var(--primary);
        }

        .stat-card.success { border-bottom-color: var(--success); }
        .stat-card.danger { border-bottom-color: var(--danger); }
        .stat-card.warning { border-bottom-color: var(--warning); }

        .stat-icon {
            width: 50px;
            height: 50px;
            background: var(--primary-light);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            font-size: 1.5rem;
        }

        .stat-info h3 {
            font-size: 0.9rem;
            color: var(--gray);
            font-weight: 500;
        }

        .stat-number {
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--dark);
            line-height: 1.2;
        }

        /* অ্যাকশন গ্রিড */
        .action-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            padding: 0 20px 20px;
        }

        .action-card {
            background: white;
            border-radius: 20px;
            padding: 20px 10px;
            text-align: center;
            box-shadow: var(--box-shadow);
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .action-card:active {
            transform: scale(0.95);
            border-color: var(--primary);
        }

        .action-icon {
            width: 50px;
            height: 50px;
            background: var(--primary-light);
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            color: var(--primary);
            font-size: 1.5rem;
        }

        .action-title {
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 5px;
            font-size: 1rem;
        }

        .action-desc {
            font-size: 0.7rem;
            color: var(--gray);
        }

        /* সেকশন কার্ড */
        .section-card {
            background: white;
            border-radius: 25px;
            padding: 22px;
            margin: 0 20px 25px;
            box-shadow: var(--box-shadow);
        }

        .section-title {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary-dark);
            border-bottom: 2px solid var(--light-gray);
            padding-bottom: 15px;
        }

        /* ফর্ম এলিমেন্টস */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
            font-size: 0.95rem;
        }

        .form-control {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--light-gray);
            border-radius: 16px;
            font-size: 1rem;
            transition: all 0.2s;
            background: white;
        }

        .form-control:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 4px rgba(10, 92, 75, 0.1);
        }

        select.form-control {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23333' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 16px;
        }

        textarea.form-control {
            resize: vertical;
            min-height: 100px;
        }

        .gender-group {
            display: flex;
            gap: 20px;
            align-items: center;
            background: #f8fafc;
            padding: 12px 16px;
            border-radius: 14px;
            border: 2px solid var(--light-gray);
        }

        .gender-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            color: var(--dark);
        }

        .gender-group input[type="radio"] {
            width: 18px;
            height: 18px;
            accent-color: var(--primary);
        }

        /* প্রোবলেম আইটেম */
        .problem-container {
            margin-bottom: 20px;
        }

        .problem-item {
            background: #f8fafc;
            border-radius: 18px;
            padding: 18px;
            margin-bottom: 15px;
            border: 1px solid var(--light-gray);
            position: relative;
        }

        .problem-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .problem-badge {
            background: var(--primary);
            color: white;
            padding: 5px 15px;
            border-radius: 30px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .remove-problem {
            background: none;
            border: none;
            color: var(--danger);
            font-size: 1.2rem;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .remove-problem:active {
            background: #fee;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }

        .crown-checkbox {
            margin: 15px 0 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .crown-checkbox label {
            font-weight: 600;
            color: var(--dark);
        }

        .crown-checkbox input {
            width: 22px;
            height: 22px;
            accent-color: var(--primary);
        }

        .crown-options {
            background: #f8f4ff;
            border-radius: 16px;
            padding: 15px;
            margin-top: 12px;
            display: none;
        }

        .crown-options.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        .shade-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin: 12px 0;
        }

        .shade-item {
            background: white;
            border: 2px solid var(--light-gray);
            border-radius: 12px;
            padding: 10px 5px;
            text-align: center;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
        }

        .shade-item.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .discount-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 15px;
        }

        /* ইমেজ আপলোড */
        .image-upload-area {
            border: 2px dashed var(--primary);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            background: var(--primary-light);
            margin: 20px 0;
            cursor: pointer;
            transition: all 0.3s;
        }

        .image-upload-area:hover {
            background: #d0e8dc;
        }

        .image-upload-area i {
            font-size: 2rem;
            color: var(--primary);
        }

        .image-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .preview-img {
            width: 70px;
            height: 70px;
            object-fit: cover;
            border-radius: 12px;
            border: 2px solid var(--primary);
        }

        .upload-progress {
            width: 100%;
            height: 4px;
            background: #e0e0e0;
            border-radius: 2px;
            margin-top: 10px;
            display: none;
        }

        .upload-progress-bar {
            width: 0%;
            height: 100%;
            background: var(--primary);
            border-radius: 2px;
            transition: width 0.3s;
        }

        /* টোটাল সেকশন */
        .total-section {
            background: linear-gradient(145deg, #f8fafc, #f0f4f8);
            border-radius: 20px;
            padding: 20px;
            margin: 20px 0;
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #dee2e6;
        }

        .total-row:last-child {
            border-bottom: none;
        }

        .total-label {
            font-weight: 600;
            color: var(--gray);
        }

        .total-amount {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--dark);
        }

        .grand-total {
            font-size: 1.6rem;
            color: var(--primary);
        }

        .due-amount {
            color: var(--danger);
        }

        .submit-btn {
            background: linear-gradient(145deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            padding: 20px;
            border-radius: 18px;
            font-size: 1.2rem;
            font-weight: 700;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            cursor: pointer;
            box-shadow: 0 10px 20px rgba(10, 92, 75, 0.25);
            margin-top: 20px;
        }

        .submit-btn:active {
            transform: scale(0.98);
        }

        .submit-btn.loading {
            opacity: 0.7;
            pointer-events: none;
        }

        .submit-btn.loading::after {
            content: '';
            width: 20px;
            height: 20px;
            border: 2px solid white;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        /* রোগী তালিকা */
        .recent-list {
            max-height: 350px;
            overflow-y: auto;
        }

        .recent-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: #f8fafc;
            border-radius: 16px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .recent-item:hover {
            background: var(--primary-light);
        }

        .recent-avatar {
            width: 50px;
            height: 50px;
            background: var(--primary-light);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            font-size: 1.4rem;
            margin-right: 15px;
        }

        .recent-info {
            flex: 1;
        }

        .recent-name {
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 4px;
        }

        .recent-phone {
            color: var(--primary);
            font-size: 0.9rem;
        }

        .recent-date {
            font-size: 0.75rem;
            color: var(--gray);
        }

        /* প্রোফাইল হেডার */
        .profile-header {
            background: linear-gradient(145deg, var(--primary), var(--primary-dark));
            color: white;
            border-radius: 28px;
            padding: 24px 20px;
            margin: 0 20px 20px;
            box-shadow: 0 15px 25px rgba(6, 70, 53, 0.2);
            position: relative;
            overflow: hidden;
        }

        .profile-header::after {
            content: '';
            position: absolute;
            top: -50%;
            right: -20%;
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            border-radius: 50%;
        }

        .patient-name {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 15px;
            line-height: 1.3;
        }

        .info-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1rem;
            opacity: 0.95;
        }

        .info-item i {
            width: 24px;
            text-align: center;
            font-size: 1.1rem;
        }

        .patient-switcher {
            background: rgba(0,0,0,0.15);
            border-radius: 20px;
            padding: 12px 16px;
            margin-top: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
        }

        .switch-btn {
            background: white;
            border: none;
            padding: 8px 16px;
            border-radius: 30px;
            color: var(--primary);
            font-weight: 600;
            cursor: pointer;
        }

        /* ইমেজ গ্যালারি */
        .image-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }

        .gallery-item {
            position: relative;
            border-radius: 16px;
            overflow: hidden;
            border: 2px solid var(--primary-light);
            cursor: pointer;
            aspect-ratio: 1;
        }

        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .gallery-item .overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(10, 92, 75, 0.8);
            color: white;
            padding: 5px;
            font-size: 0.7rem;
            text-align: center;
        }

        .no-images {
            background: var(--light-gray);
            border-radius: 16px;
            padding: 30px;
            text-align: center;
            color: var(--gray);
        }

        /* প্রেসক্রিপশন কার্ড */
        .prescription-card {
            background: #f8fafc;
            border-radius: 20px;
            padding: 20px;
            border: 1px solid var(--light-gray);
            margin-top: 20px;
        }

        .prescription-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px dashed var(--primary);
        }

        .clinic-name-pres {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .prescription-date {
            background: var(--primary-light);
            padding: 8px 15px;
            border-radius: 30px;
            font-weight: 600;
        }

        .patient-info-pres {
            background: white;
            border-radius: 16px;
            padding: 15px;
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .info-item-pres {
            font-size: 0.95rem;
        }

        .info-label {
            color: var(--gray);
            font-size: 0.8rem;
        }

        .info-value {
            font-weight: 600;
            color: var(--dark);
        }

        .problems-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }

        .problems-table th {
            background: var(--primary-light);
            padding: 10px;
            text-align: center;
            font-size: 0.85rem;
            color: var(--primary-dark);
        }

        .problems-table td {
            padding: 12px 8px;
            border-bottom: 1px solid #dee2e6;
            font-size: 0.9rem;
        }

        .crown-badge {
            background: var(--warning-light);
            color: var(--warning);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            display: inline-block;
        }

        .total-pres {
            background: white;
            border-radius: 16px;
            padding: 15px;
            margin-top: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 700;
        }

        /* চিকিৎসার ইতিহাস */
        .history-section {
            background: white;
            border-radius: 28px;
            padding: 20px;
            margin: 20px;
            box-shadow: var(--box-shadow);
        }

        .filter-tabs {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding-bottom: 8px;
            margin-bottom: 20px;
        }

        .filter-tab {
            padding: 8px 20px;
            border: 1.5px solid var(--light-gray);
            border-radius: 30px;
            background: white;
            color: var(--gray);
            font-weight: 500;
            white-space: nowrap;
            cursor: pointer;
        }

        .filter-tab.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .treatment-card {
            background: #f8fafc;
            border-radius: 20px;
            padding: 18px;
            border-left: 6px solid var(--primary);
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 15px;
        }

        .treatment-card:hover {
            transform: translateX(5px);
            box-shadow: var(--box-shadow);
        }

        .treatment-card.paid { border-left-color: var(--success); background: var(--success-light); }
        .treatment-card.due { border-left-color: var(--danger); background: var(--danger-light); }
        .treatment-card.crown { border-left-color: var(--warning); background: var(--warning-light); }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .card-date {
            background: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            color: var(--gray);
        }

        .card-amount {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .problem-list {
            margin: 12px 0;
        }

        .problem-item {
            background: white;
            border-radius: 14px;
            padding: 12px;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .payment-log {
            background: white;
            border-radius: 14px;
            padding: 12px;
            margin-top: 12px;
        }

        .log-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px dashed #dee2e6;
        }

        /* মাসিক পরিসংখ্যান */
        .monthly-stats {
            background: linear-gradient(145deg, #f8fafc, #f0f4f8);
            border-radius: 24px;
            margin: 20px;
            overflow: hidden;
        }

        .stats-header {
            background: var(--primary);
            color: white;
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .stats-content {
            padding: 0 20px;
            max-height: 0;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .stats-content.active {
            padding: 20px;
            max-height: 500px;
        }

        .monthly-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .month-card {
            background: white;
            padding: 15px;
            border-radius: 18px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        /* মোডাল */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            display: none;
            align-items: flex-end;
            z-index: 2000;
            backdrop-filter: blur(5px);
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            width: 100%;
            border-radius: 30px 30px 0 0;
            padding: 25px;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.3s;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .modal-title {
            font-size: 1.5rem;
            color: var(--primary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* মেসেজ অপশন */
        .message-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }

        .message-option {
            background: var(--primary-light);
            border: 2px solid transparent;
            border-radius: 18px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .message-option.selected {
            border-color: var(--primary);
            background: white;
            box-shadow: 0 5px 15px rgba(10, 92, 75, 0.1);
        }

        .message-preview {
            background: #f8fafc;
            border-radius: 16px;
            padding: 16px;
            margin: 15px 0;
            border-left: 4px solid var(--primary);
            font-size: 0.95rem;
            line-height: 1.6;
            color: var(--dark);
            white-space: pre-line;
            max-height: 300px;
            overflow-y: auto;
        }

        /* বোতাম */
        .btn {
            padding: 16px;
            border: none;
            border-radius: 18px;
            font-weight: 700;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            cursor: pointer;
            width: 100%;
        }

        .btn-primary { background: linear-gradient(145deg, var(--primary), var(--primary-dark)); color: white; }
        .btn-success { background: linear-gradient(145deg, var(--success), var(--success-dark)); color: white; }
        .btn-danger { background: linear-gradient(145deg, var(--danger), #8b1a1a); color: white; }
        .btn-info { background: linear-gradient(145deg, #4a6fa5, #3a5a8c); color: white; }

        /* নিচের নেভিগেশন */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            justify-content: space-around;
            padding: 12px 15px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.08);
            border-radius: 30px 30px 0 0;
            padding-bottom: calc(12px + var(--safe-bottom));
            z-index: 1000;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: var(--gray);
            font-size: 0.8rem;
            gap: 4px;
            padding: 8px 12px;
            border-radius: 16px;
            transition: all 0.2s;
            flex: 1;
        }

        .nav-item.active {
            color: var(--primary);
            background: var(--primary-light);
        }

        .nav-icon {
            font-size: 1.4rem;
        }

        /* FAB মেনু */
        .fab-menu {
            position: fixed;
            bottom: 90px;
            right: 20px;
            display: none;
            flex-direction: column;
            align-items: center;
            z-index: 1001;
        }

        .fab-btn {
            width: 60px;
            height: 60px;
            border-radius: 30px;
            background: linear-gradient(145deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            box-shadow: 0 10px 25px rgba(10, 92, 75, 0.3);
            font-size: 1.6rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .fab-label {
            background: white;
            padding: 6px 12px;
            border-radius: 20px;
            margin-top: 8px;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--primary);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        /* লোডিং ওভারলে */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }

        .loading-overlay.active {
            display: flex;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--primary-light);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* মেসেজ বক্স */
        .message-box {
            position: fixed;
            bottom: 100px;
            left: 20px;
            right: 20px;
            background: white;
            padding: 16px 20px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
            z-index: 10000;
            animation: slideUp 0.3s;
            border-left: 5px solid;
        }

        .message-success { border-left-color: var(--success); color: var(--success-dark); }
        .message-error { border-left-color: var(--danger); color: var(--danger); }
        .message-info { border-left-color: var(--primary); color: var(--primary-dark); }

        /* ইমেজ ভিউয়ার */
        .image-viewer-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 20px;
        }

        .image-viewer-modal.active {
            display: flex;
        }

        .image-viewer-content {
            position: relative;
            max-width: 90%;
            max-height: 90%;
        }

        .image-viewer-content img {
            max-width: 100%;
            max-height: 90vh;
            border-radius: 20px;
        }

        .close-viewer {
            position: absolute;
            top: -40px;
            right: 0;
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--gray);
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 480px) {
            .action-grid { grid-template-columns: repeat(2, 1fr); }
            .monthly-grid { grid-template-columns: 1fr; }
            .patient-info-pres { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <!-- লোডিং ওভারলে -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <!-- মেসেজ কন্টেইনার -->
    <div id="messageContainer"></div>

    <!-- ইমেজ ভিউয়ার মোডাল -->
    <div class="image-viewer-modal" id="imageViewerModal" onclick="if(event.target===this) this.classList.remove('active')">
        <div class="image-viewer-content">
            <button class="close-viewer" onclick="document.getElementById('imageViewerModal').classList.remove('active')">
                <i class="fas fa-times"></i>
            </button>
            <img id="viewerImage" src="" alt="">
        </div>
    </div>

    <!-- মোবাইল হেডার -->
    <header class="mobile-header">
        <div class="header-top">
            <div>
                <div class="clinic-name">চৌধুরী ডেন্টাল</div>
                <div class="clinic-sub">সম্পূর্ণ ব্যবস্থাপনা</div>
            </div>
            <button class="menu-btn" id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i>
            </button>
        </div>
    </header>

    <!-- স্ট্যাটস কার্ড -->
    <div class="stats-grid" id="homeStats">
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-users"></i></div>
            <div class="stat-info">
                <h3>মোট রোগী</h3>
                <div class="stat-number" id="totalPatients">0</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-file-invoice"></i></div>
            <div class="stat-info">
                <h3>মোট বিল</h3>
                <div class="stat-number" id="totalBill">৳ 0</div>
            </div>
        </div>
    </div>

    <!-- অ্যাকশন বাটন -->
    <div class="action-grid">
        <div class="action-card" id="newPatientBtn">
            <div class="action-icon"><i class="fas fa-user-plus"></i></div>
            <div class="action-title">রুগি এড</div>
            <div class="action-desc">নতুন এন্ট্রি</div>
        </div>
        <div class="action-card" id="patientHistoryBtn">
            <div class="action-icon"><i class="fas fa-history"></i></div>
            <div class="action-title">হিস্ট্রি</div>
            <div class="action-desc">আগের চিকিৎসা</div>
        </div>
        <div class="action-card" id="phoneNumbersBtn">
            <div class="action-icon"><i class="fas fa-phone"></i></div>
            <div class="action-title">নাম্বার লিস্ট</div>
            <div class="action-desc">সকল নাম্বার</div>
        </div>
        <div class="action-card" id="profileViewBtn">
            <div class="action-icon"><i class="fas fa-user-md"></i></div>
            <div class="action-title">প্রোফাইল</div>
            <div class="action-desc">দেখুন</div>
        </div>
    </div>

    <!-- হোম সেকশন (ডিফল্ট) -->
    <div id="homeSection">
        <div class="section-card" id="recentSection">
            <div class="section-title">
                <i class="fas fa-history"></i>
                <span>সর্বশেষ রোগী</span>
            </div>
            <div class="recent-list" id="recentPatientsList">
                <div class="empty-state">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                    <p>লোড হচ্ছে...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- নতুন রোগী ফর্ম সেকশন (লুকানো) -->
    <div class="section-card" id="newPatientSection" style="display: none;">
        <div class="section-title">
            <i class="fas fa-user-plus"></i>
            <span>নতুন রোগী এন্ট্রি</span>
        </div>

        <form id="patientForm">
            <div class="form-group">
                <label class="form-label">রোগীর নাম *</label>
                <input type="text" id="patientName" class="form-control" placeholder="যেমন: মোঃ রফিকুল ইসলাম" required>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">বয়স</label>
                    <input type="number" id="patientAge" class="form-control" placeholder="বয়স" min="0" max="120">
                </div>
                <div class="form-group">
                    <label class="form-label">লিঙ্গ</label>
                    <div class="gender-group">
                        <label><input type="radio" name="gender" value="পুরুষ"> পুরুষ</label>
                        <label><input type="radio" name="gender" value="মহিলা"> মহিলা</label>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">মোবাইল নাম্বার *</label>
                <input type="tel" id="patientPhone" class="form-control" placeholder="01XXXXXXXXX" required>
            </div>

            <div class="form-group">
                <label class="form-label">ঠিকানা</label>
                <input type="text" id="patientAddress" class="form-control" placeholder="বিস্তারিত ঠিকানা">
            </div>

            <!-- একাধিক সমস্যা সেকশন -->
            <div class="problem-container" id="problemsContainer">
                <div class="problem-item" id="problemTemplate">
                    <div class="problem-header">
                        <span class="problem-badge">চিকিৎসা #১</span>
                        <button type="button" class="remove-problem" style="display: none;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">চিকিৎসার ধরন *</label>
                        <select class="form-control problem-type" required>
                            <option value="">নির্বাচন করুন</option>
                            <option value="রুট ক্যানাল">রুট ক্যানাল</option>
                            <option value="দাঁত তোলা">দাঁত তোলা</option>
                            <option value="লাইট কিউর ফিলিং">লাইট কিউর ফিলিং</option>
                            <option value="স্কেলিং ও পলিশিং">স্কেলিং ও পলিশিং</option>
                            <option value="ডেন্টাল ক্রাউন">ডেন্টাল ক্রাউন</option>
                            <option value="অন্যান্য">অন্যান্য</option>
                        </select>
                    </div>

                    <div class="crown-checkbox">
                        <input type="checkbox" class="crown-toggle-checkbox" id="crownToggle1">
                        <label for="crownToggle1">ডেন্টাল ক্রাউন প্রয়োজন</label>
                    </div>

                    <div class="crown-options crown-section">
                        <div class="form-group">
                            <label class="form-label">ক্রাউনের ধরন</label>
                            <select class="form-control crown-type">
                                <option value="পোর্সেলিন">পোর্সেলিন ক্রাউন</option>
                                <option value="জিরকোনিয়া">জিরকোনিয়া</option>
                                <option value="মেটাল">মেটাল</option>
                            </select>
                        </div>

                        <label class="form-label">শেড</label>
                        <div class="shade-grid">
                            <div class="shade-item active" data-shade="A2">A2</div>
                            <div class="shade-item" data-shade="A3">A3</div>
                            <div class="shade-item" data-shade="B1">B1</div>
                            <div class="shade-item" data-shade="B2">B2</div>
                        </div>
                        <input type="hidden" class="crown-shade" value="A2">

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">কয়টি</label>
                                <input type="number" class="form-control crown-qty" min="1" value="1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">প্রতি দাম (৳)</label>
                                <input type="number" class="form-control crown-price" min="0" value="0">
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">বিস্তারিত</label>
                        <textarea class="form-control problem-desc" rows="2"></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">মোট খরচ (৳) *</label>
                        <input type="number" class="form-control problem-cost" min="0" value="0" required>
                    </div>

                    <div class="discount-row">
                        <div class="form-group">
                            <label class="form-label">ডিসকাউন্ট (%)</label>
                            <input type="number" class="form-control discount-percent" min="0" max="100" value="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">ডিসকাউন্ট (৳)</label>
                            <input type="number" class="form-control discount-amount" min="0" value="0">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">আজকের জমা (৳)</label>
                        <input type="number" class="form-control problem-paid" min="0" value="0">
                    </div>
                </div>
            </div>

            <button type="button" class="add-problem-btn" id="addProblemBtn">
                <i class="fas fa-plus-circle"></i>
                আরেকটি সমস্যা যোগ করুন
            </button>

            <div class="image-upload-area" id="imageUploadArea">
                <i class="fas fa-cloud-upload-alt"></i>
                <p>প্রেসক্রিপশনের ছবি আপলোড করুন</p>
                <input type="file" id="prescriptionImages" accept="image/*" multiple style="display: none;">
                <div class="upload-progress" id="uploadProgress">
                    <div class="upload-progress-bar" id="uploadProgressBar"></div>
                </div>
            </div>
            <div class="image-preview" id="imagePreview"></div>

            <div class="total-section">
                <div class="total-row">
                    <span class="total-label">মোট বিল</span>
                    <span class="total-amount" id="totalBillAmount">৳ 0</span>
                </div>
                <div class="total-row">
                    <span class="total-label">মোট ডিসকাউন্ট</span>
                    <span class="total-amount" id="totalDiscount">৳ 0</span>
                </div>
                <div class="total-row">
                    <span class="total-label">নেট বিল</span>
                    <span class="total-amount grand-total" id="netBill">৳ 0</span>
                </div>
                <div class="total-row">
                    <span class="total-label">মোট জমা</span>
                    <span class="total-amount" id="totalPaid">৳ 0</span>
                </div>
                <div class="total-row">
                    <span class="total-label">বাকি</span>
                    <span class="total-amount due-amount" id="totalDue">৳ 0</span>
                </div>
            </div>

            <input type="hidden" id="editPatientId" value="">
            <input type="hidden" id="uploadedImages" value="">

            <button type="submit" class="submit-btn" id="submitBtn">
                <i class="fas fa-save"></i>
                সংরক্ষণ করুন
            </button>
        </form>
    </div>

    <!-- প্রোফাইল সেকশন (লুকানো) -->
    <div id="profileSection" style="display: none;">
        <div class="profile-header">
            <div class="header-top">
                <button class="nav-btn" id="backFromProfile"><i class="fas fa-arrow-left"></i></button>
                <button class="nav-btn" id="homeFromProfile"><i class="fas fa-home"></i></button>
            </div>
            
            <h1 class="patient-name" id="profilePatientName">—</h1>
            
            <div class="info-grid">
                <div class="info-item"><i class="fas fa-phone-alt"></i> <span id="profilePatientPhone">মোবাইল: —</span></div>
                <div class="info-item"><i class="fas fa-map-marker-alt"></i> <span id="profilePatientAddress">ঠিকানা: —</span></div>
                <div class="info-item"><i class="fas fa-calendar-alt"></i> <span id="profilePatientAge">বয়স: —</span></div>
            </div>
            
            <div class="patient-switcher" id="patientSwitcher" style="display: none;">
                <div><i class="fas fa-users"></i> <span id="patientCount">১/১</span></div>
                <button class="switch-btn" id="switchPatientBtn">পরিবর্তন</button>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card"><div class="stat-value" id="profileTotalBill">৳০</div><div class="stat-label">মোট বিল</div></div>
            <div class="stat-card success"><div class="stat-value" id="profileTotalPaid">৳০</div><div class="stat-label">জমা</div></div>
            <div class="stat-card danger"><div class="stat-value" id="profileTotalDue">৳০</div><div class="stat-label">বকেয়া</div></div>
            <div class="stat-card warning"><div class="stat-value" id="profileTotalTreatments">০</div><div class="stat-label">চিকিৎসা</div></div>
        </div>

        <div class="action-grid">
            <button class="action-card" id="profileAddPayment">
                <div class="action-icon" style="background: var(--success-light); color: var(--success);"><i class="fas fa-coins"></i></div>
                <div class="action-title">টাকা জমা</div>
            </button>
            <button class="action-card" id="profileAddTreatment">
                <div class="action-icon" style="background: var(--primary-light); color: var(--primary);"><i class="fas fa-tooth"></i></div>
                <div class="action-title">নতুন চিকিৎসা</div>
            </button>
            <button class="action-card" id="profileEditPatient">
                <div class="action-icon" style="background: var(--warning-light); color: var(--warning);"><i class="fas fa-user-edit"></i></div>
                <div class="action-title">সম্পাদনা</div>
            </button>
            <button class="action-card" id="profileDiscountBtn">
                <div class="action-icon" style="background: #ffe6e6; color: var(--danger);"><i class="fas fa-percentage"></i></div>
                <div class="action-title">ডিসকাউন্ট</div>
            </button>
        </div>

        <button class="message-action-btn" id="openMessageModalBtn">
            <i class="fas fa-comment-dots"></i>
            <span>মেসেজ পাঠান</span>
            <i class="fas fa-chevron-right"></i>
        </button>

        <div class="prescription-section" style="margin: 0 20px 20px;">
            <div class="section-header">
                <h3><i class="fas fa-prescription"></i> প্রেসক্রিপশন</h3>
                <span class="treatment-count" id="imageCount">০ টি ছবি</span>
            </div>
            
            <div id="imageGallery" class="image-gallery">
                <div class="no-images">
                    <i class="fas fa-images"></i>
                    <p>কোনো ছবি নেই</p>
                </div>
            </div>
            
            <div class="prescription-card" id="prescriptionCard"></div>
        </div>

        <div class="monthly-stats">
            <div class="stats-header" id="toggleMonthlyStats">
                <h3><i class="fas fa-chart-line"></i> মাসিক পরিসংখ্যান</h3>
                <i class="fas fa-chevron-down" id="toggleIcon"></i>
            </div>
            <div class="stats-content" id="monthlyContent">
                <div class="monthly-grid" id="monthlyData"></div>
            </div>
        </div>

        <div class="history-section">
            <div class="section-header">
                <div class="section-title"><i class="fas fa-notes-medical"></i> চিকিৎসার ইতিহাস</div>
                <span class="treatment-count" id="historyCount">০ টি</span>
            </div>

            <div class="filter-tabs">
                <button class="filter-tab active" data-filter="all">সকল</button>
                <button class="filter-tab" data-filter="due">বকেয়া</button>
                <button class="filter-tab" data-filter="paid">পরিশোধিত</button>
            </div>

            <div class="history-list" id="treatmentHistory">
                <div class="empty-state"><i class="fas fa-spinner fa-spin"></i><p>লোড হচ্ছে...</p></div>
            </div>
        </div>
    </div>

    <!-- মোডালগুলি -->
    <div class="modal" id="paymentModal">
        <div class="modal-content">
            <h2 class="modal-title"><i class="fas fa-hand-holding-usd"></i> টাকা জমা দিন</h2>
            <form id="paymentForm">
                <div class="form-group">
                    <label>পরিমাণ (৳)</label>
                    <input type="number" id="paymentAmount" class="form-control" min="1" required>
                </div>
                <div class="form-group">
                    <label>মন্তব্য</label>
                    <textarea id="paymentNotes" class="form-control" rows="3"></textarea>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button type="submit" class="btn btn-success" style="flex: 2;">জমা দিন</button>
                    <button type="button" class="btn btn-danger" style="flex: 1;" onclick="closeModal('paymentModal')">বাতিল</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="discountModal">
        <div class="modal-content">
            <h2 class="modal-title"><i class="fas fa-percentage"></i> ডিসকাউন্ট দিন</h2>
            <form id="discountForm">
                <div class="form-group">
                    <label>চিকিৎসা নির্বাচন</label>
                    <select id="treatmentSelect" class="form-control" required>
                        <option value="">নির্বাচন করুন</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>পরিমাণ (৳)</label>
                    <input type="number" id="discountAmount" class="form-control" min="1" required>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button type="submit" class="btn btn-primary" style="flex: 2;">প্রয়োগ করুন</button>
                    <button type="button" class="btn btn-danger" style="flex: 1;" onclick="closeModal('discountModal')">বাতিল</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="messageModal">
        <div class="modal-content">
            <h2 class="modal-title"><i class="fas fa-comment-dots"></i> মেসেজ পাঠান</h2>
            
            <div class="message-options">
                <div class="message-option" data-message="ক্যাপ">
                    <i class="fas fa-crown"></i>
                    <div>ক্রাউন/ক্যাপ তৈরি হয়েছে</div>
                </div>
                <div class="message-option" data-message="শেষ">
                    <i class="fas fa-check-circle"></i>
                    <div>চিকিৎসা সম্পন্ন</div>
                </div>
                <div class="message-option" data-message="ডিউ">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div>বকেয়া টাকা</div>
                </div>
            </div>

            <div class="message-preview" id="messagePreview">
                <div id="previewText">একটি অপশন নির্বাচন করুন</div>
            </div>

            <div class="form-group">
                <label>অতিরিক্ত মেসেজ</label>
                <textarea id="customMessage" class="form-control" rows="3"></textarea>
            </div>

            <div style="display: flex; gap: 10px;">
                <button class="btn btn-info" id="sendMessageBtn" style="flex: 2;">
                    <i class="fas fa-paper-plane"></i> পাঠান
                </button>
                <button class="btn btn-danger" style="flex: 1;" onclick="closeModal('messageModal')">বাতিল</button>
            </div>
        </div>
    </div>

    <div class="modal" id="historyModal">
        <div class="modal-content">
            <div class="section-title">
                <i class="fas fa-history"></i>
                <span>চিকিৎসার ইতিহাস</span>
            </div>
            <input type="text" class="form-control" id="searchHistory" placeholder="খুঁজুন..." style="margin-bottom: 20px;">
            <div class="patient-list" id="historyList"></div>
            <button class="submit-btn" onclick="closeModal('historyModal')">বন্ধ করুন</button>
        </div>
    </div>

    <div class="modal" id="numbersModal">
        <div class="modal-content">
            <div class="section-title">
                <i class="fas fa-phone"></i>
                <span>সকল ফোন নাম্বার</span>
            </div>
            <button class="add-problem-btn" id="copyAllNumbers">
                <i class="fas fa-copy"></i> সব কপি করুন
            </button>
            <div class="patient-list" id="numbersList"></div>
            <button class="submit-btn" onclick="closeModal('numbersModal')">বন্ধ করুন</button>
        </div>
    </div>

    <!-- FAB মেনু -->
    <div class="fab-menu" id="fabMenu">
        <button class="fab-btn" id="fabProfileBtn"><i class="fas fa-user"></i></button>
        <div class="fab-label" id="fabLabel">সর্বশেষ রোগী</div>
    </div>

    <!-- নিচের নেভিগেশন -->
    <nav class="bottom-nav">
        <a href="#" class="nav-item active" data-section="home"><i class="fas fa-home nav-icon"></i><span>হোম</span></a>
        <a href="#" class="nav-item" data-section="new"><i class="fas fa-user-plus nav-icon"></i><span>নতুন</span></a>
        <a href="#" class="nav-item" data-section="profile"><i class="fas fa-user-md nav-icon"></i><span>প্রোফাইল</span></a>
        <a href="#" class="nav-item" data-section="numbers"><i class="fas fa-phone nav-icon"></i><span>নাম্বার</span></a>
    </nav>

    <script>

        // Service Worker রেজিস্টার
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js');
  });
}
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyAxz46ug-CAywevI-PzmOp7ba5iiCK9dfM",
            authDomain: "plasma-raceway-465016-v0.firebaseapp.com",
            projectId: "plasma-raceway-465016-v0",
            storageBucket: "plasma-raceway-465016-v0.firebasestorage.app",
            messagingSenderId: "23620370976",
            appId: "1:23620370976:web:3bb119ceb9e15608a33245"
        };

        // Cloudinary Config
        const CLOUDINARY_CONFIG = {
            cloudName: 'dsdca3db1',
            uploadPreset: 'Dental'
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Global Variables
        let uploadedImageUrls = [];
        let problemCount = 1;
        let currentPatient = null;
        let allPatientsWithSamePhone = [];
        let currentPatientIndex = 0;
        let allTreatments = [];
        let currentFilter = 'all';
        let selectedMessageType = '';

        // Utility Functions
        function showLoading() {
            document.getElementById('loadingOverlay').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }

        function showMessage(msg, type = 'info') {
            const container = document.getElementById('messageContainer');
            const msgDiv = document.createElement('div');
            msgDiv.className = `message-box message-${type}`;
            msgDiv.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i> ${msg}`;
            container.appendChild(msgDiv);
            setTimeout(() => msgDiv.remove(), 3000);
        }

        window.closeModal = function(modalId) {
            document.getElementById(modalId).classList.remove('active');
        };

        window.viewImage = function(imageUrl) {
            document.getElementById('viewerImage').src = imageUrl;
            document.getElementById('imageViewerModal').classList.add('active');
        };

        // Cloudinary Upload
        async function uploadToCloudinary(file) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', CLOUDINARY_CONFIG.uploadPreset);

            const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CONFIG.cloudName}/image/upload`, {
                method: 'POST',
                body: formData
            });

            if (!response.ok) throw new Error('Upload failed');
            const data = await response.json();
            return data.secure_url;
        }

        // Image Upload Handler
        document.getElementById('imageUploadArea')?.addEventListener('click', () => {
            document.getElementById('prescriptionImages').click();
        });

        document.getElementById('prescriptionImages')?.addEventListener('change', async function(e) {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;

            const progress = document.getElementById('uploadProgress');
            const progressBar = document.getElementById('uploadProgressBar');
            progress.style.display = 'block';
            progressBar.style.width = '0%';

            let completed = 0;

            for (const file of files) {
                try {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.className = 'preview-img';
                        document.getElementById('imagePreview').appendChild(img);
                    };
                    reader.readAsDataURL(file);

                    const imageUrl = await uploadToCloudinary(file);
                    uploadedImageUrls.push(imageUrl);
                    completed++;
                    progressBar.style.width = `${(completed / files.length) * 100}%`;
                } catch (error) {
                    showMessage('আপলোডে সমস্যা', 'error');
                }
            }

            setTimeout(() => {
                progress.style.display = 'none';
                progressBar.style.width = '0%';
            }, 1000);

            document.getElementById('uploadedImages').value = JSON.stringify(uploadedImageUrls);
            showMessage(`${completed}টি ছবি আপলোড হয়েছে`, 'success');
        });

        // Crown Checkbox Handler
        function handleCrownCheckbox(e) {
            const problemItem = e.target.closest('.problem-item');
            const crownDiv = problemItem.querySelector('.crown-options');
            if (e.target.checked) {
                crownDiv.classList.add('active');
            } else {
                crownDiv.classList.remove('active');
            }
            calculateTotals();
        }

        // Discount Handler
        function discountInputHandler(e) {
            const problemItem = e.target.closest('.problem-item');
            const percent = problemItem.querySelector('.discount-percent');
            const amount = problemItem.querySelector('.discount-amount');
            
            if (e.target.classList.contains('discount-percent') && percent.value) {
                amount.value = '';
            } else if (e.target.classList.contains('discount-amount') && amount.value) {
                percent.value = '';
            }
            calculateTotals();
        }

        // Shade Handler
        function attachShadeListeners(container) {
            container.querySelectorAll('.shade-item').forEach(shade => {
                shade.addEventListener('click', function() {
                    const grid = this.closest('.shade-grid');
                    grid.querySelectorAll('.shade-item').forEach(s => s.classList.remove('active'));
                    this.classList.add('active');
                    const shadeInput = this.closest('.crown-options').querySelector('.crown-shade');
                    if (shadeInput) shadeInput.value = this.dataset.shade;
                });
            });
        }

        // Calculate Totals
        function calculateTotals() {
            const problems = document.querySelectorAll('.problem-item');
            let totalBill = 0, totalDiscount = 0, totalPaid = 0;
            
            problems.forEach(p => {
                const cost = parseFloat(p.querySelector('.problem-cost')?.value) || 0;
                const isCrown = p.querySelector('.crown-toggle-checkbox')?.checked;
                const crownQty = isCrown ? (parseFloat(p.querySelector('.crown-qty')?.value) || 0) : 0;
                const crownPrice = isCrown ? (parseFloat(p.querySelector('.crown-price')?.value) || 0) : 0;
                const crownCost = crownQty * crownPrice;
                const problemTotal = cost + crownCost;
                
                let discount = 0;
                const discountPercent = parseFloat(p.querySelector('.discount-percent')?.value) || 0;
                const discountAmount = parseFloat(p.querySelector('.discount-amount')?.value) || 0;
                
                if (discountPercent > 0) {
                    discount = (problemTotal * discountPercent) / 100;
                } else if (discountAmount > 0) {
                    discount = discountAmount;
                }
                
                const paid = parseFloat(p.querySelector('.problem-paid')?.value) || 0;
                
                totalBill += problemTotal;
                totalDiscount += discount;
                totalPaid += paid;
            });
            
            const netBill = totalBill - totalDiscount;
            const due = Math.max(0, netBill - totalPaid);
            
            document.getElementById('totalBillAmount').innerHTML = `৳ ${totalBill}`;
            document.getElementById('totalDiscount').innerHTML = `৳ ${totalDiscount}`;
            document.getElementById('netBill').innerHTML = `৳ ${netBill}`;
            document.getElementById('totalPaid').innerHTML = `৳ ${totalPaid}`;
            document.getElementById('totalDue').innerHTML = `৳ ${due}`;
        }

        // Add Problem
        document.getElementById('addProblemBtn')?.addEventListener('click', () => {
            const template = document.getElementById('problemTemplate');
            const clone = template.cloneNode(true);
            problemCount++;
            
            clone.id = '';
            clone.querySelector('.problem-badge').textContent = `চিকিৎসা #${problemCount}`;
            
            clone.querySelectorAll('input, select, textarea').forEach(el => {
                if (el.type !== 'hidden') {
                    if (el.type === 'checkbox') el.checked = false;
                    else el.value = '';
                }
            });
            clone.querySelector('.crown-qty').value = '1';
            clone.querySelector('.crown-price').value = '0';
            clone.querySelector('.problem-cost').value = '0';
            clone.querySelector('.discount-percent').value = '0';
            clone.querySelector('.discount-amount').value = '0';
            clone.querySelector('.problem-paid').value = '0';
            clone.querySelector('.crown-options').classList.remove('active');
            
            const removeBtn = clone.querySelector('.remove-problem');
            removeBtn.style.display = 'flex';
            
            attachShadeListeners(clone);
            
            clone.querySelector('.crown-toggle-checkbox').addEventListener('change', handleCrownCheckbox);
            
            clone.querySelector('.discount-percent').addEventListener('input', discountInputHandler);
            clone.querySelector('.discount-amount').addEventListener('input', discountInputHandler);
            
            clone.querySelectorAll('.problem-cost, .problem-paid, .crown-qty, .crown-price').forEach(el => {
                el.addEventListener('input', calculateTotals);
            });
            
            removeBtn.addEventListener('click', function() {
                clone.remove();
                calculateTotals();
                problemCount = document.querySelectorAll('.problem-item').length;
            });
            
            document.getElementById('problemsContainer').appendChild(clone);
            calculateTotals();
        });

        // Initialize Form Listeners
        attachShadeListeners(document);
        document.querySelectorAll('.crown-toggle-checkbox').forEach(cb => {
            cb.addEventListener('change', handleCrownCheckbox);
        });
        document.querySelectorAll('.discount-percent, .discount-amount').forEach(el => {
            el.addEventListener('input', discountInputHandler);
        });
        document.querySelectorAll('.problem-cost, .problem-paid, .crown-qty, .crown-price').forEach(el => {
            el.addEventListener('input', calculateTotals);
        });

        // Reset Form
        function resetForm() {
            document.getElementById('patientName').value = '';
            document.getElementById('patientPhone').value = '';
            document.getElementById('patientAge').value = '';
            document.getElementById('patientAddress').value = '';
            document.querySelectorAll('input[name="gender"]').forEach(r => r.checked = false);
            document.getElementById('editPatientId').value = '';
            
            const container = document.getElementById('problemsContainer');
            while (container.children.length > 1) {
                container.lastElementChild.remove();
            }
            
            const first = container.firstElementChild;
            first.querySelectorAll('input, select, textarea').forEach(el => {
                if (el.type === 'checkbox') el.checked = false;
                else if (el.type !== 'hidden') el.value = '';
            });
            first.querySelector('.crown-qty').value = '1';
            first.querySelector('.crown-price').value = '0';
            first.querySelector('.problem-cost').value = '0';
            first.querySelector('.discount-percent').value = '0';
            first.querySelector('.discount-amount').value = '0';
            first.querySelector('.problem-paid').value = '0';
            first.querySelector('.crown-options').classList.remove('active');
            
            first.querySelector('.remove-problem').style.display = 'none';
            
            problemCount = 1;
            uploadedImageUrls = [];
            document.getElementById('uploadedImages').value = '';
            document.getElementById('imagePreview').innerHTML = '';
            
            calculateTotals();
        }

        // Form Submit
        document.getElementById('patientForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.classList.add('loading');
            
            const name = document.getElementById('patientName').value.trim();
            const phone = document.getElementById('patientPhone').value.trim();
            
            if (!name || !phone) {
                showMessage('নাম ও মোবাইল নাম্বার আবশ্যক', 'error');
                submitBtn.classList.remove('loading');
                return;
            }
            
            if (!/^01[3-9]\d{8}$/.test(phone)) {
                showMessage('সঠিক মোবাইল নাম্বার দিন', 'error');
                submitBtn.classList.remove('loading');
                return;
            }

            const gender = document.querySelector('input[name="gender"]:checked')?.value || '';

            const problems = [];
            let hasValidProblem = false;

            document.querySelectorAll('.problem-item').forEach(p => {
                const type = p.querySelector('.problem-type')?.value;
                if (type) {
                    hasValidProblem = true;
                    
                    const cost = parseFloat(p.querySelector('.problem-cost')?.value) || 0;
                    const isCrown = p.querySelector('.crown-toggle-checkbox')?.checked;
                    const crownQty = isCrown ? (parseFloat(p.querySelector('.crown-qty')?.value) || 0) : 0;
                    const crownPrice = isCrown ? (parseFloat(p.querySelector('.crown-price')?.value) || 0) : 0;
                    const crownCost = crownQty * crownPrice;
                    const problemTotal = cost + crownCost;

                    let discount = 0;
                    const discountPercent = parseFloat(p.querySelector('.discount-percent')?.value) || 0;
                    const discountAmount = parseFloat(p.querySelector('.discount-amount')?.value) || 0;
                    
                    if (discountPercent > 0) {
                        discount = (problemTotal * discountPercent) / 100;
                    } else if (discountAmount > 0) {
                        discount = discountAmount;
                    }

                    const paid = parseFloat(p.querySelector('.problem-paid')?.value) || 0;
                    
                    problems.push({
                        id: Date.now() + Math.random(),
                        problem: type,
                        description: p.querySelector('.problem-desc')?.value || '',
                        cost: cost,
                        isCrown: isCrown,
                        crownType: isCrown ? (p.querySelector('.crown-type')?.value || '') : '',
                        crownShade: isCrown ? (p.querySelector('.crown-shade')?.value || '') : '',
                        crownQty: crownQty,
                        crownPrice: crownPrice,
                        crownCost: crownCost,
                        totalCost: problemTotal,
                        discountPercent: discountPercent,
                        discountAmount: discountAmount,
                        discount: discount,
                        paid: paid
                    });
                }
            });

            if (!hasValidProblem) {
                showMessage('কমপক্ষে একটি সমস্যা নির্বাচন করুন', 'error');
                submitBtn.classList.remove('loading');
                return;
            }

            let totalBill = 0, totalDiscount = 0, totalPaid = 0;
            problems.forEach(p => {
                totalBill += p.totalCost;
                totalDiscount += p.discount;
                totalPaid += p.paid;
            });
            
            const netBill = totalBill - totalDiscount;
            const due = Math.max(0, netBill - totalPaid);

            const now = new Date();
            const dateTime = now.toLocaleString('bn-BD');

            const treatment = {
                id: Date.now(),
                date: dateTime,
                timestamp: now.toISOString(),
                problems: problems,
                totalBill: totalBill,
                totalDiscount: totalDiscount,
                netBill: netBill,
                totalPaid: totalPaid,
                totalDue: due,
                paymentHistory: [],
                discountHistory: [],
                images: uploadedImageUrls
            };

            showLoading();

            try {
                const editId = document.getElementById('editPatientId')?.value;
                
                if (editId) {
                    const patientRef = db.collection("patients").doc(editId);
                    const patientDoc = await patientRef.get();
                    
                    if (patientDoc.exists) {
                        const existingData = patientDoc.data();
                        const existingTreatments = existingData.treatments || [];
                        
                        await patientRef.update({
                            name: name,
                            phone: phone,
                            age: document.getElementById('patientAge').value || '',
                            gender: gender,
                            address: document.getElementById('patientAddress').value || '',
                            treatments: [...existingTreatments, treatment],
                            lastUpdated: now.toISOString()
                        });
                        
                        hideLoading();
                        submitBtn.classList.remove('loading');
                        showMessage('✅ নতুন চিকিৎসা যোগ হয়েছে!', 'success');
                        
                        setTimeout(() => {
                            showProfile(editId);
                        }, 1500);
                        return;
                    }
                }

                const profileId = `${phone}_${name.replace(/\s+/g, '_')}`;
                const patientRef = db.collection("patients").doc(profileId);
                const patientDoc = await patientRef.get();
                
                if (patientDoc.exists) {
                    const existingData = patientDoc.data();
                    const existingTreatments = existingData.treatments || [];
                    
                    await patientRef.update({
                        treatments: [...existingTreatments, treatment],
                        lastUpdated: now.toISOString()
                    });
                    
                    hideLoading();
                    submitBtn.classList.remove('loading');
                    showMessage('✅ নতুন চিকিৎসা যোগ হয়েছে!', 'success');
                    
                    setTimeout(() => {
                        showProfile(profileId);
                    }, 1500);
                    
                } else {
                    await patientRef.set({
                        name: name,
                        phone: phone,
                        age: document.getElementById('patientAge').value || '',
                        gender: gender,
                        address: document.getElementById('patientAddress').value || '',
                        treatments: [treatment],
                        createdAt: now.toISOString(),
                        lastUpdated: now.toISOString()
                    });
                    
                    hideLoading();
                    submitBtn.classList.remove('loading');
                    showMessage('✅ নতুন রোগী সংরক্ষিত হয়েছে!', 'success');
                    
                    setTimeout(() => {
                        showProfile(profileId);
                    }, 1500);
                }
            } catch (err) {
                console.error('Save error:', err);
                hideLoading();
                submitBtn.classList.remove('loading');
                showMessage('সংরক্ষণে সমস্যা! ' + err.message, 'error');
            }
        });

        // Dashboard Stats
        async function loadDashboardStats() {
            try {
                const snapshot = await db.collection("patients").get();
                let totalPatients = 0;
                let totalBill = 0;
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const treatments = data.treatments || [];
                    treatments.forEach(t => {
                        totalBill += t.totalBill || 0;
                    });
                    totalPatients++;
                });
                
                document.getElementById('totalPatients').textContent = totalPatients;
                document.getElementById('totalBill').innerHTML = `৳ ${totalBill}`;
            } catch (err) { 
                console.error('Stats error:', err);
            }
        }

        // Recent Patients
        async function loadRecentPatients() {
            const container = document.getElementById('recentPatientsList');
            
            try {
                const snapshot = await db.collection("patients").orderBy("lastUpdated", "desc").limit(5).get();
                
                if (snapshot.empty) {
                    container.innerHTML = '<div class="empty-state"><p>কোনো রোগী নেই</p></div>';
                    document.getElementById('fabMenu').style.display = 'none';
                    return;
                }
                
                let html = '';
                let firstPatient = null;
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const name = data.name || 'অজানা';
                    const phone = data.phone || '—';
                    const lastDate = data.lastUpdated ? new Date(data.lastUpdated).toLocaleDateString('bn-BD') : '';
                    
                    if (!firstPatient) {
                        firstPatient = { name, phone, id: doc.id };
                    }
                    
                    html += `
                        <div class="recent-item" onclick="showProfile('${doc.id}')">
                            <div class="recent-avatar"><i class="fas fa-user"></i></div>
                            <div class="recent-info">
                                <div class="recent-name">${name}</div>
                                <div class="recent-phone">${phone}</div>
                                <div class="recent-date">📅 ${lastDate}</div>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
                
                const fabMenu = document.getElementById('fabMenu');
                if (firstPatient) {
                    fabMenu.style.display = 'flex';
                    document.getElementById('fabLabel').textContent = firstPatient.name;
                    document.getElementById('fabProfileBtn').onclick = () => showProfile(firstPatient.id);
                } else {
                    fabMenu.style.display = 'none';
                }
                
            } catch (err) {
                console.error('Recent patients error:', err);
                container.innerHTML = '<div class="empty-state">লোড করতে সমস্যা</div>';
            }
        }

        // History Modal
        async function openHistoryModal() {
            const modal = document.getElementById('historyModal');
            const container = document.getElementById('historyList');
            
            modal.classList.add('active');
            showLoading();
            
            try {
                const snapshot = await db.collection("patients").orderBy("lastUpdated", "desc").get();
                
                let html = '';
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const treatments = data.treatments || [];
                    
                    treatments.forEach(t => {
                        html += `
                            <div class="recent-item" onclick="showProfile('${doc.id}')">
                                <div class="recent-avatar"><i class="fas fa-history"></i></div>
                                <div class="recent-info">
                                    <div class="recent-name">${data.name || 'অজানা'}</div>
                                    <div class="recent-phone">${data.phone || ''}</div>
                                    <div class="recent-date">📋 ${t.problems?.[0]?.problem || 'চিকিৎসা'} | বকেয়া: ৳${t.totalDue || 0}</div>
                                </div>
                            </div>
                        `;
                    });
                });
                
                container.innerHTML = html || '<div class="empty-state">কোনো ইতিহাস নেই</div>';
                
                document.getElementById('searchHistory').addEventListener('input', (e) => {
                    const search = e.target.value.toLowerCase();
                    document.querySelectorAll('#historyList .recent-item').forEach(item => {
                        const text = item.innerText.toLowerCase();
                        item.style.display = text.includes(search) ? 'flex' : 'none';
                    });
                });
                
            } catch (err) {
                console.error('History error:', err);
                container.innerHTML = '<div class="empty-state">লোড করতে সমস্যা</div>';
            } finally {
                hideLoading();
            }
        }

        // Numbers Modal
        async function openNumbersModal() {
            const modal = document.getElementById('numbersModal');
            const container = document.getElementById('numbersList');
            
            modal.classList.add('active');
            showLoading();
            
            try {
                const snapshot = await db.collection("patients").get();
                const phones = new Set();
                
                snapshot.forEach(doc => {
                    const phone = doc.data().phone;
                    if (phone && phone !== '—') phones.add(phone);
                });
                
                const numbers = Array.from(phones).sort();
                
                container.innerHTML = numbers.map((phone, i) => `
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; border-bottom: 1px solid #eee;">
                        <span>${i+1}. ${phone}</span>
                        <button class="add-problem-btn" style="padding: 8px 15px; width: auto;" onclick="copyNumber('${phone}')">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                `).join('') || '<div class="empty-state">কোনো নাম্বার নেই</div>';
                
                document.getElementById('copyAllNumbers').onclick = async () => {
                    await navigator.clipboard.writeText(numbers.join('\n'));
                    showMessage(`${numbers.length}টি নাম্বার কপি হয়েছে`, 'success');
                };
                
            } catch (err) {
                console.error('Numbers error:', err);
                container.innerHTML = '<div class="empty-state">লোড করতে সমস্যা</div>';
            } finally {
                hideLoading();
            }
        }

        window.copyNumber = async function(phone) {
            await navigator.clipboard.writeText(phone);
            showMessage('📋 নাম্বার কপি হয়েছে', 'success');
        };

        // Show Profile
        async function showProfile(profileId) {
            showLoading();
            
            try {
                const doc = await db.collection("patients").doc(profileId).get();
                
                if (doc.exists) {
                    const data = doc.data();
                    currentPatient = { id: doc.id, data: data };
                    
                    document.getElementById('homeSection').style.display = 'none';
                    document.getElementById('newPatientSection').style.display = 'none';
                    document.getElementById('profileSection').style.display = 'block';
                    
                    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                    document.querySelector('[data-section="profile"]').classList.add('active');
                    
                    displayPatientData(data);
                    
                    const phone = data.phone;
                    if (phone) {
                        const q = await db.collection("patients").where("phone", "==", phone).get();
                        allPatientsWithSamePhone = [];
                        q.forEach(d => {
                            allPatientsWithSamePhone.push({ id: d.id, data: d.data() });
                        });
                        
                        if (allPatientsWithSamePhone.length > 1) {
                            currentPatientIndex = allPatientsWithSamePhone.findIndex(p => p.id === doc.id);
                            document.getElementById('patientSwitcher').style.display = 'flex';
                            document.getElementById('patientCount').textContent = `${currentPatientIndex+1}/${allPatientsWithSamePhone.length}`;
                        } else {
                            document.getElementById('patientSwitcher').style.display = 'none';
                        }
                    }
                }
            } catch (err) {
                console.error('Profile error:', err);
                showMessage('প্রোফাইল লোড করতে সমস্যা', 'error');
            } finally {
                hideLoading();
            }
        }

        function displayPatientData(data) {
            document.getElementById('profilePatientName').textContent = data.name || '—';
            document.getElementById('profilePatientPhone').textContent = `মোবাইল: ${data.phone || '—'}`;
            document.getElementById('profilePatientAddress').textContent = `ঠিকানা: ${data.address || '—'}`;
            document.getElementById('profilePatientAge').textContent = `বয়স: ${data.age || '—'} বছর`;
            
            let totalBill = 0, totalPaid = 0, totalDue = 0;
            
            allTreatments = (data.treatments || []).map((t, i) => {
                let bill = t.totalBill || 0;
                let paid = t.totalPaid || 0;
                let due = t.totalDue || 0;
                
                totalBill += bill;
                totalPaid += paid;
                totalDue += due;
                
                return { ...t, originalIndex: i, bill, paid, due, isPaid: due <= 0 };
            }).reverse();
            
            document.getElementById('profileTotalBill').textContent = `৳${totalBill}`;
            document.getElementById('profileTotalPaid').textContent = `৳${totalPaid}`;
            document.getElementById('profileTotalDue').textContent = `৳${totalDue}`;
            document.getElementById('profileTotalTreatments').textContent = allTreatments.length;
            document.getElementById('historyCount').textContent = `${allTreatments.length} টি`;
            
            updateImageGallery(allTreatments);
            updateTreatmentHistory();
            loadMonthlyStats();
            populateTreatmentSelect();
            
            if (allTreatments.length > 0) {
                document.getElementById('prescriptionCard').innerHTML = generatePrescriptionPreview(allTreatments[0]);
            }
        }

        function updateImageGallery(treatments) {
            const gallery = document.getElementById('imageGallery');
            let allImages = [];
            
            treatments.forEach(t => {
                if (t.images && t.images.length) {
                    allImages = allImages.concat(t.images);
                }
            });
            
            if (allImages.length === 0) {
                gallery.innerHTML = '<div class="no-images"><i class="fas fa-images"></i><p>কোনো ছবি নেই</p></div>';
                document.getElementById('imageCount').textContent = '০ টি ছবি';
                return;
            }
            
            let html = '';
            allImages.forEach((img, i) => {
                html += `
                    <div class="gallery-item" onclick="viewImage('${img}')">
                        <img src="${img}" alt="Image ${i+1}">
                        <div class="overlay"><i class="fas fa-search-plus"></i></div>
                    </div>
                `;
            });
            
            gallery.innerHTML = html;
            document.getElementById('imageCount').textContent = `${allImages.length} টি ছবি`;
        }

        function generatePrescriptionPreview(treatment) {
            const patient = currentPatient.data;
            const date = new Date(treatment.timestamp || Date.now()).toLocaleDateString('bn-BD');
            
            let problemsHtml = '';
            let totalBill = 0;
            
            if (treatment.problems && treatment.problems.length) {
                treatment.problems.forEach(p => {
                    totalBill += p.cost || 0;
                    problemsHtml += `
                        <tr>
                            <td>${p.problem || 'চিকিৎসা'}</td>
                            <td>৳${p.cost || 0}</td>
                            <td>${p.isCrown ? `<span class="crown-badge"><i class="fas fa-crown"></i> ${p.crownType || ''}</span>` : '—'}</td>
                        </tr>
                    `;
                });
            }
            
            const paid = treatment.totalPaid || 0;
            const discount = treatment.totalDiscount || 0;
            const due = treatment.totalDue || 0;
            
            return `
                <div class="prescription-header">
                    <div class="clinic-name-pres">চৌধুরী ডেন্টাল</div>
                    <div class="prescription-date">📅 ${date}</div>
                </div>
                
                <div class="patient-info-pres">
                    <div><span class="info-label">রোগীর নাম</span><div class="info-value">${patient.name}</div></div>
                    <div><span class="info-label">মোবাইল</span><div class="info-value">${patient.phone}</div></div>
                </div>
                
                <table class="problems-table">
                    <thead><tr><th>চিকিৎসা</th><th>খরচ</th><th>ক্রাউন</th></tr></thead>
                    <tbody>${problemsHtml}</tbody>
                </table>
                
                <div class="total-pres">
                    <div>
                        <div>মোট: ৳${totalBill}</div>
                        <div>জমা: ৳${paid}</div>
                        <div>ডিসকাউন্ট: ৳${discount}</div>
                    </div>
                    <div>
                        <div class="grand-total">বাকি: ৳${due}</div>
                    </div>
                </div>
            `;
        }

        function updateTreatmentHistory() {
            let filtered = allTreatments;
            
            if (currentFilter === 'due') filtered = allTreatments.filter(t => t.due > 0);
            else if (currentFilter === 'paid') filtered = allTreatments.filter(t => t.due <= 0);
            
            const container = document.getElementById('treatmentHistory');
            
            if (!filtered.length) {
                container.innerHTML = '<div class="empty-state"><p>কোনো চিকিৎসা নেই</p></div>';
                return;
            }
            
            let html = '';
            filtered.forEach(t => {
                const cardClass = t.due <= 0 ? 'paid' : 'due';
                
                html += `
                    <div class="treatment-card ${cardClass}" onclick="updatePrescriptionFromHistory(${t.originalIndex})">
                        <div class="card-header">
                            <span class="card-date">${t.date || 'তারিখ নেই'}</span>
                            <span class="card-amount">৳${t.bill}</span>
                        </div>
                        
                        <div class="problem-list">
                            ${(t.problems || [t]).map(p => `
                                <div class="problem-item">
                                    <div class="problem-name">${p.problem || 'চিকিৎসা'}</div>
                                    <div class="problem-detail">বিল: ৳${p.cost || 0}</div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div style="display: flex; justify-content: space-between;">
                            <span>জমা: ৳${t.paid}</span>
                            <span>ডিসকাউন্ট: ৳${t.discount || 0}</span>
                        </div>
                        <div style="margin-top: 5px; font-weight: bold; color: ${t.due > 0 ? 'var(--danger)' : 'var(--success)'}">
                            বাকি: ৳${t.due}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        window.updatePrescriptionFromHistory = function(index) {
            const treatment = allTreatments.find(t => t.originalIndex == index);
            if (treatment) {
                document.getElementById('prescriptionCard').innerHTML = generatePrescriptionPreview(treatment);
                document.querySelector('.prescription-section').scrollIntoView({ behavior: 'smooth' });
            }
        };

        async function loadMonthlyStats() {
            try {
                const snapshot = await db.collection("patients").get();
                const months = {};
                const monthNames = ['জানুয়ারি', 'ফেব্রুয়ারি', 'মার্চ', 'এপ্রিল', 'মে', 'জুন', 
                                   'জুলাই', 'আগস্ট', 'সেপ্টেম্বর', 'অক্টোবর', 'নভেম্বর', 'ডিসেম্বর'];
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    (data.treatments || []).forEach(t => {
                        if (t.timestamp) {
                            const date = new Date(t.timestamp);
                            const monthKey = `${date.getFullYear()}-${date.getMonth()}`;
                            
                            if (!months[monthKey]) {
                                months[monthKey] = { 
                                    name: `${monthNames[date.getMonth()]} ${date.getFullYear()}`, 
                                    patients: 0, 
                                    bill: 0,
                                    paid: 0
                                };
                            }
                            
                            months[monthKey].patients++;
                            months[monthKey].bill += t.totalBill || 0;
                            months[monthKey].paid += t.totalPaid || 0;
                        }
                    });
                });
                
                const sorted = Object.values(months).sort((a, b) => new Date(b.name) - new Date(a.name)).slice(0, 6);
                
                document.getElementById('monthlyData').innerHTML = sorted.map(m => `
                    <div class="month-card">
                        <div class="month-name">${m.name}</div>
                        <div class="month-value">${m.patients}</div>
                        <div class="month-small">রোগী</div>
                        <div class="month-value">৳${m.bill}</div>
                    </div>
                `).join('') || '<div class="empty-state">কোনো ডেটা নেই</div>';
                
            } catch (err) {
                console.error('Monthly stats error:', err);
            }
        }

        function populateTreatmentSelect() {
            const select = document.getElementById('treatmentSelect');
            if (!select) return;
            
            select.innerHTML = '<option value="">নির্বাচন করুন</option>';
            
            allTreatments.filter(t => t.due > 0).forEach(t => {
                const option = document.createElement('option');
                option.value = t.originalIndex;
                option.textContent = `${t.date} - বকেয়া: ৳${t.due}`;
                select.appendChild(option);
            });
        }

        // Navigation
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const section = item.dataset.section;
                
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                item.classList.add('active');
                
                document.getElementById('homeSection').style.display = 'none';
                document.getElementById('newPatientSection').style.display = 'none';
                document.getElementById('profileSection').style.display = 'none';
                
                if (section === 'home') {
                    document.getElementById('homeSection').style.display = 'block';
                    loadRecentPatients();
                    loadDashboardStats();
                } else if (section === 'new') {
                    document.getElementById('newPatientSection').style.display = 'block';
                    resetForm();
                } else if (section === 'profile' && currentPatient) {
                    document.getElementById('profileSection').style.display = 'block';
                    displayPatientData(currentPatient.data);
                } else if (section === 'numbers') {
                    openNumbersModal();
                    document.querySelector('[data-section="home"]').classList.add('active');
                    document.getElementById('homeSection').style.display = 'block';
                }
            });
        });

        // Action Buttons
        document.getElementById('newPatientBtn').addEventListener('click', () => {
            document.querySelector('[data-section="new"]').click();
        });
        
        document.getElementById('patientHistoryBtn').addEventListener('click', openHistoryModal);
        document.getElementById('phoneNumbersBtn').addEventListener('click', openNumbersModal);
        
        document.getElementById('profileViewBtn').addEventListener('click', () => {
            if (currentPatient) {
                document.querySelector('[data-section="profile"]').click();
            } else {
                showMessage('প্রথমে একটি রোগী নির্বাচন করুন', 'info');
            }
        });

        // Profile Actions
        document.getElementById('backFromProfile').addEventListener('click', () => {
            document.querySelector('[data-section="home"]').click();
        });
        
        document.getElementById('homeFromProfile').addEventListener('click', () => {
            document.querySelector('[data-section="home"]').click();
        });
        
        document.getElementById('switchPatientBtn').addEventListener('click', () => {
            if (allPatientsWithSamePhone.length > 1) {
                currentPatientIndex = (currentPatientIndex + 1) % allPatientsWithSamePhone.length;
                const next = allPatientsWithSamePhone[currentPatientIndex];
                showProfile(next.id);
            }
        });
        
        document.getElementById('profileAddPayment').addEventListener('click', () => {
            const due = parseFloat(document.getElementById('profileTotalDue').textContent.replace('৳', '')) || 0;
            if (due <= 0) {
                showMessage('কোনো বকেয়া নেই', 'warning');
                return;
            }
            document.getElementById('paymentModal').classList.add('active');
        });
        
        document.getElementById('profileAddTreatment').addEventListener('click', () => {
            if (currentPatient) {
                const params = new URLSearchParams({
                    name: currentPatient.data.name,
                    phone: currentPatient.data.phone,
                    fromProfile: currentPatient.id
                });
                window.location.href = `?${params.toString()}`;
                document.querySelector('[data-section="new"]').click();
            }
        });
        
        document.getElementById('profileEditPatient').addEventListener('click', () => {
            if (currentPatient) {
                const params = new URLSearchParams({
                    edit: currentPatient.id,
                    name: currentPatient.data.name,
                    phone: currentPatient.data.phone,
                    address: currentPatient.data.address,
                    age: currentPatient.data.age,
                    gender: currentPatient.data.gender
                });
                window.location.href = `?${params.toString()}`;
                document.querySelector('[data-section="new"]').click();
            }
        });
        
        document.getElementById('profileDiscountBtn').addEventListener('click', () => {
            if (allTreatments.some(t => t.due > 0)) {
                populateTreatmentSelect();
                document.getElementById('discountModal').classList.add('active');
            } else {
                showMessage('কোনো বকেয়া নেই', 'warning');
            }
        });

        // Payment Form
        document.getElementById('paymentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const amount = parseFloat(document.getElementById('paymentAmount').value);
            const notes = document.getElementById('paymentNotes').value;
            
            if (!amount || amount <= 0) {
                showMessage('সঠিক পরিমাণ দিন', 'error');
                return;
            }
            
            if (!currentPatient) {
                showMessage('রোগী নির্বাচন করা হয়নি', 'error');
                return;
            }
            
            showLoading();
            
            try {
                const patientRef = db.collection("patients").doc(currentPatient.id);
                const doc = await patientRef.get();
                const data = doc.data();
                let treatments = data.treatments || [];
                
                let remaining = amount;
                
                const updatedTreatments = treatments.map(t => {
                    if (remaining <= 0) return t;
                    
                    const due = t.totalDue || 0;
                    if (due <= 0) return t;
                    
                    const pay = Math.min(remaining, due);
                    remaining -= pay;
                    
                    const paymentLog = {
                        amount: pay,
                        date: new Date().toLocaleDateString('bn-BD'),
                        notes: notes
                    };
                    
                    const paymentHistory = [...(t.paymentHistory || []), paymentLog];
                    const newPaid = (t.totalPaid || 0) + pay;
                    const newDue = (t.totalDue || 0) - pay;
                    
                    return {
                        ...t,
                        paymentHistory,
                        totalPaid: newPaid,
                        totalDue: newDue
                    };
                });
                
                await patientRef.update({ treatments: updatedTreatments });
                
                showMessage(`✅ ৳${amount} জমা হয়েছে`, 'success');
                closeModal('paymentModal');
                document.getElementById('paymentForm').reset();
                
                await showProfile(currentPatient.id);
                
            } catch (err) {
                console.error('Payment error:', err);
                showMessage('পেমেন্ট নিতে সমস্যা', 'error');
            } finally {
                hideLoading();
            }
        });

        // Discount Form
        document.getElementById('discountForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const index = parseInt(document.getElementById('treatmentSelect').value);
            const amount = parseFloat(document.getElementById('discountAmount').value);
            
            if (isNaN(index) || !amount || amount <= 0) {
                showMessage('সব তথ্য দিন', 'error');
                return;
            }
            
            if (!currentPatient) {
                showMessage('রোগী নির্বাচন করা হয়নি', 'error');
                return;
            }
            
            showLoading();
            
            try {
                const patientRef = db.collection("patients").doc(currentPatient.id);
                const doc = await patientRef.get();
                const data = doc.data();
                let treatments = [...(data.treatments || [])];
                
                const treatment = treatments[index];
                const due = treatment.totalDue || 0;
                
                if (amount > due) {
                    showMessage(`ডিসকাউন্ট বকেয়ার বেশি হতে পারবে না! বকেয়া: ৳${due}`, 'error');
                    hideLoading();
                    return;
                }
                
                const discountLog = {
                    amount: amount,
                    date: new Date().toLocaleDateString('bn-BD')
                };
                
                const discountHistory = [...(treatment.discountHistory || []), discountLog];
                const newDiscount = (treatment.totalDiscount || 0) + amount;
                const newDue = due - amount;
                
                treatments[index] = {
                    ...treatment,
                    discountHistory,
                    totalDiscount: newDiscount,
                    totalDue: newDue
                };
                
                await patientRef.update({ treatments });
                
                showMessage(`✅ ৳${amount} ডিসকাউন্ট দেওয়া হয়েছে`, 'success');
                closeModal('discountModal');
                document.getElementById('discountAmount').value = '';
                
                await showProfile(currentPatient.id);
                
            } catch (err) {
                console.error('Discount error:', err);
                showMessage('ডিসকাউন্ট দিতে সমস্যা', 'error');
            } finally {
                hideLoading();
            }
        });

        // Message
        document.querySelectorAll('.message-option').forEach(opt => {
            opt.addEventListener('click', function() {
                document.querySelectorAll('.message-option').forEach(o => o.classList.remove('selected'));
                this.classList.add('selected');
                selectedMessageType = this.dataset.message;
                
                if (currentPatient) {
                    const name = currentPatient.data.name;
                    let msg = '';
                    
                    if (selectedMessageType === 'ক্যাপ') {
                        msg = `সম্মানিত ${name},\n\nআপনার ক্রাউন/ক্যাপ তৈরি হয়েছে। লাগানোর জন্য আসুন।\n\nচৌধুরী ডেন্টাল`;
                    } else if (selectedMessageType === 'শেষ') {
                        msg = `সম্মানিত ${name},\n\nআপনার চিকিৎসা সম্পন্ন হয়েছে। ধন্যবাদ।\n\nচৌধুরী ডেন্টাল`;
                    } else if (selectedMessageType === 'ডিউ') {
                        msg = `সম্মানিত ${name},\n\nআপনার চিকিৎসার কিছু টাকা বাকি আছে। পরিশোধ করে নিন।\n\nচৌধুরী ডেন্টাল`;
                    }
                    
                    document.getElementById('previewText').innerText = msg;
                }
            });
        });
        
        document.getElementById('sendMessageBtn').addEventListener('click', async () => {
            if (!currentPatient || !selectedMessageType) {
                showMessage('রোগী এবং মেসেজ টাইপ নির্বাচন করুন', 'warning');
                return;
            }
            
            const custom = document.getElementById('customMessage').value.trim();
            let msg = document.getElementById('previewText').innerText;
            
            if (custom) msg += '\n\n' + custom;
            
            const phone = currentPatient.data.phone;
            if (!phone || phone === '—') {
                showMessage('মোবাইল নম্বর নেই', 'error');
                return;
            }
            
            const cleanPhone = phone.replace(/\D/g, '');
            const url = `https://wa.me/${cleanPhone}?text=${encodeURIComponent(msg)}`;
            
            if (confirm('WhatsApp খুলবে?')) {
                window.open(url, '_blank');
                closeModal('messageModal');
            }
        });

        // Open Message Modal
        document.getElementById('openMessageModalBtn').addEventListener('click', () => {
            document.getElementById('messageModal').classList.add('active');
        });

        // Toggle Monthly Stats
        document.getElementById('toggleMonthlyStats').addEventListener('click', () => {
            document.getElementById('monthlyContent').classList.toggle('active');
            const icon = document.getElementById('toggleIcon');
            icon.classList.toggle('fa-chevron-down');
            icon.classList.toggle('fa-chevron-up');
        });

        // Filter Tabs
        document.querySelectorAll('.filter-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                currentFilter = this.dataset.filter;
                updateTreatmentHistory();
            });
        });

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            if (confirm('লগ আউট করবেন?')) {
                await auth.signOut();
                window.location.href = "log.html";
            }
        });

        // Check URL Params
        function checkUrlParams() {
            const params = new URLSearchParams(window.location.search);
            const edit = params.get('edit');
            const name = params.get('name');
            const phone = params.get('phone');
            const fromProfile = params.get('fromProfile');
            
            if (edit) {
                document.getElementById('editPatientId').value = edit;
                document.querySelector('[data-section="new"]').click();
            }
            
            if (name) document.getElementById('patientName').value = decodeURIComponent(name);
            if (phone) document.getElementById('patientPhone').value = phone;
            if (fromProfile) document.getElementById('fromProfileId').value = fromProfile;
            
            if (params.get('new') === 'true') {
                document.querySelector('[data-section="new"]').click();
            }
        }

        // Auth State
        auth.onAuthStateChanged((user) => {
            if (!user) {
                window.location.href = "log.html";
            } else {
                loadDashboardStats();
                loadRecentPatients();
                checkUrlParams();
            }
        });
    </script>
</body>
</html>