<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>‡¶∞‡ßã‡¶ó‡ßÄ ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ - ‡¶ö‡ßå‡¶ß‡ßÅ‡¶∞‡ßÄ ‡¶°‡ßá‡¶®‡ßç‡¶ü‡¶æ‡¶≤ ‡¶ï‡ßá‡¶Ø‡¶º‡¶æ‡¶∞</title>
    <!-- Fonts and Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+Bengali:wght@400;500;600;700&family=Hind+Siliguri:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
    // Firebase Config
    const firebaseConfig = {
        apiKey: "AIzaSyAxz46ug-CAywevI-PzmOp7ba5iiCK9dfM",
        authDomain: "plasma-raceway-465016-v0.firebaseapp.com",
        projectId: "plasma-raceway-465016-v0",
        storageBucket: "plasma-raceway-465016-v0.appspot.com",
        messagingSenderId: "23620370976",
        appId: "1:23620370976:web:3bb119ceb9e15608a33245"
    };

    // Firebase Initialization
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Hind Siliguri', 'Noto Serif Bengali', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary: #0a5c4b;
            --primary-dark: #064635;
            --primary-light: #e0f2e9;
            --success: #1e7e34;
            --success-dark: #146b2a;
            --success-light: #e8f5e9;
            --danger: #b22234;
            --danger-light: #ffebee;
            --warning: #bf8c2b;
            --warning-light: #fff8e1;
            --gray: #5a6b7a;
            --light-gray: #e9ecef;
            --dark: #2d3e50;
            --border-radius: 24px;
            --box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }

        body {
            background: #f8fafc;
            min-height: 100vh;
            padding: 16px;
            padding-top: calc(16px + var(--safe-top));
            padding-bottom: calc(80px + var(--safe-bottom));
        }

        /* ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶π‡ßá‡¶°‡¶æ‡¶∞ */
        .profile-header {
            background: linear-gradient(145deg, var(--primary), var(--primary-dark));
            color: white;
            border-radius: 28px;
            padding: 24px 20px;
            margin-bottom: 20px;
            box-shadow: 0 15px 25px rgba(6, 70, 53, 0.2);
            position: relative;
            overflow: hidden;
        }

        .profile-header::after {
            content: '';
            position: absolute;
            top: -50%;
            right: -20%;
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            border-radius: 50%;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .nav-btn {
            width: 44px;
            height: 44px;
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 16px;
            color: white;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            backdrop-filter: blur(10px);
        }

        .nav-btn:active {
            transform: scale(0.92);
            background: rgba(255,255,255,0.25);
        }

        .patient-name {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 15px;
            line-height: 1.3;
        }

        .info-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1rem;
            opacity: 0.95;
        }

        .info-item i {
            width: 24px;
            text-align: center;
            font-size: 1.1rem;
        }

        .patient-switcher {
            background: rgba(0,0,0,0.15);
            border-radius: 20px;
            padding: 12px 16px;
            margin-top: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
        }

        /* ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶∏ ‡¶ï‡¶æ‡¶∞‡ßç‡¶° */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 16px 8px;
            border-radius: 20px;
            text-align: center;
            box-shadow: var(--box-shadow);
            border-bottom: 4px solid var(--primary);
        }

        .stat-card.success { border-bottom-color: var(--success); }
        .stat-card.danger { border-bottom-color: var(--danger); }
        .stat-card.warning { border-bottom-color: var(--warning); }

        .stat-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--dark);
        }

        .stat-label {
            font-size: 0.7rem;
            color: var(--gray);
            margin-top: 4px;
        }

        /* ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶® ‡¶¨‡¶æ‡¶ü‡¶® */
        .action-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .action-btn {
            background: white;
            border: none;
            border-radius: 20px;
            padding: 16px 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            box-shadow: var(--box-shadow);
            cursor: pointer;
            transition: all 0.2s;
        }

        .action-btn:active {
            transform: scale(0.95);
        }

        .action-icon {
            width: 48px;
            height: 48px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.3rem;
        }

        .action-text {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--dark);
        }

        /* ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶¨‡¶æ‡¶ü‡¶® */
        .message-action-btn {
            background: linear-gradient(145deg, #4a6fa5, #3a5a8c);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 16px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            box-shadow: var(--box-shadow);
            cursor: pointer;
            width: 100%;
        }

        /* ‡¶™‡ßç‡¶∞‡ßá‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶™‡¶∂‡¶® ‡¶™‡ßç‡¶∞‡¶ø‡¶≠‡¶ø‡¶â ‡¶∏‡ßá‡¶ï‡¶∂‡¶® */
        .prescription-section {
            background: white;
            border-radius: 28px;
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: var(--box-shadow);
            border: 2px solid var(--primary-light);
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .section-header h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--primary);
            font-size: 1.2rem;
        }

        /* ‡¶á‡¶Æ‡ßá‡¶ú ‡¶ó‡ßç‡¶Ø‡¶æ‡¶≤‡¶æ‡¶∞‡¶ø */
        .image-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .gallery-item {
            position: relative;
            border-radius: 16px;
            overflow: hidden;
            border: 2px solid var(--primary-light);
            cursor: pointer;
            aspect-ratio: 1;
        }

        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s;
        }

        .gallery-item:hover img {
            transform: scale(1.1);
        }

        .gallery-item .overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(10, 92, 75, 0.8);
            color: white;
            padding: 5px;
            font-size: 0.7rem;
            text-align: center;
            transform: translateY(100%);
            transition: transform 0.3s;
        }

        .gallery-item:hover .overlay {
            transform: translateY(0);
        }

        .no-images {
            background: var(--light-gray);
            border-radius: 16px;
            padding: 30px;
            text-align: center;
            color: var(--gray);
        }

        .no-images i {
            font-size: 3rem;
            color: var(--primary-light);
            margin-bottom: 10px;
        }

        /* ‡¶™‡ßç‡¶∞‡ßá‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶™‡¶∂‡¶® ‡¶ï‡¶æ‡¶∞‡ßç‡¶° */
        .prescription-card {
            background: #f8fafc;
            border-radius: 20px;
            padding: 20px;
            border: 1px solid var(--light-gray);
            margin-top: 20px;
        }

        .prescription-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px dashed var(--primary);
        }

        .clinic-info {
            text-align: center;
        }

        .clinic-name-pres {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .prescription-date {
            background: var(--primary-light);
            padding: 8px 15px;
            border-radius: 30px;
            font-weight: 600;
        }

        .patient-info-pres {
            background: white;
            border-radius: 16px;
            padding: 15px;
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .info-item-pres {
            font-size: 0.95rem;
        }

        .info-label {
            color: var(--gray);
            font-size: 0.8rem;
        }

        .info-value {
            font-weight: 600;
            color: var(--dark);
        }

        .problems-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }

        .problems-table th {
            background: var(--primary-light);
            padding: 10px;
            text-align: center;
            font-size: 0.85rem;
            color: var(--primary-dark);
        }

        .problems-table td {
            padding: 12px 8px;
            border-bottom: 1px solid #dee2e6;
            font-size: 0.9rem;
        }

        .crown-badge {
            background: var(--warning-light);
            color: var(--warning);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            display: inline-block;
        }

        .total-pres {
            background: white;
            border-radius: 16px;
            padding: 15px;
            margin-top: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 700;
        }

        .grand-total {
            font-size: 1.4rem;
            color: var(--primary);
        }

        /* ‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶™‡¶∞‡¶ø‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ‡¶® */
        .monthly-stats {
            background: linear-gradient(145deg, #f8fafc, #f0f4f8);
            border-radius: 24px;
            margin-bottom: 24px;
            overflow: hidden;
        }

        .stats-header {
            background: var(--primary);
            color: white;
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .stats-content {
            padding: 0 20px;
            max-height: 0;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .stats-content.active {
            padding: 20px;
            max-height: 500px;
        }

        .monthly-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .month-card {
            background: white;
            padding: 15px;
            border-radius: 18px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        /* ‡¶ö‡¶ø‡¶ï‡¶ø‡ßé‡¶∏‡¶æ‡¶∞ ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏ */
        .history-section {
            background: white;
            border-radius: 28px;
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: var(--box-shadow);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary-dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .treatment-count {
            background: var(--primary-light);
            color: var(--primary);
            padding: 6px 16px;
            border-radius: 30px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .filter-tabs {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding-bottom: 8px;
            margin-bottom: 20px;
        }

        .filter-tab {
            padding: 8px 20px;
            border: 1.5px solid var(--light-gray);
            border-radius: 30px;
            background: white;
            color: var(--gray);
            font-weight: 500;
            white-space: nowrap;
            cursor: pointer;
        }

        .filter-tab.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .history-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
            max-height: 500px;
            overflow-y: auto;
        }

        .treatment-card {
            background: #f8fafc;
            border-radius: 20px;
            padding: 18px;
            border-left: 6px solid var(--primary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .treatment-card:hover {
            transform: translateX(5px);
            box-shadow: var(--box-shadow);
        }

        .treatment-card.paid { border-left-color: var(--success); background: var(--success-light); }
        .treatment-card.due { border-left-color: var(--danger); background: var(--danger-light); }
        .treatment-card.crown { border-left-color: var(--warning); background: var(--warning-light); }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .card-date {
            background: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            color: var(--gray);
        }

        .card-amount {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .problem-list {
            margin: 12px 0;
        }

        .problem-item {
            background: white;
            border-radius: 14px;
            padding: 12px;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .problem-name {
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 4px;
        }

        .problem-detail {
            display: flex;
            justify-content: space-between;
            color: var(--gray);
            font-size: 0.85rem;
        }

        .crown-info {
            background: var(--warning-light);
            padding: 8px;
            border-radius: 10px;
            margin-top: 8px;
            font-size: 0.85rem;
        }

        .payment-log {
            background: white;
            border-radius: 14px;
            padding: 12px;
            margin-top: 12px;
        }

        .log-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px dashed #dee2e6;
        }

        /* ‡¶Æ‡ßã‡¶°‡¶æ‡¶≤ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            backdrop-filter: blur(5px);
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 32px;
            width: 100%;
            max-width: 500px;
            max-height: 85vh;
            overflow-y: auto;
            padding: 28px;
        }

        .modal-title {
            font-size: 1.5rem;
            color: var(--primary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* ‡¶´‡¶∞‡ßç‡¶Æ ‡¶ó‡ßç‡¶∞‡ßÅ‡¶™ - ‡¶†‡¶ø‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
            font-size: 0.95rem;
        }

        .form-control {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--light-gray);
            border-radius: 16px;
            font-size: 1rem;
            transition: all 0.2s;
            background: white;
        }

        .form-control:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 4px rgba(10, 92, 75, 0.1);
        }

        select.form-control {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23333' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 16px;
        }

        textarea.form-control {
            resize: vertical;
            min-height: 100px;
        }

        .message-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }

        .message-option {
            background: var(--primary-light);
            border: 2px solid transparent;
            border-radius: 18px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .message-option.selected {
            border-color: var(--primary);
            background: white;
            box-shadow: 0 5px 15px rgba(10, 92, 75, 0.1);
        }

        .message-preview {
            background: #f8fafc;
            border-radius: 16px;
            padding: 16px;
            margin: 15px 0;
            border-left: 4px solid var(--primary);
            font-size: 0.95rem;
            line-height: 1.6;
            color: var(--dark);
            white-space: pre-line;
            max-height: 300px;
            overflow-y: auto;
        }

        .btn {
            padding: 16px;
            border: none;
            border-radius: 18px;
            font-weight: 700;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            cursor: pointer;
            width: 100%;
        }

        .btn-primary { background: linear-gradient(145deg, var(--primary), var(--primary-dark)); color: white; }
        .btn-success { background: linear-gradient(145deg, var(--success), var(--success-dark)); color: white; }
        .btn-danger { background: linear-gradient(145deg, var(--danger), #8b1a1a); color: white; }
        .btn-info { background: linear-gradient(145deg, #4a6fa5, #3a5a8c); color: white; }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            justify-content: space-around;
            padding: 12px 16px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.08);
            border-radius: 30px 30px 0 0;
            padding-bottom: calc(12px + var(--safe-bottom));
            z-index: 100;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: var(--gray);
            font-size: 0.7rem;
            gap: 4px;
        }

        .nav-item.active { color: var(--primary); }
        .nav-icon { font-size: 1.3rem; }

        .auth-loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #f8fafc;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.3s;
        }
        
        .auth-loading.fade-out {
            opacity: 0;
            pointer-events: none;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--primary-light);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* ‡¶á‡¶Æ‡ßá‡¶ú ‡¶≠‡¶ø‡¶â‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶Æ‡ßã‡¶°‡¶æ‡¶≤ */
        .image-viewer-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 20px;
        }

        .image-viewer-modal.active {
            display: flex;
        }

        .image-viewer-content {
            position: relative;
            max-width: 90%;
            max-height: 90%;
        }

        .image-viewer-content img {
            max-width: 100%;
            max-height: 90vh;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
        }

        .close-viewer {
            position: absolute;
            top: -40px;
            right: 0;
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-viewer:hover {
            background: rgba(255,255,255,0.3);
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--gray);
        }

        .message-box {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            padding: 16px;
            border-radius: 18px;
            color: white;
            font-weight: 600;
            z-index: 2000;
            animation: slideDown 0.3s;
            text-align: center;
        }

        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 480px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .action-grid { grid-template-columns: repeat(2, 1fr); }
            .monthly-grid { grid-template-columns: 1fr; }
            .patient-info-pres { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div id="authLoading" class="auth-loading">
        <div class="loading-spinner"></div>
    </div>

    <div id="messageContainer"></div>

    <!-- ‡¶á‡¶Æ‡ßá‡¶ú ‡¶≠‡¶ø‡¶â‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶Æ‡ßã‡¶°‡¶æ‡¶≤ -->
    <div class="image-viewer-modal" id="imageViewerModal" onclick="if(event.target===this) this.classList.remove('active')">
        <div class="image-viewer-content">
            <button class="close-viewer" onclick="document.getElementById('imageViewerModal').classList.remove('active')">
                <i class="fas fa-times"></i>
            </button>
            <img id="viewerImage" src="" alt="">
        </div>
    </div>

    <!-- ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶π‡ßá‡¶°‡¶æ‡¶∞ -->
    <div class="profile-header">
        <div class="header-top">
            <button class="nav-btn" id="backBtn"><i class="fas fa-arrow-left"></i></button>
            <button class="nav-btn" id="homeBtn"><i class="fas fa-home"></i></button>
        </div>
        
        <h1 class="patient-name" id="patientName">‚Äî</h1>
        
        <div class="info-grid">
            <div class="info-item"><i class="fas fa-phone-alt"></i> <span id="patientPhone">‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤: ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</span></div>
            <div class="info-item"><i class="fas fa-map-marker-alt"></i> <span id="patientAddress">‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ: ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</span></div>
            <div class="info-item"><i class="fas fa-calendar-alt"></i> <span id="patientAge">‡¶¨‡¶Ø‡¶º‡¶∏: ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</span></div>
            <div class="info-item"><i class="fas fa-venus-mars"></i> <span id="patientGender">‡¶≤‡¶ø‡¶ô‡ßç‡¶ó: ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</span></div>
        </div>
        
        <div class="patient-switcher" id="patientSwitcher" style="display: none;">
            <div class="patient-count"><i class="fas fa-users"></i> <span id="patientCount">‡ßß/‡ßß</span></div>
            <button class="switch-btn" id="switchPatientBtn"><i class="fas fa-exchange-alt"></i> ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®</button>
        </div>
    </div>

    <!-- ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶∏ ‡¶ï‡¶æ‡¶∞‡ßç‡¶° -->
    <div class="stats-grid">
        <div class="stat-card"><div class="stat-value" id="totalBill">‡ß≥‡ß¶</div><div class="stat-label">‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ø‡¶≤</div></div>
        <div class="stat-card success"><div class="stat-value" id="totalPaid">‡ß≥‡ß¶</div><div class="stat-label">‡¶ú‡¶Æ‡¶æ</div></div>
        <div class="stat-card danger"><div class="stat-value" id="totalDue">‡ß≥‡ß¶</div><div class="stat-label">‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ</div></div>
        <div class="stat-card warning"><div class="stat-value" id="totalTreatments">‡ß¶</div><div class="stat-label">‡¶ö‡¶ø‡¶ï‡¶ø‡ßé‡¶∏‡¶æ</div></div>
    </div>

    <!-- ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶® ‡¶¨‡¶æ‡¶ü‡¶® -->
    <div class="action-grid">
        <button class="action-btn" id="addPaymentBtn">
            <div class="action-icon" style="background: linear-gradient(145deg, #1e7e34, #0f5922);"><i class="fas fa-coins"></i></div>
            <span class="action-text">‡¶ü‡¶æ‡¶ï‡¶æ ‡¶ú‡¶Æ‡¶æ</span>
        </button>
        <button class="action-btn" id="addTreatmentBtn">
            <div class="action-icon" style="background: linear-gradient(145deg, #0a5c4b, #064635);"><i class="fas fa-tooth"></i></div>
            <span class="action-text">‡¶®‡¶§‡ßÅ‡¶® ‡¶ö‡¶ø‡¶ï‡¶ø‡ßé‡¶∏‡¶æ</span>
        </button>
        <button class="action-btn" id="editPatientBtn">
            <div class="action-icon" style="background: linear-gradient(145deg, #bf8c2b, #9e7627);"><i class="fas fa-user-edit"></i></div>
            <span class="action-text">‡¶§‡¶•‡ßç‡¶Ø ‡¶∏‡¶Æ‡ßç‡¶™‡¶æ‡¶¶‡¶®‡¶æ</span>
        </button>
        <button class="action-btn" id="discountBtn">
            <div class="action-icon" style="background: linear-gradient(145deg, #dc3545, #b02a37);"><i class="fas fa-percentage"></i></div>
            <span class="action-text">‡¶°‡¶ø‡¶∏‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü</span>
        </button>
    </div>

    <!-- ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶¨‡¶æ‡¶ü‡¶® -->
    <button class="message-action-btn" id="openMessageModalBtn">
        <i class="fas fa-comment-dots"></i>
        <span>‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶™‡¶æ‡¶†‡¶æ‡¶®</span>
        <i class="fas fa-chevron-right"></i>
    </button>

    <!-- ‡¶™‡ßç‡¶∞‡ßá‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶™‡¶∂‡¶® ‡¶∏‡ßá‡¶ï‡¶∂‡¶® - ‡¶á‡¶Æ‡ßá‡¶ú ‡¶ó‡ßç‡¶Ø‡¶æ‡¶≤‡¶æ‡¶∞‡¶ø ‡¶∏‡¶π -->
    <div class="prescription-section" id="prescriptionSection">
        <div class="section-header">
            <h3><i class="fas fa-prescription"></i> ‡¶™‡ßç‡¶∞‡ßá‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶™‡¶∂‡¶®</h3>
            <span class="treatment-count" id="imageCount">‡ß¶ ‡¶ü‡¶ø ‡¶õ‡¶¨‡¶ø</span>
        </div>
        
        <!-- ‡¶á‡¶Æ‡ßá‡¶ú ‡¶ó‡ßç‡¶Ø‡¶æ‡¶≤‡¶æ‡¶∞‡¶ø -->
        <div id="imageGallery" class="image-gallery">
            <div class="no-images">
                <i class="fas fa-images"></i>
                <p>‡¶ï‡ßã‡¶®‡ßã ‡¶õ‡¶¨‡¶ø ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡¶®‡¶ø</p>
            </div>
        </div>
        
        <!-- ‡¶™‡ßç‡¶∞‡ßá‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶™‡¶∂‡¶® ‡¶°‡¶ø‡¶ü‡ßá‡¶≤‡¶∏ -->
        <div class="prescription-card" id="prescriptionCard">
            <!-- ‡¶™‡ßç‡¶∞‡ßá‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶™‡¶∂‡¶® ‡¶°‡¶æ‡¶á‡¶®‡¶æ‡¶Æ‡¶ø‡¶ï‡¶≠‡¶æ‡¶¨‡ßá ‡¶≤‡ßã‡¶° ‡¶π‡¶¨‡ßá -->
        </div>
    </div>

    <!-- ‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶™‡¶∞‡¶ø‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ‡¶® -->
    <div class="monthly-stats" id="monthlyStats">
        <div class="stats-header" id="toggleMonthlyStats">
            <h3><i class="fas fa-chart-line"></i> ‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶™‡¶∞‡¶ø‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ‡¶®</h3>
            <i class="fas fa-chevron-down" id="toggleIcon"></i>
        </div>
        <div class="stats-content" id="monthlyContent">
            <div class="monthly-grid" id="monthlyData"></div>
        </div>
    </div>

    <!-- ‡¶ö‡¶ø‡¶ï‡¶ø‡ßé‡¶∏‡¶æ‡¶∞ ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏ -->
    <div class="history-section">
        <div class="section-header">
            <div class="section-title"><i class="fas fa-notes-medical"></i> ‡¶ö‡¶ø‡¶ï‡¶ø‡ßé‡¶∏‡¶æ‡¶∞ ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏</div>
            <span class="treatment-count" id="historyCount">‡ß¶ ‡¶ü‡¶ø</span>
        </div>

        <div class="filter-tabs" id="filterTabs">
            <button class="filter-tab active" data-filter="all">‡¶∏‡¶ï‡¶≤</button>
            <button class="filter-tab" data-filter="due">‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ</button>
            <button class="filter-tab" data-filter="paid">‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß‡¶ø‡¶§</button>
            <button class="filter-tab" data-filter="crown">‡¶ï‡ßç‡¶∞‡¶æ‡¶â‡¶®</button>
        </div>

        <div class="history-list" id="treatmentHistory">
            <div class="empty-state"><i class="fas fa-spinner fa-spin fa-2x"></i><p>‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p></div>
        </div>
    </div>

    <!-- ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶Æ‡ßã‡¶°‡¶æ‡¶≤ - ‡¶†‡¶ø‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá -->
    <div class="modal" id="paymentModal">
        <div class="modal-content">
            <h2 class="modal-title"><i class="fas fa-hand-holding-usd"></i> ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶ú‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶®</h2>
            <form id="paymentForm">
                <div class="form-group">
                    <label>‡¶ü‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ (‡ß≥)</label>
                    <input type="number" id="paymentAmount" class="form-control" placeholder="‡¶Ø‡ßá‡¶Æ‡¶®: ‡ß´‡ß¶‡ß¶" min="1" required>
                </div>
                <div class="form-group">
                    <label>‡¶®‡ßã‡¶ü / ‡¶Æ‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø</label>
                    <textarea id="paymentNotes" class="form-control" rows="3" placeholder="‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï..."></textarea>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-success" style="flex: 2;">‡¶ú‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶®</button>
                    <button type="button" class="btn btn-danger" style="flex: 1;" onclick="window.closeModal('paymentModal')">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ‡¶°‡¶ø‡¶∏‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶Æ‡ßã‡¶°‡¶æ‡¶≤ - ‡¶†‡¶ø‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá -->
    <div class="modal" id="discountModal">
        <div class="modal-content">
            <h2 class="modal-title"><i class="fas fa-percentage"></i> ‡¶°‡¶ø‡¶∏‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶¶‡¶ø‡¶®</h2>
            <form id="discountForm">
                <div class="form-group">
                    <label>‡¶ö‡¶ø‡¶ï‡¶ø‡ßé‡¶∏‡¶æ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</label>
                    <select id="treatmentSelect" class="form-control" required>
                        <option value="">‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>‡¶°‡¶ø‡¶∏‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü‡ßá‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ (‡ß≥)</label>
                    <input type="number" id="discountAmount" class="form-control" placeholder="‡¶Ø‡ßá‡¶Æ‡¶®: ‡ß®‡ß¶‡ß¶" min="1" required>
                </div>
                <div style="background: var(--warning-light); border-radius: 16px; padding: 12px; margin: 15px 0;">
                    <p style="color: var(--warning); font-size: 0.9rem;">
                        <i class="fas fa-info-circle"></i> ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ ‡¶•‡¶æ‡¶ï‡¶æ ‡¶ö‡¶ø‡¶ï‡¶ø‡ßé‡¶∏‡¶æ‡¶Ø‡¶º ‡¶°‡¶ø‡¶∏‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶¶‡ßá‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá
                    </p>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary" style="flex: 2;">‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                    <button type="button" class="btn btn-danger" style="flex: 1;" onclick="window.closeModal('discountModal')">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶Æ‡ßã‡¶°‡¶æ‡¶≤ - ‡¶†‡¶ø‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá -->
    <div class="modal" id="messageModal">
        <div class="modal-content">
            <h2 class="modal-title"><i class="fas fa-comment-dots"></i> ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶™‡¶æ‡¶†‡¶æ‡¶®</h2>
            
            <div class="message-options" id="messageOptions">
                <div class="message-option" data-message="‡¶ï‡ßç‡¶Ø‡¶æ‡¶™">
                    <div class="message-option-icon"><i class="fas fa-crown"></i></div>
                    <div>
                        <div class="message-option-text">‡¶ï‡ßç‡¶∞‡¶æ‡¶â‡¶®/‡¶ï‡ßç‡¶Ø‡¶æ‡¶™ ‡¶§‡ßà‡¶∞‡¶ø ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá</div>
                        <div class="message-option-desc">‡¶∞‡ßã‡¶ó‡ßÄ‡¶∞ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶™ ‡¶§‡ßà‡¶∞‡¶ø ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá, ‡¶≤‡¶æ‡¶ó‡¶æ‡¶®‡ßã‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ü‡¶∏‡¶§‡ßá ‡¶π‡¶¨‡ßá</div>
                    </div>
                </div>
                <div class="message-option" data-message="‡¶∂‡ßá‡¶∑">
                    <div class="message-option-icon"><i class="fas fa-check-circle"></i></div>
                    <div>
                        <div class="message-option-text">‡¶ö‡¶ø‡¶ï‡¶ø‡ßé‡¶∏‡¶æ ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶ì ‡¶¨‡¶ø‡¶≤ ‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß</div>
                        <div class="message-option-desc">‡¶∏‡¶ï‡¶≤ ‡¶ö‡¶ø‡¶ï‡¶ø‡ßé‡¶∏‡¶æ ‡¶∂‡ßá‡¶∑ ‡¶è‡¶¨‡¶Ç ‡¶¨‡¶ø‡¶≤ ‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶®</div>
                    </div>
                </div>
                <div class="message-option" data-message="‡¶°‡¶ø‡¶â">
                    <div class="message-option-icon"><i class="fas fa-exclamation-triangle"></i></div>
                    <div>
                        <div class="message-option-text">‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ ‡¶ü‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø</div>
                        <div class="message-option-desc">‡¶ö‡¶ø‡¶ï‡¶ø‡ßé‡¶∏‡¶æ‡¶∞ ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ ‡¶ü‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</div>
                    </div>
                </div>
            </div>

            <div class="message-preview" id="messagePreview">
                <div class="message-preview-title"><i class="fas fa-eye"></i> ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶™‡ßç‡¶∞‡¶ø‡¶≠‡¶ø‡¶â:</div>
                <div id="previewText">‡¶è‡¶ï‡¶ü‡¶ø ‡¶Ö‡¶™‡¶∂‡¶® ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</div>
            </div>

            <div class="form-group">
                <label>‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡¶§‡¶ø‡¶∞‡¶ø‡¶ï‡ßç‡¶§ ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï)</label>
                <textarea id="customMessage" class="form-control" rows="3" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡¶§‡¶ø‡¶∞‡¶ø‡¶ï‡ßç‡¶§ ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..."></textarea>
            </div>

            <div style="display: flex; gap: 10px;">
                <button class="btn btn-info" id="sendMessageBtn" style="flex: 2;">
                    <i class="fas fa-paper-plane"></i> ‡¶™‡¶æ‡¶†‡¶æ‡¶®
                </button>
                <button class="btn btn-danger" style="flex: 1;" onclick="window.closeModal('messageModal')">
                    ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤
                </button>
            </div>
        </div>
    </div>

    <!-- ‡¶®‡¶ø‡¶ö‡ßá‡¶∞ ‡¶®‡ßá‡¶≠‡¶ø‡¶ó‡ßá‡¶∂‡¶® -->
    <nav class="bottom-nav">
        <a href="amarghor.html" class="nav-item"><i class="fas fa-home nav-icon"></i><span>‡¶π‡ßã‡¶Æ</span></a>
        <a href="#" class="nav-item active"><i class="fas fa-user nav-icon"></i><span>‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤</span></a>
        <a href="amarghor.html?new=true" class="nav-item"><i class="fas fa-plus-circle nav-icon"></i><span>‡¶®‡¶§‡ßÅ‡¶®</span></a>
        <a href="#" class="nav-item" id="searchNav"><i class="fas fa-search nav-icon"></i><span>‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®</span></a>
    </nav>
   
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { 
            getFirestore,
            collection, 
            doc, 
            setDoc, 
            getDoc, 
            getDocs,
            updateDoc, 
            query,
            orderBy,
            where
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase initialize
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global Variables
        window.closeModal = function(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.classList.remove('active');
        };

        let currentPatient = null;
        let allPatientsWithSamePhone = [];
        let currentPatientIndex = 0;
        let allTreatments = [];
        let currentFilter = 'all';
        let selectedMessageType = '';

        // Loading functions
        function showLoading() {
            const loader = document.getElementById('authLoading');
            if (loader) {
                loader.style.display = 'flex';
                loader.classList.remove('fade-out');
            }
        }

        function hideLoading() {
            const loader = document.getElementById('authLoading');
            if (loader) {
                loader.classList.add('fade-out');
                setTimeout(() => {
                    loader.style.display = 'none';
                }, 300);
            }
        }

        // Message function
        function showMessage(msg, type = 'info') {
            const container = document.getElementById('messageContainer');
            if (!container) return;
            
            const msgDiv = document.createElement('div');
            msgDiv.className = `message-box message-${type}`;
            msgDiv.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i> ${msg}`;
            container.appendChild(msgDiv);
            setTimeout(() => msgDiv.remove(), 3500);
        }

        // ‡¶á‡¶Æ‡ßá‡¶ú ‡¶≠‡¶ø‡¶â‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
        window.viewImage = function(imageUrl) {
            const viewer = document.getElementById('imageViewerModal');
            const img = document.getElementById('viewerImage');
            if (viewer && img) {
                img.src = imageUrl;
                viewer.classList.add('active');
            }
        };

        // Generate Message - ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶∞‡ßã‡¶ó‡ßÄ‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶Ø‡ßã‡¶ó ‡¶π‡¶¨‡ßá
        function generateMessage(type, patientData, treatments) {
            const patientName = patientData?.name || '‡¶≠‡¶æ‡¶≤‡ßã‡¶¨‡¶æ‡¶∏‡¶æ‡¶∞ ‡¶∞‡ßã‡¶ó‡ßÄ';
            
            let message = '';

            switch(type) {
                case '‡¶ï‡ßç‡¶Ø‡¶æ‡¶™':
                    message = `‡¶∏‡¶Æ‡ßç‡¶Æ‡¶æ‡¶®‡¶ø‡¶§ ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ${patientName},\n\n‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ï‡ßç‡¶∞‡¶æ‡¶â‡¶®/‡¶ï‡ßç‡¶Ø‡¶æ‡¶™‡¶ü‡¶ø‡¶∞ ‡¶ï‡¶æ‡¶ú ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶∏‡ßÅ‡¶¨‡¶ø‡¶ß‡¶æ‡¶Æ‡¶§ ‡¶∏‡¶Æ‡¶Ø‡¶º‡ßá ‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶ö‡ßá‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞‡ßá ‡¶è‡¶∏‡ßá ‡¶∏‡ßá‡¶ü‡¶ø ‡¶≤‡¶æ‡¶ó‡¶ø‡¶Ø‡¶º‡ßá ‡¶®‡¶ø‡¶Ø‡¶º‡ßá ‡¶Ø‡¶æ‡¶®‡•§\n\n‡¶ß‡¶®‡ßç‡¶Ø‡¶¨‡¶æ‡¶¶\n‡¶ö‡ßå‡¶ß‡ßÅ‡¶∞‡ßÄ ‡¶°‡ßá‡¶®‡ßç‡¶ü‡¶æ‡¶≤ ‡¶ï‡ßá‡¶Ø‡¶º‡¶æ‡¶∞`;
                    break;

                case '‡¶∂‡ßá‡¶∑':
                    message = `‡¶∏‡¶Æ‡ßç‡¶Æ‡¶æ‡¶®‡¶ø‡¶§ ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ${patientName},\n\n‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∏‡¶ï‡¶≤ ‡¶ö‡¶ø‡¶ï‡¶ø‡ßé‡¶∏‡¶æ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶ì‡¶™‡¶∞ ‡¶Ü‡¶∏‡ßç‡¶•‡¶æ ‡¶∞‡¶æ‡¶ñ‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ß‡¶®‡ßç‡¶Ø‡¶¨‡¶æ‡¶¶‡•§\n\n‡¶ß‡¶®‡ßç‡¶Ø‡¶¨‡¶æ‡¶¶\n‡¶ö‡ßå‡¶ß‡ßÅ‡¶∞‡ßÄ ‡¶°‡ßá‡¶®‡ßç‡¶ü‡¶æ‡¶≤ ‡¶ï‡ßá‡¶Ø‡¶º‡¶æ‡¶∞`;
                    break;

                case '‡¶°‡¶ø‡¶â':
                    message = `‡¶∏‡¶Æ‡ßç‡¶Æ‡¶æ‡¶®‡¶ø‡¶§ ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ${patientName},\n\n‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ö‡¶ø‡¶ï‡¶ø‡ßé‡¶∏‡¶æ‡¶∞ ‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶Ü‡¶õ‡ßá‡•§ ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶∏‡ßÅ‡¶¨‡¶ø‡¶ß‡¶æ‡¶Æ‡¶§ ‡¶∏‡¶Æ‡¶Ø‡¶º‡ßá ‡¶è‡¶∏‡ßá ‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß ‡¶ï‡¶∞‡ßá ‡¶ö‡¶ø‡¶ï‡¶ø‡ßé‡¶∏‡¶æ ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§\n\n‡¶ß‡¶®‡ßç‡¶Ø‡¶¨‡¶æ‡¶¶\n‡¶ö‡ßå‡¶ß‡ßÅ‡¶∞‡ßÄ ‡¶°‡ßá‡¶®‡ßç‡¶ü‡¶æ‡¶≤ ‡¶ï‡ßá‡¶Ø‡¶º‡¶æ‡¶∞`;
                    break;

                default:
                    message = '‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶ü‡¶æ‡¶á‡¶™ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®';
            }

            return message;
        }

        // Send Message
        async function sendMessage() {
            if (!currentPatient) {
                showMessage('‡¶∞‡ßã‡¶ó‡ßÄ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡¶®‡¶ø', 'error');
                return;
            }

            if (!selectedMessageType) {
                showMessage('‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶ü‡¶æ‡¶á‡¶™ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®', 'warning');
                return;
            }

            const customText = document.getElementById('customMessage')?.value.trim() || '';
            let messageText = generateMessage(selectedMessageType, currentPatient.data, allTreatments);

            if (customText) {
                messageText = messageText + '\n\n' + customText;
            }

            const patientPhone = currentPatient.data.phone;
            
            if (!patientPhone || patientPhone === '‚Äî') {
                showMessage('‡¶∞‡ßã‡¶ó‡ßÄ‡¶∞ ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶®‡ßá‡¶á!', 'error');
                return;
            }

            const cleanPhone = patientPhone.replace(/\D/g, '');
            if (cleanPhone.length < 11) {
                showMessage('‡¶∏‡¶†‡¶ø‡¶ï ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶®‡¶Ø‡¶º!', 'error');
                return;
            }
            
            const messagePreview = encodeURIComponent(messageText);
            const whatsappUrl = `https://wa.me/${cleanPhone}?text=${messagePreview}`;
            
            const action = confirm('‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø WhatsApp ‡¶è ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶™‡¶æ‡¶†‡¶æ‡¶§‡ßá ‡¶ö‡¶æ‡¶®?\n"OK" ‡¶ö‡¶æ‡¶™‡¶≤‡ßá WhatsApp ‡¶ñ‡ßÅ‡¶≤‡¶¨‡ßá,\n"Cancel" ‡¶ö‡¶æ‡¶™‡¶≤‡ßá ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶ï‡¶™‡¶ø ‡¶π‡¶¨‡ßá‡•§');
            
            if (action) {
                window.open(whatsappUrl, '_blank');
                closeModal('messageModal');
            } else {
                try {
                    await navigator.clipboard.writeText(messageText);
                    showMessage('üìã ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶ï‡¶™‡¶ø ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá! ‡¶è‡¶ñ‡¶® ‡¶Ü‡¶™‡¶®‡¶ø ‡¶Ø‡ßá‡¶ï‡ßã‡¶®‡ßã ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡ßá ‡¶™‡ßá‡¶∏‡ßç‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®‡•§', 'success');
                    closeModal('messageModal');
                } catch (err) {
                    showMessage('‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ!', 'error');
                }
            }
        }

        // Process Payment
        async function processPayment(e) {
            e.preventDefault();
            
            const amount = parseFloat(document.getElementById('paymentAmount').value);
            const notes = document.getElementById('paymentNotes').value.trim();
            
            if (!amount || amount <= 0) {
                showMessage('‡¶∏‡¶†‡¶ø‡¶ï ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶¶‡¶ø‡¶®', 'error');
                return;
            }
            
            if (!currentPatient) {
                showMessage('‡¶∞‡ßã‡¶ó‡ßÄ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡¶®‡¶ø', 'error');
                return;
            }
            
            try {
                showLoading();
                
                const patientRef = doc(db, "patients", currentPatient.id);
                const patientSnap = await getDoc(patientRef);
                
                if (!patientSnap.exists()) {
                    showMessage('‡¶∞‡ßã‡¶ó‡ßÄ‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø', 'error');
                    return;
                }
                
                const patientData = patientSnap.data();
                let treatments = patientData.treatments || [];
                
                // Calculate total due
                let totalDue = 0;
                treatments.forEach(t => {
                    const bill = t.bill || (t.problems ? t.problems.reduce((sum, p) => sum + (parseFloat(p.cost) || 0), 0) : 0);
                    let paid = 0;
                    if (t.paymentHistory && t.paymentHistory.length) {
                        paid = t.paymentHistory.reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);
                    } else {
                        paid = parseFloat(t.paid || 0);
                    }
                    let discount = 0;
                    if (t.discountHistory && t.discountHistory.length) {
                        discount = t.discountHistory.reduce((sum, d) => sum + (parseFloat(d.amount) || 0), 0);
                    } else {
                        discount = parseFloat(t.discount || 0);
                    }
                    const due = Math.max(0, bill - (paid + discount));
                    totalDue += due;
                });
                
                if (totalDue <= 0) {
                    showMessage('‡¶è‡¶á ‡¶∞‡ßã‡¶ó‡ßÄ‡¶∞ ‡¶ï‡ßã‡¶®‡ßã ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ ‡¶®‡ßá‡¶á!', 'warning');
                    hideLoading();
                    closeModal('paymentModal');
                    return;
                }
                
                if (amount > totalDue) {
                    showMessage(`‡¶Ü‡¶™‡¶®‡¶ø ‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶ö‡ßá‡¶Ø‡¶º‡ßá ‡¶¨‡ßá‡¶∂‡¶ø ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶¶‡¶ø‡¶§‡ßá ‡¶ö‡¶æ‡¶ö‡ßç‡¶õ‡ßá‡¶®! ‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ: ‡ß≥${totalDue}`, 'error');
                    hideLoading();
                    return;
                }
                
                let remainingAmount = amount;
                
                const updatedTreatments = treatments.map(treatment => {
                    if (remainingAmount <= 0) return treatment;
                    
                    const currentBill = treatment.bill || (treatment.problems ? treatment.problems.reduce((sum, p) => sum + (parseFloat(p.cost) || 0), 0) : 0);
                    
                    let currentPaid = 0;
                    if (treatment.paymentHistory && treatment.paymentHistory.length) {
                        currentPaid = treatment.paymentHistory.reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);
                    } else {
                        currentPaid = parseFloat(treatment.paid || 0);
                    }
                    
                    let currentDiscount = 0;
                    if (treatment.discountHistory && treatment.discountHistory.length) {
                        currentDiscount = treatment.discountHistory.reduce((sum, d) => sum + (parseFloat(d.amount) || 0), 0);
                    } else {
                        currentDiscount = parseFloat(treatment.discount || 0);
                    }
                    
                    const currentDue = Math.max(0, currentBill - (currentPaid + currentDiscount));
                    
                    if (currentDue <= 0) return treatment;
                    
                    const paymentForThis = Math.min(remainingAmount, currentDue);
                    remainingAmount -= paymentForThis;
                    
                    const paymentLog = {
                        amount: paymentForThis,
                        date: new Date().toLocaleDateString('bn-BD'),
                        time: new Date().toLocaleTimeString('bn-BD'),
                        notes: notes || '‡¶ü‡¶æ‡¶ï‡¶æ ‡¶ú‡¶Æ‡¶æ',
                        timestamp: new Date().toISOString()
                    };
                    
                    const paymentHistory = [...(treatment.paymentHistory || []), paymentLog];
                    
                    return {
                        ...treatment,
                        paymentHistory: paymentHistory,
                        due: currentDue - paymentForThis
                    };
                });
                
                await updateDoc(patientRef, { 
                    treatments: updatedTreatments,
                    lastUpdated: new Date().toISOString(),
                    lastPayment: {
                        amount: amount,
                        date: new Date().toISOString(),
                        notes: notes
                    }
                });
                
                showMessage(`‚úÖ ‡ß≥${amount} ‡¶ú‡¶Æ‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá`, 'success');
                closeModal('paymentModal');
                document.getElementById('paymentForm').reset();
                
                await loadPatientsByPhone(currentPatient.data.phone, currentPatient.id);
                
            } catch (error) {
                console.error("Payment error:", error);
                showMessage('‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶®‡¶ø‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ! ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // Apply Discount
        async function applyDiscount(e) {
            e.preventDefault();
            
            const treatmentIndex = parseInt(document.getElementById('treatmentSelect').value);
            const discount = parseFloat(document.getElementById('discountAmount').value);
            
            if (isNaN(treatmentIndex) || !discount || discount <= 0) {
                showMessage('‡¶∏‡¶¨ ‡¶§‡¶•‡ßç‡¶Ø ‡¶¶‡¶ø‡¶®', 'error');
                return;
            }
            
            if (!currentPatient) {
                showMessage('‡¶∞‡ßã‡¶ó‡ßÄ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡¶®‡¶ø', 'error');
                return;
            }
            
            try {
                showLoading();
                
                const patientRef = doc(db, "patients", currentPatient.id);
                const patientSnap = await getDoc(patientRef);
                
                if (!patientSnap.exists()) {
                    showMessage('‡¶∞‡ßã‡¶ó‡ßÄ‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø', 'error');
                    return;
                }
                
                const patientData = patientSnap.data();
                const treatments = patientData.treatments || [];
                
                if (treatmentIndex >= treatments.length) {
                    showMessage('‡¶≠‡ßÅ‡¶≤ ‡¶ö‡¶ø‡¶ï‡¶ø‡ßé‡¶∏‡¶æ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶®', 'error');
                    return;
                }
                
                const treatment = treatments[treatmentIndex];
                
                const currentBill = treatment.bill || (treatment.problems ? treatment.problems.reduce((sum, p) => sum + (parseFloat(p.cost) || 0), 0) : 0);
                
                let currentPaid = 0;
                if (treatment.paymentHistory && treatment.paymentHistory.length) {
                    currentPaid = treatment.paymentHistory.reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);
                } else {
                    currentPaid = parseFloat(treatment.paid || 0);
                }
                
                let currentDiscount = 0;
                if (treatment.discountHistory && treatment.discountHistory.length) {
                    currentDiscount = treatment.discountHistory.reduce((sum, d) => sum + (parseFloat(d.amount) || 0), 0);
                } else {
                    currentDiscount = parseFloat(treatment.discount || 0);
                }
                
                const currentDue = Math.max(0, currentBill - (currentPaid + currentDiscount));
                
                if (currentDue <= 0) {
                    showMessage('‡¶è‡¶á ‡¶ö‡¶ø‡¶ï‡¶ø‡ßé‡¶∏‡¶æ‡¶∞ ‡¶ï‡ßã‡¶®‡ßã ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ ‡¶®‡ßá‡¶á!', 'warning');
                    hideLoading();
                    return;
                }
                
                if (discount > currentDue) {
                    showMessage(`‡¶°‡¶ø‡¶∏‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶¨‡ßá‡¶∂‡¶ø ‡¶π‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá ‡¶®‡¶æ! ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ: ‡ß≥${currentDue}`, 'error');
                    return;
                }
                
                const discountLog = {
                    amount: discount,
                    date: new Date().toLocaleDateString('bn-BD'),
                    time: new Date().toLocaleTimeString('bn-BD'),
                    type: '‡¶°‡¶ø‡¶∏‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü',
                    timestamp: new Date().toISOString()
                };
                
                const discountHistory = [...(treatment.discountHistory || []), discountLog];
                
                const updatedTreatments = treatments.map((t, idx) => {
                    if (idx === treatmentIndex) {
                        return { 
                            ...t, 
                            discountHistory: discountHistory,
                            due: currentDue - discount
                        };
                    }
                    return t;
                });
                
                await updateDoc(patientRef, { 
                    treatments: updatedTreatments,
                    lastUpdated: new Date().toISOString()
                });
                
                showMessage(`‚úÖ ‡ß≥${discount} ‡¶°‡¶ø‡¶∏‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶¶‡ßá‡¶ì‡¶Ø‡¶º‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá`, 'success');
                closeModal('discountModal');
                document.getElementById('discountAmount').value = '';
                document.getElementById('treatmentSelect').value = '';
                
                await loadPatientsByPhone(currentPatient.data.phone, currentPatient.id);
                
            } catch (error) {
                console.error("Discount error:", error);
                showMessage('‡¶°‡¶ø‡¶∏‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶¶‡¶ø‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ! ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // ‡¶á‡¶Æ‡ßá‡¶ú ‡¶ó‡ßç‡¶Ø‡¶æ‡¶≤‡¶æ‡¶∞‡¶ø ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
        function updateImageGallery(treatments) {
            const gallery = document.getElementById('imageGallery');
            const imageCount = document.getElementById('imageCount');
            
            if (!gallery) return;
            
            let allImages = [];
            treatments.forEach(t => {
                if (t.images && t.images.length) {
                    allImages = allImages.concat(t.images);
                }
            });
            
            if (allImages.length === 0) {
                gallery.innerHTML = `
                    <div class="no-images">
                        <i class="fas fa-images"></i>
                        <p>‡¶ï‡ßã‡¶®‡ßã ‡¶õ‡¶¨‡¶ø ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡¶®‡¶ø</p>
                    </div>
                `;
                if (imageCount) imageCount.textContent = '‡ß¶ ‡¶ü‡¶ø ‡¶õ‡¶¨‡¶ø';
                return;
            }
            
            let html = '';
            allImages.forEach((img, index) => {
                html += `
                    <div class="gallery-item" onclick="viewImage('${img}')">
                        <img src="${img}" alt="Prescription ${index + 1}">
                        <div class="overlay">
                            <i class="fas fa-search-plus"></i> ‡¶¨‡¶°‡¶º ‡¶ï‡¶∞‡ßá ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®
                        </div>
                    </div>
                `;
            });
            
            gallery.innerHTML = html;
            if (imageCount) imageCount.textContent = `${allImages.length} ‡¶ü‡¶ø ‡¶õ‡¶¨‡¶ø`;
        }

        // ‡¶™‡ßç‡¶∞‡ßá‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶™‡¶∂‡¶® ‡¶™‡ßç‡¶∞‡¶ø‡¶≠‡¶ø‡¶â ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶ü
        function generatePrescriptionPreview(treatment) {
            const patient = currentPatient.data;
            const date = new Date(treatment.timestamp || Date.now());
            const banglaDate = date.toLocaleDateString('bn-BD', { year: 'numeric', month: 'long', day: 'numeric' });
            
            let problemsHtml = '';
            let totalBill = 0;
            
            if (treatment.problems && treatment.problems.length) {
                treatment.problems.forEach(p => {
                    totalBill += parseFloat(p.cost || 0);
                    problemsHtml += `
                        <tr>
                            <td>${p.problem || p.name || '‡¶ö‡¶ø‡¶ï‡¶ø‡ßé‡¶∏‡¶æ'}</td>
                            <td>‡ß≥${p.cost || 0}</td>
                            <td>
                                ${p.isCrown ? `
                                    <span class="crown-badge">
                                        <i class="fas fa-crown"></i> ${p.crownType || ''} ${p.crownShade ? `(${p.crownShade})` : ''} √ó${p.crownQty || 1}
                                    </span>
                                ` : '‚Äî'}
                            </td>
                        </tr>
                    `;
                });
            } else {
                totalBill = parseFloat(treatment.bill || treatment.netBill || 0);
                problemsHtml = `
                    <tr>
                        <td>${treatment.name || treatment.problem || '‡¶ö‡¶ø‡¶ï‡¶ø‡ßé‡¶∏‡¶æ'}</td>
                        <td>‡ß≥${totalBill}</td>
                        <td>${treatment.crownType ? `<span class="crown-badge"><i class="fas fa-crown"></i> ${treatment.crownType}</span>` : '‚Äî'}</td>
                    </tr>
                `;
            }
            
            // Calculate paid and due
            let paid = 0;
            if (treatment.paymentHistory && treatment.paymentHistory.length) {
                paid = treatment.paymentHistory.reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);
            } else {
                paid = parseFloat(treatment.paid || 0);
            }
            
            let discount = 0;
            if (treatment.discountHistory && treatment.discountHistory.length) {
                discount = treatment.discountHistory.reduce((sum, d) => sum + (parseFloat(d.amount) || 0), 0);
            } else {
                discount = parseFloat(treatment.discount || 0);
            }
            
            const due = Math.max(0, totalBill - (paid + discount));
            
            return `
                <div class="prescription-header">
                    <div class="clinic-info">
                        <div class="clinic-name-pres">‡¶ö‡ßå‡¶ß‡ßÅ‡¶∞‡ßÄ ‡¶°‡ßá‡¶®‡ßç‡¶ü‡¶æ‡¶≤ ‡¶ï‡ßá‡¶Ø‡¶º‡¶æ‡¶∞</div>
                        <div style="font-size: 0.8rem;">‡¶¨‡¶ø‡¶∂‡ßç‡¶¨‡¶∏‡ßç‡¶§ ‡¶∏‡ßá‡¶¨‡¶æ‡¶∞ ‡¶Ö‡¶ô‡ßç‡¶ó‡ßÄ‡¶ï‡¶æ‡¶∞</div>
                    </div>
                    <div class="prescription-date">üìÖ ${banglaDate}</div>
                </div>
                
                <div class="patient-info-pres">
                    <div class="info-item-pres">
                        <div class="info-label">‡¶∞‡ßã‡¶ó‡ßÄ‡¶∞ ‡¶®‡¶æ‡¶Æ</div>
                        <div class="info-value">${patient.name || '‚Äî'}</div>
                    </div>
                    <div class="info-item-pres">
                        <div class="info-label">‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤</div>
                        <div class="info-value">${patient.phone || '‚Äî'}</div>
                    </div>
                    <div class="info-item-pres">
                        <div class="info-label">‡¶¨‡¶Ø‡¶º‡¶∏/‡¶≤‡¶ø‡¶ô‡ßç‡¶ó</div>
                        <div class="info-value">${patient.age || '‚Äî'} ‡¶¨‡¶õ‡¶∞, ${patient.gender || '‚Äî'}</div>
                    </div>
                    <div class="info-item-pres">
                        <div class="info-label">‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ</div>
                        <div class="info-value">${patient.address || '‚Äî'}</div>
                    </div>
                </div>
                
                <h4 style="color: var(--primary); margin: 15px 0 10px;">üìã ‡¶ö‡¶ø‡¶ï‡¶ø‡ßé‡¶∏‡¶æ‡¶∞ ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</h4>
                
                <table class="problems-table">
                    <thead>
                        <tr>
                            <th>‡¶ö‡¶ø‡¶ï‡¶ø‡ßé‡¶∏‡¶æ‡¶∞ ‡¶ß‡¶∞‡¶£</th>
                            <th>‡¶ñ‡¶∞‡¶ö</th>
                            <th>‡¶ï‡ßç‡¶∞‡¶æ‡¶â‡¶®/‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${problemsHtml}
                    </tbody>
                </table>
                
                <div class="total-pres">
                    <div>
                        <div>‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ø‡¶≤: ‡ß≥${totalBill}</div>
                        <div style="font-size: 0.9rem; color: var(--success);">‡¶ú‡¶Æ‡¶æ: ‡ß≥${paid}</div>
                        <div style="font-size: 0.9rem; color: var(--warning);">‡¶°‡¶ø‡¶∏‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü: ‡ß≥${discount}</div>
                    </div>
                    <div>
                        <div class="grand-total">‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ: ‡ß≥${due}</div>
                        <div style="font-size: 0.8rem; color: ${due > 0 ? 'var(--danger)' : 'var(--success)'}">
                            ${due > 0 ? '‚ö†Ô∏è ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶Ü‡¶õ‡ßá' : '‚úÖ ‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß‡¶ø‡¶§'}
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 20px; text-align: center; color: var(--gray); font-size: 0.8rem; border-top: 1px dashed var(--light-gray); padding-top: 15px;">
                    <i class="fas fa-stethoscope"></i> ‡¶ö‡ßå‡¶ß‡ßÅ‡¶∞‡ßÄ ‡¶°‡ßá‡¶®‡ßç‡¶ü‡¶æ‡¶≤ ‡¶ï‡ßá‡¶Ø‡¶º‡¶æ‡¶∞ - ‡¶∏‡ßÅ‡¶∏‡ßç‡¶• ‡¶π‡¶æ‡¶∏‡¶ø‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø
                </div>
            `;
        }

        // Load patients by phone
        async function loadPatientsByPhone(phone, selectedProfileId = null) {
            try {
                showLoading();
                
                if (!phone) {
                    showMessage('‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶®‡ßá‡¶á!', 'error');
                    return;
                }
                
                const q = query(collection(db, "patients"), where("phone", "==", phone));
                const snapshot = await getDocs(q);
                
                allPatientsWithSamePhone = [];
                snapshot.forEach(doc => {
                    allPatientsWithSamePhone.push({ id: doc.id, data: doc.data() });
                });
                
                if (allPatientsWithSamePhone.length === 0) {
                    showMessage('‡¶ï‡ßã‡¶®‡ßã ‡¶∞‡ßã‡¶ó‡ßÄ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø!', 'error');
                    hideLoading();
                    return;
                }
                
                allPatientsWithSamePhone.sort((a, b) => {
                    const aTreatments = a.data.treatments || [];
                    const bTreatments = b.data.treatments || [];
                    const aLastDate = aTreatments.length > 0 ? (aTreatments[aTreatments.length-1].timestamp || 0) : 0;
                    const bLastDate = bTreatments.length > 0 ? (bTreatments[bTreatments.length-1].timestamp || 0) : 0;
                    return new Date(bLastDate) - new Date(aLastDate);
                });
                
                if (selectedProfileId) {
                    const index = allPatientsWithSamePhone.findIndex(p => p.id === selectedProfileId);
                    if (index !== -1) currentPatientIndex = index;
                    else currentPatientIndex = 0;
                } else {
                    currentPatientIndex = 0;
                }
                
                await loadCurrentPatient();
                updatePatientSwitcher();
                
            } catch (error) {
                console.error("Load patients error:", error);
                showMessage("‡¶∞‡ßã‡¶ó‡ßÄ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ! " + error.message, "error");
            } finally {
                hideLoading();
            }
        }

        // Load current patient
        async function loadCurrentPatient() {
            if (!allPatientsWithSamePhone.length) return;
            currentPatient = allPatientsWithSamePhone[currentPatientIndex];
            displayPatientData(currentPatient.data);
        }

        // Display patient data
        function displayPatientData(data) {
            document.getElementById('patientName').textContent = data.name || '‚Äî';
            document.getElementById('patientPhone').textContent = `‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤: ${data.phone || '‚Äî'}`;
            document.getElementById('patientAddress').textContent = `‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ: ${data.address || '‚Äî'}`;
            document.getElementById('patientAge').textContent = `‡¶¨‡¶Ø‡¶º‡¶∏: ${data.age || '‚Äî'} ‡¶¨‡¶õ‡¶∞`;
            document.getElementById('patientGender').textContent = `‡¶≤‡¶ø‡¶ô‡ßç‡¶ó: ${data.gender || '‚Äî'}`;
            
            let totalBill = 0, totalPaid = 0, totalDue = 0;
            
            allTreatments = (data.treatments || []).map((t, originalIndex) => {
                let bill = 0;
                if (t.problems && t.problems.length) {
                    bill = t.problems.reduce((sum, p) => sum + (parseFloat(p.cost) || 0), 0);
                } else {
                    bill = parseFloat(t.bill || t.netBill || t.total || 0);
                }
                
                let paid = 0;
                if (t.paymentHistory && t.paymentHistory.length) {
                    paid = t.paymentHistory.reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);
                } else {
                    paid = parseFloat(t.paid || 0);
                }
                
                let discount = 0;
                if (t.discountHistory && t.discountHistory.length) {
                    discount = t.discountHistory.reduce((sum, d) => sum + (parseFloat(d.amount) || 0), 0);
                } else {
                    discount = parseFloat(t.discount || 0);
                }
                
                const due = Math.max(0, bill - (paid + discount));
                const hasCrown = t.problems?.some(p => p.crownType) || t.crownType ? true : false;
                
                totalBill += bill;
                totalPaid += paid;
                totalDue += due;
                
                return { 
                    ...t, 
                    originalIndex: originalIndex,
                    bill, 
                    paid, 
                    due, 
                    discount,
                    isPaid: due <= 0,
                    hasCrown
                };
            }).reverse();
            
            document.getElementById('totalBill').textContent = `‡ß≥${totalBill}`;
            document.getElementById('totalPaid').textContent = `‡ß≥${totalPaid}`;
            document.getElementById('totalDue').textContent = `‡ß≥${totalDue}`;
            document.getElementById('totalTreatments').textContent = allTreatments.length;
            document.getElementById('historyCount').textContent = `${allTreatments.length} ‡¶ü‡¶ø`;
            
            // ‡¶á‡¶Æ‡ßá‡¶ú ‡¶ó‡ßç‡¶Ø‡¶æ‡¶≤‡¶æ‡¶∞‡¶ø ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
            updateImageGallery(allTreatments);
            
            updateTreatmentHistory();
            loadMonthlyStats();
            populateTreatmentSelect();
            
            // ‡¶∏‡¶∞‡ßç‡¶¨‡¶∂‡ßá‡¶∑ ‡¶ö‡¶ø‡¶ï‡¶ø‡ßé‡¶∏‡¶æ ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶™‡ßç‡¶∞‡ßá‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶™‡¶∂‡¶® ‡¶™‡ßç‡¶∞‡¶ø‡¶≠‡¶ø‡¶â ‡¶¶‡ßá‡¶ñ‡¶æ‡¶á
            if (allTreatments.length > 0) {
                const latestTreatment = allTreatments[0];
                const prescriptionCard = document.getElementById('prescriptionCard');
                if (prescriptionCard) {
                    prescriptionCard.innerHTML = generatePrescriptionPreview(latestTreatment);
                }
            }
        }

        // Update treatment history
        function updateTreatmentHistory() {
            let filtered = allTreatments;
            
            if (currentFilter === 'due') filtered = allTreatments.filter(t => t.due > 0);
            else if (currentFilter === 'paid') filtered = allTreatments.filter(t => t.due <= 0);
            else if (currentFilter === 'crown') filtered = allTreatments.filter(t => t.hasCrown);
            
            const container = document.getElementById('treatmentHistory');
            
            if (!filtered.length) {
                container.innerHTML = '<div class="empty-state"><i class="fas fa-search"></i><p>‡¶ï‡ßã‡¶®‡ßã ‡¶ö‡¶ø‡¶ï‡¶ø‡ßé‡¶∏‡¶æ ‡¶®‡ßá‡¶á</p></div>';
                return;
            }
            
            let html = '';
            filtered.forEach(t => {
                const cardClass = t.due <= 0 ? 'paid' : (t.hasCrown ? 'crown' : 'due');
                
                html += `
                    <div class="treatment-card ${cardClass}" onclick="updatePrescriptionFromHistory(${t.originalIndex})">
                        <div class="card-header">
                            <span class="card-date"><i class="far fa-calendar-alt"></i> ${t.date || '‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶®‡ßá‡¶á'}</span>
                            <span class="card-amount">‡ß≥${t.bill}</span>
                        </div>
                        
                        <div class="problem-list">
                            ${(t.problems && t.problems.length ? t.problems : [{
                                problem: t.name || t.problem || '‡¶ö‡¶ø‡¶ï‡¶ø‡ßé‡¶∏‡¶æ',
                                cost: t.cost || t.bill || 0,
                                discount: t.discount || 0,
                                crownType: t.crownType,
                                crownShade: t.crownShade,
                                crownQty: t.crownQty || 1
                            }]).map(p => `
                                <div class="problem-item">
                                    <div class="problem-name">${p.problem || p.name || '‡¶ö‡¶ø‡¶ï‡¶ø‡ßé‡¶∏‡¶æ'}</div>
                                    <div class="problem-detail">
                                        <span>‡¶¨‡¶ø‡¶≤: ‡ß≥${p.cost || 0}</span>
                                        <span>‡¶°‡¶ø‡¶∏‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü: ‡ß≥${p.discount || 0}</span>
                                    </div>
                                    ${p.crownType ? `
                                        <div class="crown-info">
                                            <i class="fas fa-crown"></i> ${p.crownType} | ‡¶∂‡ßá‡¶°: ${p.crownShade || 'A2'} | √ó${p.crownQty || 1}
                                        </div>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; margin-top: 10px; padding: 0 5px;">
                            <span><strong>‡¶ú‡¶Æ‡¶æ:</strong> ‡ß≥${t.paid}</span>
                            <span><strong>‡¶°‡¶ø‡¶∏‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü:</strong> ‡ß≥${t.discount || 0}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 5px; padding: 0 5px; font-weight: bold;">
                            <span style="color: ${t.due > 0 ? 'var(--danger)' : 'var(--success)'};">‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ: ‡ß≥${t.due}</span>
                        </div>
                        
                        ${t.paymentHistory?.length ? `
                            <div class="payment-log">
                                <div style="font-weight:600; margin-bottom:8px;">üìù ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶≤‡¶ó:</div>
                                ${t.paymentHistory.map(log => `
                                    <div class="log-item">
                                        <span>${log.time || log.date}</span>
                                        <span style="color:var(--success);">+ ‡ß≥${log.amount}</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        ${t.discountHistory?.length ? `
                            <div class="payment-log" style="background: var(--warning-light);">
                                <div style="font-weight:600; margin-bottom:8px;">üè∑Ô∏è ‡¶°‡¶ø‡¶∏‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶≤‡¶ó:</div>
                                ${t.discountHistory.map(log => `
                                    <div class="log-item">
                                        <span>${log.time || log.date}</span>
                                        <span style="color:var(--warning);">- ‡ß≥${log.amount}</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏ ‡¶•‡ßá‡¶ï‡ßá ‡¶™‡ßç‡¶∞‡ßá‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶™‡¶∂‡¶® ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
        window.updatePrescriptionFromHistory = function(index) {
            const treatment = allTreatments.find(t => t.originalIndex == index);
            if (treatment) {
                const prescriptionCard = document.getElementById('prescriptionCard');
                if (prescriptionCard) {
                    prescriptionCard.innerHTML = generatePrescriptionPreview(treatment);
                    
                    // ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶®‡ßá ‡¶™‡ßç‡¶∞‡ßá‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶™‡¶∂‡¶® ‡¶∏‡ßá‡¶ï‡¶∂‡¶®‡ßá ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡ßã‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶®
                    document.getElementById('prescriptionSection').scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start' 
                    });
                }
            }
        };

        // Update patient switcher
        function updatePatientSwitcher() {
            const switcher = document.getElementById('patientSwitcher');
            if (allPatientsWithSamePhone.length > 1) {
                switcher.style.display = 'flex';
                document.getElementById('patientCount').textContent = `${currentPatientIndex+1}/${allPatientsWithSamePhone.length}`;
            } else {
                switcher.style.display = 'none';
            }
        }

        // Load monthly stats
        async function loadMonthlyStats() {
            try {
                const snapshot = await getDocs(collection(db, "patients"));
                const months = {};
                const monthNames = ['‡¶ú‡¶æ‡¶®‡ßÅ‡¶Ø‡¶º‡¶æ‡¶∞‡¶ø', '‡¶´‡ßá‡¶¨‡ßç‡¶∞‡ßÅ‡¶Ø‡¶º‡¶æ‡¶∞‡¶ø', '‡¶Æ‡¶æ‡¶∞‡ßç‡¶ö', '‡¶è‡¶™‡ßç‡¶∞‡¶ø‡¶≤', '‡¶Æ‡ßá', '‡¶ú‡ßÅ‡¶®', 
                                   '‡¶ú‡ßÅ‡¶≤‡¶æ‡¶á', '‡¶Ü‡¶ó‡¶∏‡ßç‡¶ü', '‡¶∏‡ßá‡¶™‡ßç‡¶ü‡ßá‡¶Æ‡ßç‡¶¨‡¶∞', '‡¶Ö‡¶ï‡ßç‡¶ü‡ßã‡¶¨‡¶∞', '‡¶®‡¶≠‡ßá‡¶Æ‡ßç‡¶¨‡¶∞', '‡¶°‡¶ø‡¶∏‡ßá‡¶Æ‡ßç‡¶¨‡¶∞'];
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    (data.treatments || []).forEach(t => {
                        if (t.timestamp || t.date) {
                            const date = new Date(t.timestamp || t.date);
                            if (!isNaN(date.getTime())) {
                                const monthKey = `${date.getFullYear()}-${date.getMonth()}`;
                                
                                if (!months[monthKey]) {
                                    months[monthKey] = { 
                                        name: `${monthNames[date.getMonth()]} ${date.getFullYear()}`, 
                                        patients: 0, 
                                        bill: 0,
                                        paid: 0
                                    };
                                }
                                
                                months[monthKey].patients++;
                                
                                const bill = t.bill || (t.problems ? t.problems.reduce((sum, p) => sum + (parseFloat(p.cost) || 0), 0) : 0);
                                months[monthKey].bill += bill;
                                
                                if (t.paymentHistory && t.paymentHistory.length) {
                                    const paid = t.paymentHistory.reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);
                                    months[monthKey].paid += paid;
                                } else {
                                    months[monthKey].paid += (parseFloat(t.paid || 0));
                                }
                            }
                        }
                    });
                });
                
                const sortedMonths = Object.values(months).sort((a, b) => {
                    return new Date(b.name) - new Date(a.name);
                }).slice(0, 6);
                
                const container = document.getElementById('monthlyData');
                container.innerHTML = sortedMonths.map(m => `
                    <div class="month-card">
                        <div class="month-name">${m.name}</div>
                        <div class="month-value">${m.patients}</div>
                        <div class="month-small">‡¶∞‡ßã‡¶ó‡ßÄ</div>
                        <div class="month-value" style="font-size:1rem;">‡ß≥${m.bill}</div>
                        <div class="month-small">‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ø‡¶≤</div>
                        <div class="month-value" style="font-size:0.9rem; color:var(--success);">‡ß≥${m.paid}</div>
                        <div class="month-small">‡¶Ü‡¶¶‡¶æ‡ßü</div>
                    </div>
                `).join('') || '<div class="empty-state">‡¶ï‡ßã‡¶®‡ßã ‡¶°‡ßá‡¶ü‡¶æ ‡¶®‡ßá‡¶á</div>';
                
            } catch (error) {
                console.error("Monthly stats error:", error);
            }
        }

        // Populate treatment select for discount
        function populateTreatmentSelect() {
            const select = document.getElementById('treatmentSelect');
            if (!select) return;
            
            select.innerHTML = '<option value="">‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</option>';
            
            const treatmentsWithDue = allTreatments.filter(t => t.due > 0);
            
            treatmentsWithDue.forEach(t => {
                const option = document.createElement('option');
                option.value = t.originalIndex;
                option.textContent = `${t.date || '‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶®‡ßá‡¶á'} - ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ: ‡ß≥${t.due}`;
                select.appendChild(option);
            });
            
            if (treatmentsWithDue.length === 0) {
                const option = document.createElement('option');
                option.value = "";
                option.textContent = "‡¶ï‡ßã‡¶®‡ßã ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ ‡¶®‡ßá‡¶á";
                option.disabled = true;
                select.appendChild(option);
            }
        }

        // Initialize
        async function init() {
            const urlParams = new URLSearchParams(window.location.search);
            const profileId = urlParams.get('profileId');
            
            if (!profileId) {
                window.location.href = "amarghor.html";
                return;
            }
            
            try {
                const patientDoc = doc(db, "patients", profileId);
                const patientSnap = await getDoc(patientDoc);
                
                if (patientSnap.exists()) {
                    const data = patientSnap.data();
                    await loadPatientsByPhone(data.phone, profileId);
                } else {
                    showMessage("‡¶∞‡ßã‡¶ó‡ßÄ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø!", "error");
                    setTimeout(() => {
                        window.location.href = "amarghor.html";
                    }, 2000);
                }
            } catch (error) {
                console.error("Init error:", error);
                showMessage("‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ! " + error.message, "error");
            }
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Navigation
            document.getElementById('backBtn')?.addEventListener('click', () => window.history.back());
            document.getElementById('homeBtn')?.addEventListener('click', () => window.location.href = 'amarghor.html');
            
            // Payment button
            document.getElementById('addPaymentBtn')?.addEventListener('click', () => {
                const totalDueText = document.getElementById('totalDue').textContent.replace('‡ß≥', '');
                const totalDue = parseFloat(totalDueText) || 0;
                
                if (totalDue <= 0) {
                    showMessage('‡¶è‡¶á ‡¶∞‡ßã‡¶ó‡ßÄ‡¶∞ ‡¶ï‡ßã‡¶®‡ßã ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ ‡¶®‡ßá‡¶á!', 'warning');
                    return;
                }
                
                document.getElementById('paymentForm').reset();
                document.getElementById('paymentModal')?.classList.add('active');
            });
            
            // Payment form submit
            document.getElementById('paymentForm')?.addEventListener('submit', processPayment);
            
            // Discount button
            document.getElementById('discountBtn')?.addEventListener('click', () => {
                const hasDue = allTreatments.some(t => t.due > 0);
                if (hasDue) {
                    populateTreatmentSelect();
                    document.getElementById('discountModal')?.classList.add('active');
                } else {
                    showMessage('‡¶ï‡ßã‡¶®‡ßã ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ ‡¶®‡ßá‡¶á!', 'warning');
                }
            });
            
            // Discount form submit
            document.getElementById('discountForm')?.addEventListener('submit', applyDiscount);
            
            // Add treatment
            document.getElementById('addTreatmentBtn')?.addEventListener('click', () => {
                if (currentPatient) {
                    const patientData = currentPatient.data;
                    const params = new URLSearchParams({
                        name: patientData.name || '',
                        phone: patientData.phone || '',
                        address: patientData.address || '',
                        age: patientData.age || '',
                        gender: patientData.gender || '',
                        fromProfile: currentPatient.id
                    });
                    
                    window.location.href = `amarghor.html?${params.toString()}`;
                }
            });
            
            // Edit patient
            document.getElementById('editPatientBtn')?.addEventListener('click', () => {
                if (currentPatient) {
                    const patientData = currentPatient.data;
                    const params = new URLSearchParams({
                        edit: currentPatient.id,
                        name: patientData.name || '',
                        phone: patientData.phone || '',
                        address: patientData.address || '',
                        age: patientData.age || '',
                        gender: patientData.gender || ''
                    });
                    
                    window.location.href = `amarghor.html?${params.toString()}`;
                }
            });
            
            // Message modal
            document.getElementById('openMessageModalBtn')?.addEventListener('click', () => {
                const modal = document.getElementById('messageModal');
                if (!modal) return;
                
                modal.classList.add('active');
                
                selectedMessageType = '';
                document.querySelectorAll('.message-option').forEach(opt => opt.classList.remove('selected'));
                document.getElementById('customMessage').value = '';
                
                const previewElement = document.getElementById('previewText');
                if (previewElement && currentPatient) {
                    previewElement.innerText = `‡¶∏‡¶Æ‡ßç‡¶Æ‡¶æ‡¶®‡¶ø‡¶§ ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ${currentPatient.data.name},

‡¶è‡¶ï‡¶ü‡¶ø ‡¶Ö‡¶™‡¶∂‡¶® ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§

‡¶â‡¶™‡¶∞‡ßá ‡¶§‡¶ø‡¶®‡¶ü‡¶ø ‡¶Ö‡¶™‡¶∂‡¶® ‡¶•‡ßá‡¶ï‡ßá ‡¶Ø‡ßá‡¶ï‡ßã‡¶®‡ßã ‡¶è‡¶ï‡¶ü‡¶ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®:

‡ßß. ‡¶ï‡ßç‡¶∞‡¶æ‡¶â‡¶®/‡¶ï‡ßç‡¶Ø‡¶æ‡¶™ ‡¶§‡ßà‡¶∞‡¶ø ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá
‡ß®. ‡¶ö‡¶ø‡¶ï‡¶ø‡ßé‡¶∏‡¶æ ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶ì ‡¶¨‡¶ø‡¶≤ ‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß
‡ß©. ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ ‡¶ü‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø`;
                }
            });
            
            // Message options
            document.querySelectorAll('.message-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.message-option').forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedMessageType = this.dataset.message;
                    
                    if (currentPatient) {
                        const message = generateMessage(selectedMessageType, currentPatient.data, allTreatments);
                        document.getElementById('previewText').innerText = message;
                    }
                });
            });
            
            // Send message
            document.getElementById('sendMessageBtn')?.addEventListener('click', sendMessage);
            
            // Filter tabs
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    currentFilter = this.dataset.filter;
                    updateTreatmentHistory();
                });
            });
            
            // Toggle monthly stats
            document.getElementById('toggleMonthlyStats')?.addEventListener('click', () => {
                document.getElementById('monthlyContent')?.classList.toggle('active');
                const icon = document.getElementById('toggleIcon');
                if (icon) {
                    icon.classList.toggle('fa-chevron-down');
                    icon.classList.toggle('fa-chevron-up');
                }
            });
            
            // Patient switcher
            document.getElementById('switchPatientBtn')?.addEventListener('click', () => {
                if (allPatientsWithSamePhone.length > 1) {
                    currentPatientIndex = (currentPatientIndex + 1) % allPatientsWithSamePhone.length;
                    loadCurrentPatient();
                    updatePatientSwitcher();
                    
                    const url = new URL(window.location);
                    url.searchParams.set('profileId', allPatientsWithSamePhone[currentPatientIndex].id);
                    window.history.pushState({}, '', url);
                }
            });
            
            // Search nav
            document.getElementById('searchNav')?.addEventListener('click', (e) => {
                e.preventDefault();
                window.location.href = "amarghor.html?search=true";
            });
        });

        // Auth check
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = "log.html";
            } else {
                init();
            }
        });
    </script> 
</body>
</html>
