<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>‡¶∞‡ßã‡¶ó‡ßÄ ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ - ‡¶ö‡ßå‡¶ß‡ßÅ‡¶∞‡ßÄ ‡¶°‡ßá‡¶®‡ßç‡¶ü‡¶æ‡¶≤ ‡¶ï‡ßá‡¶Ø‡¶º‡¶æ‡¶∞</title>
    <!-- Fonts and Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+Bengali:wght@400;500;600;700&family=Hind+Siliguri:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
    // Firebase Config
    const firebaseConfig = {
        apiKey: "AIzaSyAxz46ug-CAywevI-PzmOp7ba5iiCK9dfM",
        authDomain: "plasma-raceway-465016-v0.firebaseapp.com",
        projectId: "plasma-raceway-465016-v0",
        storageBucket: "plasma-raceway-465016-v0.appspot.com",
        messagingSenderId: "23620370976",
        appId: "1:23620370976:web:3bb119ceb9e15608a33245"
    };

    // Firebase Initialization
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    // Auth check
    firebase.auth().onAuthStateChanged((user) => {
        if (!user) {
            window.location.replace("log.html");
        } else {
            if (typeof hideLoading === 'function') {
                hideLoading();
            }
        }
    });

    // SMS API Configuration
    window.API_CONFIG = {
        baseUrl: "https://bulksmsdhaka.net/api/sendtext",
        apikey: "e7b0da5a67ded72bd064e59bc2c382fc9b946900",
        callerID: "1234"
    };
</script>
    
    <style>
        /* ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ü‡¶ó‡ßá‡¶∞ CSS ‡¶†‡¶ø‡¶ï ‡¶•‡¶æ‡¶ï‡¶¨‡ßá - ‡¶Ö‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶ø‡¶§ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Hind Siliguri', 'Noto Serif Bengali', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary: #0a5c4b;
            --primary-dark: #064635;
            --primary-light: #e0f2e9;
            --success: #1e7e34;
            --success-dark: #146b2a;
            --success-light: #e8f5e9;
            --danger: #b22234;
            --danger-light: #ffebee;
            --warning: #bf8c2b;
            --warning-light: #fff8e1;
            --gray: #5a6b7a;
            --light-gray: #e9ecef;
            --dark: #2d3e50;
            --border-radius: 24px;
            --box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }

        body {
            background: #f8fafc;
            min-height: 100vh;
            padding: 16px;
            padding-top: calc(16px + var(--safe-top));
            padding-bottom: calc(80px + var(--safe-bottom));
            visibility: visible !important;
            opacity: 1 !important;
        }

        /* ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡¶æ‡¶ï‡¶ø CSS ‡¶†‡¶ø‡¶ï ‡¶•‡¶æ‡¶ï‡¶¨‡ßá - ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶Ö‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶ø‡¶§ */
        .profile-header {
            background: linear-gradient(145deg, var(--primary), var(--primary-dark));
            color: white;
            border-radius: 28px;
            padding: 24px 20px;
            margin-bottom: 20px;
            box-shadow: 0 15px 25px rgba(6, 70, 53, 0.2);
            position: relative;
            overflow: hidden;
        }

        .profile-header::after {
            content: '';
            position: absolute;
            top: -50%;
            right: -20%;
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            border-radius: 50%;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .nav-btn {
            width: 44px;
            height: 44px;
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 16px;
            color: white;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            backdrop-filter: blur(10px);
        }

        .nav-btn:active {
            transform: scale(0.92);
            background: rgba(255,255,255,0.25);
        }

        .patient-name {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 15px;
            line-height: 1.3;
        }

        .info-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1rem;
            opacity: 0.95;
        }

        .info-item i {
            width: 24px;
            text-align: center;
            font-size: 1.1rem;
        }

        .patient-switcher {
            background: rgba(0,0,0,0.15);
            border-radius: 20px;
            padding: 12px 16px;
            margin-top: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
        }

        .patient-count {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        .switch-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 14px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-weight: 500;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 16px 8px;
            border-radius: 20px;
            text-align: center;
            box-shadow: var(--box-shadow);
            border-bottom: 4px solid var(--primary);
        }

        .stat-card.success { border-bottom-color: var(--success); }
        .stat-card.danger { border-bottom-color: var(--danger); }
        .stat-card.warning { border-bottom-color: var(--warning); }

        .stat-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--dark);
        }

        .stat-label {
            font-size: 0.7rem;
            color: var(--gray);
            margin-top: 4px;
        }

        .action-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .action-btn {
            background: white;
            border: none;
            border-radius: 20px;
            padding: 16px 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            box-shadow: var(--box-shadow);
            cursor: pointer;
        }

        .action-btn:active {
            transform: scale(0.95);
        }

        .action-btn.disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        .action-icon {
            width: 48px;
            height: 48px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.3rem;
        }

        .action-text {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--dark);
        }

        .message-action-btn {
            background: linear-gradient(145deg, #4a6fa5, #3a5a8c);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 16px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            box-shadow: var(--box-shadow);
            cursor: pointer;
            width: 100%;
        }

        .message-action-btn:active {
            transform: scale(0.98);
        }

        .search-section {
            background: white;
            border-radius: 28px;
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: var(--box-shadow);
        }

        .search-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
            color: var(--primary);
            font-weight: 700;
            font-size: 1.2rem;
        }

        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .search-input {
            flex: 1;
            padding: 16px;
            border: 2px solid var(--light-gray);
            border-radius: 18px;
            font-size: 1rem;
        }

        .search-input:focus {
            border-color: var(--primary);
            outline: none;
        }

        .search-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 18px;
            padding: 0 20px;
            font-weight: 600;
            cursor: pointer;
        }

        .monthly-stats {
            background: linear-gradient(145deg, #f8fafc, #f0f4f8);
            border-radius: 24px;
            margin-bottom: 24px;
            overflow: hidden;
        }

        .stats-header {
            background: var(--primary);
            color: white;
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .stats-header h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
        }

        .stats-content {
            padding: 0 20px;
            max-height: 0;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .stats-content.active {
            padding: 20px;
            max-height: 500px;
        }

        .monthly-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .month-card {
            background: white;
            padding: 15px;
            border-radius: 18px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        .month-name {
            font-size: 0.9rem;
            color: var(--gray);
            margin-bottom: 8px;
        }

        .month-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--dark);
        }

        .month-small {
            font-size: 0.75rem;
            color: var(--gray);
        }

        .history-section {
            background: white;
            border-radius: 28px;
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: var(--box-shadow);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary-dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .treatment-count {
            background: var(--primary-light);
            color: var(--primary);
            padding: 6px 16px;
            border-radius: 30px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .filter-tabs {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding-bottom: 8px;
            margin-bottom: 20px;
            scrollbar-width: none;
        }

        .filter-tab {
            padding: 8px 20px;
            border: 1.5px solid var(--light-gray);
            border-radius: 30px;
            background: white;
            color: var(--gray);
            font-weight: 500;
            white-space: nowrap;
            cursor: pointer;
        }

        .filter-tab.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .history-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
            max-height: 500px;
            overflow-y: auto;
            padding-right: 5px;
        }

        .treatment-card {
            background: #f8fafc;
            border-radius: 20px;
            padding: 18px;
            border-left: 6px solid var(--primary);
        }

        .treatment-card.paid { border-left-color: var(--success); background: var(--success-light); }
        .treatment-card.due { border-left-color: var(--danger); background: var(--danger-light); }
        .treatment-card.crown { border-left-color: var(--warning); background: var(--warning-light); }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .card-date {
            background: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            color: var(--gray);
        }

        .card-amount {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .problem-list {
            margin: 12px 0;
        }

        .problem-item {
            background: white;
            border-radius: 14px;
            padding: 12px;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .problem-name {
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 4px;
        }

        .problem-detail {
            display: flex;
            justify-content: space-between;
            color: var(--gray);
            font-size: 0.85rem;
        }

        .crown-info {
            background: var(--warning-light);
            padding: 8px;
            border-radius: 10px;
            margin-top: 8px;
            font-size: 0.85rem;
        }

        .payment-log {
            background: white;
            border-radius: 14px;
            padding: 12px;
            margin-top: 12px;
        }

        .log-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px dashed #dee2e6;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            backdrop-filter: blur(5px);
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 32px;
            width: 100%;
            max-width: 500px;
            max-height: 85vh;
            overflow-y: auto;
            padding: 28px;
        }

        .modal-title {
            font-size: 1.5rem;
            color: var(--primary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .message-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }

        .message-option {
            background: var(--primary-light);
            border: 2px solid transparent;
            border-radius: 18px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .message-option.selected {
            border-color: var(--primary);
            background: white;
            box-shadow: 0 5px 15px rgba(10, 92, 75, 0.1);
        }

        .message-option-icon {
            width: 48px;
            height: 48px;
            border-radius: 16px;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
        }

        .message-option-text {
            font-weight: 600;
            color: var(--dark);
        }

        .message-option-desc {
            font-size: 0.85rem;
            color: var(--gray);
            margin-top: 4px;
        }

        .message-input {
            width: 100%;
            padding: 16px;
            border: 2px solid var(--light-gray);
            border-radius: 18px;
            font-size: 1rem;
            margin: 20px 0;
            resize: vertical;
            min-height: 100px;
        }

        .message-input:focus {
            border-color: var(--primary);
            outline: none;
        }

        .message-preview {
            background: #f8fafc;
            border-radius: 16px;
            padding: 16px;
            margin: 15px 0;
            border-left: 4px solid var(--primary);
            font-size: 0.95rem;
            line-height: 1.6;
            color: var(--dark);
            white-space: pre-line;
            max-height: 300px;
            overflow-y: auto;
        }

        .message-preview-title {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .discount-row {
            background: var(--warning-light);
            border-radius: 16px;
            padding: 12px;
            margin: 12px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .discount-input {
            flex: 1;
            padding: 12px;
            border: 2px solid var(--warning);
            border-radius: 12px;
            font-size: 1rem;
        }

        .btn {
            padding: 16px;
            border: none;
            border-radius: 18px;
            font-weight: 700;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            cursor: pointer;
            width: 100%;
        }

        .btn-primary {
            background: linear-gradient(145deg, var(--primary), var(--primary-dark));
            color: white;
        }

        .btn-success {
            background: linear-gradient(145deg, var(--success), var(--success-dark));
            color: white;
        }

        .btn-danger {
            background: linear-gradient(145deg, var(--danger), #8b1a1a);
            color: white;
        }

        .btn-info {
            background: linear-gradient(145deg, #4a6fa5, #3a5a8c);
            color: white;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--gray);
        }

        .message-box {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            padding: 16px;
            border-radius: 18px;
            color: white;
            font-weight: 600;
            z-index: 2000;
            animation: slideDown 0.3s;
            text-align: center;
        }

        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .message-success { background: linear-gradient(145deg, var(--success), var(--success-dark)); }
        .message-error { background: linear-gradient(145deg, var(--danger), #8b1a1a); }
        .message-info { background: linear-gradient(145deg, var(--primary), var(--primary-dark)); }
        .message-warning { background: linear-gradient(145deg, var(--warning), #9e7627); }

        @media (max-width: 480px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .action-grid { grid-template-columns: repeat(2, 1fr); }
            .monthly-grid { grid-template-columns: 1fr; }
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            justify-content: space-around;
            padding: 12px 16px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.08);
            border-radius: 30px 30px 0 0;
            padding-bottom: calc(12px + var(--safe-bottom));
            z-index: 100;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: var(--gray);
            font-size: 0.7rem;
            gap: 4px;
        }

        .nav-item.active {
            color: var(--primary);
        }

        .nav-icon {
            font-size: 1.3rem;
        }

        .auth-loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #f8fafc;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.3s;
        }
        
        .auth-loading.fade-out {
            opacity: 0;
            pointer-events: none;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--primary-light);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="authLoading" class="auth-loading">
        <div class="loading-spinner"></div>
    </div>

    <div id="messageContainer"></div>

    <div class="profile-header">
        <div class="header-top">
            <button class="nav-btn" id="backBtn"><i class="fas fa-arrow-left"></i></button>
            <button class="nav-btn" id="homeBtn"><i class="fas fa-home"></i></button>
        </div>
        
        <h1 class="patient-name" id="patientName">‚Äî</h1>
        
        <div class="info-grid">
            <div class="info-item"><i class="fas fa-phone-alt"></i> <span id="patientPhone">‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤: ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</span></div>
            <div class="info-item"><i class="fas fa-map-marker-alt"></i> <span id="patientAddress">‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ: ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</span></div>
            <div class="info-item"><i class="fas fa-calendar-alt"></i> <span id="patientAge">‡¶¨‡¶Ø‡¶º‡¶∏: ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</span></div>
        </div>
        
        <div class="patient-switcher" id="patientSwitcher" style="display: none;">
            <div class="patient-count"><i class="fas fa-users"></i> <span id="patientCount">‡ßß/‡ßß</span></div>
            <button class="switch-btn" id="switchPatientBtn"><i class="fas fa-exchange-alt"></i> ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®</button>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card"><div class="stat-value" id="totalBill">‡ß≥‡ß¶</div><div class="stat-label">‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ø‡¶≤</div></div>
        <div class="stat-card success"><div class="stat-value" id="totalPaid">‡ß≥‡ß¶</div><div class="stat-label">‡¶ú‡¶Æ‡¶æ</div></div>
        <div class="stat-card danger"><div class="stat-value" id="totalDue">‡ß≥‡ß¶</div><div class="stat-label">‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ</div></div>
        <div class="stat-card warning"><div class="stat-value" id="totalTreatments">‡ß¶</div><div class="stat-label">‡¶ö‡¶ø‡¶ï‡¶ø‡ßé‡¶∏‡¶æ</div></div>
    </div>

    <div class="action-grid">
        <button class="action-btn" id="addPaymentBtn">
            <div class="action-icon" style="background: linear-gradient(145deg, #1e7e34, #0f5922);"><i class="fas fa-coins"></i></div>
            <span class="action-text">‡¶ü‡¶æ‡¶ï‡¶æ ‡¶ú‡¶Æ‡¶æ</span>
        </button>
        <button class="action-btn" id="addTreatmentBtn">
            <div class="action-icon" style="background: linear-gradient(145deg, #0a5c4b, #064635);"><i class="fas fa-tooth"></i></div>
            <span class="action-text">‡¶®‡¶§‡ßÅ‡¶® ‡¶ö‡¶ø‡¶ï‡¶ø‡ßé‡¶∏‡¶æ</span>
        </button>
        <button class="action-btn" id="editPatientBtn">
            <div class="action-icon" style="background: linear-gradient(145deg, #bf8c2b, #9e7627);"><i class="fas fa-user-edit"></i></div>
            <span class="action-text">‡¶§‡¶•‡ßç‡¶Ø ‡¶∏‡¶Æ‡ßç‡¶™‡¶æ‡¶¶‡¶®‡¶æ</span>
        </button>
        <button class="action-btn" id="discountBtn">
            <div class="action-icon" style="background: linear-gradient(145deg, #dc3545, #b02a37);"><i class="fas fa-percentage"></i></div>
            <span class="action-text">‡¶°‡¶ø‡¶∏‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü</span>
        </button>
    </div>

    <button class="message-action-btn" id="openMessageModalBtn">
        <i class="fas fa-comment-dots"></i>
        <span>‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶™‡¶æ‡¶†‡¶æ‡¶®</span>
        <i class="fas fa-chevron-right"></i>
    </button>

    <div class="search-section">
        <div class="search-title"><i class="fas fa-search"></i> ‡¶∞‡ßã‡¶ó‡ßÄ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®</div>
        <div class="search-box">
            <input type="tel" id="searchPhone" class="search-input" placeholder="‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ ‡¶¶‡¶ø‡¶®...">
            <button class="search-btn" id="searchBtn"><i class="fas fa-search"></i></button>
        </div>
        <div id="searchResult" style="display: none;"></div>
    </div>

    <div class="monthly-stats" id="monthlyStats">
        <div class="stats-header" id="toggleMonthlyStats">
            <h3><i class="fas fa-chart-line"></i> ‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶™‡¶∞‡¶ø‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ‡¶®</h3>
            <i class="fas fa-chevron-down" id="toggleIcon"></i>
        </div>
        <div class="stats-content" id="monthlyContent">
            <div class="monthly-grid" id="monthlyData"></div>
        </div>
    </div>

    <div class="history-section">
        <div class="section-header">
            <div class="section-title"><i class="fas fa-notes-medical"></i> ‡¶ö‡¶ø‡¶ï‡¶ø‡ßé‡¶∏‡¶æ‡¶∞ ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏</div>
            <span class="treatment-count" id="historyCount">‡ß¶ ‡¶ü‡¶ø</span>
        </div>

        <div class="filter-tabs" id="filterTabs">
            <button class="filter-tab active" data-filter="all">‡¶∏‡¶ï‡¶≤</button>
            <button class="filter-tab" data-filter="due">‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ</button>
            <button class="filter-tab" data-filter="paid">‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß‡¶ø‡¶§</button>
            <button class="filter-tab" data-filter="crown">‡¶ï‡ßç‡¶∞‡¶æ‡¶â‡¶®</button>
        </div>

        <div class="history-list" id="treatmentHistory">
            <div class="empty-state"><i class="fas fa-spinner fa-spin fa-2x"></i><p>‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p></div>
        </div>
    </div>

    <div class="modal" id="paymentModal">
        <div class="modal-content">
            <h2 class="modal-title"><i class="fas fa-hand-holding-usd"></i> ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶ú‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶®</h2>
            <form id="paymentForm">
                <div class="form-group">
                    <label>‡¶ü‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ (‡ß≥)</label>
                    <input type="number" id="paymentAmount" class="search-input" placeholder="‡¶Ø‡ßá‡¶Æ‡¶®: ‡ß´‡ß¶‡ß¶" min="1" required>
                </div>
                <div class="form-group">
                    <label>‡¶®‡ßã‡¶ü / ‡¶Æ‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø</label>
                    <textarea id="paymentNotes" class="search-input" rows="3" placeholder="‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï..."></textarea>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-success" style="flex: 2;">‡¶ú‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶®</button>
                    <button type="button" class="btn btn-danger" style="flex: 1;" onclick="window.closeModal('paymentModal')">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="discountModal">
        <div class="modal-content">
            <h2 class="modal-title"><i class="fas fa-percentage"></i> ‡¶°‡¶ø‡¶∏‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶¶‡¶ø‡¶®</h2>
            <form id="discountForm">
                <div class="form-group">
                    <label>‡¶ö‡¶ø‡¶ï‡¶ø‡ßé‡¶∏‡¶æ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</label>
                    <select id="treatmentSelect" class="search-input" required>
                        <option value="">‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>‡¶°‡¶ø‡¶∏‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü‡ßá‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ (‡ß≥)</label>
                    <input type="number" id="discountAmount" class="search-input" placeholder="‡¶Ø‡ßá‡¶Æ‡¶®: ‡ß®‡ß¶‡ß¶" min="1" required>
                </div>
                <div class="discount-row">
                    <i class="fas fa-info-circle" style="color: var(--warning);"></i>
                    <span style="font-size: 0.9rem;">‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ ‡¶•‡¶æ‡¶ï‡¶æ ‡¶ö‡¶ø‡¶ï‡¶ø‡ßé‡¶∏‡¶æ‡¶Ø‡¶º ‡¶°‡¶ø‡¶∏‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶¶‡ßá‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá</span>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary" style="flex: 2;">‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                    <button type="button" class="btn btn-danger" style="flex: 1;" onclick="window.closeModal('discountModal')">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="messageModal">
        <div class="modal-content">
            <h2 class="modal-title"><i class="fas fa-comment-dots"></i> ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶™‡¶æ‡¶†‡¶æ‡¶®</h2>
            
            <div class="message-options" id="messageOptions">
                <div class="message-option" data-message="‡¶ï‡ßç‡¶Ø‡¶æ‡¶™">
                    <div class="message-option-icon"><i class="fas fa-crown"></i></div>
                    <div>
                        <div class="message-option-text">‡¶ï‡ßç‡¶∞‡¶æ‡¶â‡¶®/‡¶ï‡ßç‡¶Ø‡¶æ‡¶™ ‡¶§‡ßà‡¶∞‡¶ø ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá</div>
                        <div class="message-option-desc">‡¶∞‡ßã‡¶ó‡ßÄ‡¶∞ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶™ ‡¶§‡ßà‡¶∞‡¶ø ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá, ‡¶≤‡¶æ‡¶ó‡¶æ‡¶®‡ßã‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ü‡¶∏‡¶§‡ßá ‡¶π‡¶¨‡ßá</div>
                    </div>
                </div>
                <div class="message-option" data-message="‡¶∂‡ßá‡¶∑">
                    <div class="message-option-icon"><i class="fas fa-check-circle"></i></div>
                    <div>
                        <div class="message-option-text">‡¶ö‡¶ø‡¶ï‡¶ø‡ßé‡¶∏‡¶æ ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶ì ‡¶¨‡¶ø‡¶≤ ‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß</div>
                        <div class="message-option-desc">‡¶∏‡¶ï‡¶≤ ‡¶ö‡¶ø‡¶ï‡¶ø‡ßé‡¶∏‡¶æ ‡¶∂‡ßá‡¶∑ ‡¶è‡¶¨‡¶Ç ‡¶¨‡¶ø‡¶≤ ‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶®</div>
                    </div>
                </div>
                <div class="message-option" data-message="‡¶°‡¶ø‡¶â">
                    <div class="message-option-icon"><i class="fas fa-exclamation-triangle"></i></div>
                    <div>
                        <div class="message-option-text">‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ ‡¶ü‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø</div>
                        <div class="message-option-desc">‡¶ö‡¶ø‡¶ï‡¶ø‡ßé‡¶∏‡¶æ‡¶∞ ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ ‡¶ü‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</div>
                    </div>
                </div>
            </div>

            <div class="message-preview" id="messagePreview">
                <div class="message-preview-title"><i class="fas fa-eye"></i> ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶™‡ßç‡¶∞‡¶ø‡¶≠‡¶ø‡¶â:</div>
                <div id="previewText">‡¶è‡¶ï‡¶ü‡¶ø ‡¶Ö‡¶™‡¶∂‡¶® ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</div>
            </div>

            <textarea id="customMessage" class="message-input" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡¶§‡¶ø‡¶∞‡¶ø‡¶ï‡ßç‡¶§ ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®... (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï)"></textarea>

            <div style="display: flex; gap: 10px;">
                <button class="btn btn-info" id="sendMessageBtn" style="flex: 2;">
                    <i class="fas fa-paper-plane"></i> ‡¶™‡¶æ‡¶†‡¶æ‡¶®
                </button>
                <button class="btn btn-danger" style="flex: 1;" onclick="window.closeModal('messageModal')">
                    ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤
                </button>
            </div>
        </div>
    </div>

    <div class="modal" id="patientSelectionModal">
        <div class="modal-content">
            <h2 class="modal-title"><i class="fas fa-users"></i> ‡¶∞‡ßã‡¶ó‡ßÄ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</h2>
            <input type="text" id="modalSearch" class="search-input" placeholder="‡¶®‡¶æ‡¶Æ ‡¶¨‡¶æ ‡¶´‡ßã‡¶® ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®..." style="margin-bottom: 20px;">
            <div id="modalPatientList" class="history-list" style="max-height: 400px;"></div>
            <button class="btn btn-danger" style="margin-top: 20px;" onclick="window.closeModal('patientSelectionModal')">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        </div>
    </div>

    <nav class="bottom-nav">
        <a href="amarghor.html" class="nav-item"><i class="fas fa-home nav-icon"></i><span>‡¶π‡ßã‡¶Æ</span></a>
        <a href="#" class="nav-item active"><i class="fas fa-user nav-icon"></i><span>‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤</span></a>
        <a href="amarghor.html?new=true" class="nav-item"><i class="fas fa-plus-circle nav-icon"></i><span>‡¶®‡¶§‡ßÅ‡¶®</span></a>
        <a href="#" class="nav-item" id="searchNav"><i class="fas fa-search nav-icon"></i><span>‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®</span></a>
    </nav>
   
   <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { 
            getFirestore,
            collection, 
            doc, 
            setDoc, 
            getDoc, 
            getDocs,
            updateDoc, 
            arrayUnion,
            query,
            orderBy,
            limit,
            where,
            writeBatch
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ========== Firebase initialize ==========
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // ========== API_CONFIG ==========
        const API_CONFIG = window.API_CONFIG || {
            baseUrl: "https://bulksmsdhaka.net/api/sendtext",
            apikey: "e7b0da5a67ded72bd064e59bc2c382fc9b946900",
            callerID: "1234"
        };

        // ========== Global Variables ==========
        window.closeModal = function(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.classList.remove('active');
        };

        let currentPatient = null;
        let allPatientsWithSamePhone = [];
        let currentPatientIndex = 0;
        let allTreatments = [];
        let currentFilter = 'all';
        let selectedMessageType = '';

        // ========== Loading functions ==========
        function showLoading() {
            const loader = document.getElementById('authLoading');
            if (loader) {
                loader.style.display = 'flex';
                loader.classList.remove('fade-out');
            }
        }

        function hideLoading() {
            const loader = document.getElementById('authLoading');
            if (loader) {
                loader.classList.add('fade-out');
                setTimeout(() => {
                    loader.style.display = 'none';
                }, 300);
            }
        }

        // ========== Message function ==========
        function showMessage(msg, type = 'info') {
            const container = document.getElementById('messageContainer');
            if (!container) return;
            
            const msgDiv = document.createElement('div');
            msgDiv.className = `message-box message-${type}`;
            msgDiv.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i> ${msg}`;
            container.appendChild(msgDiv);
            setTimeout(() => msgDiv.remove(), 3500);
        }

        // ========== Generate Message ==========
        function generateMessage(type, patientData, treatments) {
            const patientName = patientData?.name || '‡¶≠‡¶æ‡¶≤‡ßã‡¶¨‡¶æ‡¶∏‡¶æ‡¶∞ ‡¶∞‡ßã‡¶ó‡ßÄ';
            
            let totalBill = 0, totalPaid = 0, totalDue = 0;
            let treatmentNames = [];
            
            if (treatments && treatments.length > 0) {
                treatments.forEach(t => {
                    const bill = t.bill || 0;
                    const paid = t.paid || 0;
                    const due = t.due || 0;
                    
                    totalBill += bill;
                    totalPaid += paid;
                    totalDue += due;
                    
                    if (t.problems && t.problems.length) {
                        t.problems.forEach(p => {
                            if (p.problem) treatmentNames.push(p.problem);
                        });
                    } else if (t.name) {
                        treatmentNames.push(t.name);
                    }
                });
            }
            
            treatmentNames = [...new Set(treatmentNames)].filter(n => n).slice(0, 3);
            const treatmentText = treatmentNames.length > 0 ? treatmentNames.join(', ') : '‡¶ö‡¶≤‡¶Æ‡¶æ‡¶® ‡¶ö‡¶ø‡¶ï‡¶ø‡ßé‡¶∏‡¶æ';

            let message = '';

            switch(type) {
                case '‡¶ï‡ßç‡¶Ø‡¶æ‡¶™':
                    message = `‡¶™‡ßç‡¶∞‡¶ø‡¶Ø‡¶º ${patientName},

‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ï‡ßç‡¶∞‡¶æ‡¶â‡¶®/‡¶ï‡ßç‡¶Ø‡¶æ‡¶™‡¶ü‡¶ø‡¶∞ ‡¶ï‡¶æ‡¶ú ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶∏‡ßÅ‡¶¨‡¶ø‡¶ß‡¶æ‡¶Æ‡¶§ ‡¶∏‡¶Æ‡¶Ø‡¶º‡ßá ‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶ö‡ßá‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞‡ßá ‡¶è‡¶∏‡ßá ‡¶∏‡ßá‡¶ü‡¶ø ‡¶≤‡¶æ‡¶ó‡¶ø‡¶Ø‡¶º‡ßá ‡¶®‡¶ø‡¶Ø‡¶º‡ßá ‡¶Ø‡¶æ‡¶®‡•§

${treatmentNames.length > 0 ? '‡¶ö‡¶ø‡¶ï‡¶ø‡ßé‡¶∏‡¶æ‡¶∞ ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£:\n' + treatmentText + '\n\n' : ''}
‡¶ß‡¶®‡ßç‡¶Ø‡¶¨‡¶æ‡¶¶
‡¶ö‡ßå‡¶ß‡ßÅ‡¶∞‡ßÄ ‡¶°‡ßá‡¶®‡ßç‡¶ü‡¶æ‡¶≤ ‡¶ï‡ßá‡¶Ø‡¶º‡¶æ‡¶∞
üìû ‡ß¶‡ßß‡ß≠‡ßß‡ß®-‡ß©‡ß™‡ß´‡ß¨‡ß≠‡ßÆ`;
                    break;

                case '‡¶∂‡ßá‡¶∑':
                    message = `‡¶™‡ßç‡¶∞‡¶ø‡¶Ø‡¶º ${patientName},

‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∏‡¶ï‡¶≤ ‡¶ö‡¶ø‡¶ï‡¶ø‡ßé‡¶∏‡¶æ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶ì‡¶™‡¶∞ ‡¶Ü‡¶∏‡ßç‡¶•‡¶æ ‡¶∞‡¶æ‡¶ñ‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ß‡¶®‡ßç‡¶Ø‡¶¨‡¶æ‡¶¶‡•§

${treatmentNames.length > 0 ? '‡¶ö‡¶ø‡¶ï‡¶ø‡ßé‡¶∏‡¶æ ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£:\n' + treatmentText + '\n\n' : ''}${totalBill > 0 ? `‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ø‡¶≤: ‡ß≥${totalBill}
‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß‡¶ø‡¶§: ‡ß≥${totalPaid}
` : ''}
‡¶≠‡¶¨‡¶ø‡¶∑‡ßç‡¶Ø‡¶§‡ßá ‡¶∏‡ßÅ‡¶∏‡ßç‡¶• ‡¶•‡¶æ‡¶ï‡ßÅ‡¶® ‡¶è‡¶á ‡¶ï‡¶æ‡¶Æ‡¶®‡¶æ ‡¶ï‡¶∞‡¶ø‡•§

‡¶ß‡¶®‡ßç‡¶Ø‡¶¨‡¶æ‡¶¶
‡¶ö‡ßå‡¶ß‡ßÅ‡¶∞‡ßÄ ‡¶°‡ßá‡¶®‡ßç‡¶ü‡¶æ‡¶≤ ‡¶ï‡ßá‡¶Ø‡¶º‡¶æ‡¶∞
üìû ‡ß¶‡ßß‡ß≠‡ßß‡ß®-‡ß©‡ß™‡ß´‡ß¨‡ß≠‡ßÆ`;
                    break;

                case '‡¶°‡¶ø‡¶â':
                    let dueDetails = '';
                    if (treatments && treatments.length > 0) {
                        const dueTreatments = treatments.filter(t => t.due > 0);
                        if (dueTreatments.length > 0) {
                            dueTreatments.forEach((t, index) => {
                                const tName = t.problems?.map(p => p.problem).join(', ') || t.name || '‡¶ö‡¶ø‡¶ï‡¶ø‡ßé‡¶∏‡¶æ';
                                dueDetails += `‚Ä¢ ${tName}: ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ ‡ß≥${t.due}\n`;
                            });
                        }
                    }

                    message = `‡¶™‡ßç‡¶∞‡¶ø‡¶Ø‡¶º ${patientName},

‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ö‡¶ø‡¶ï‡¶ø‡ßé‡¶∏‡¶æ‡¶∞ ‡¶¨‡¶ø‡¶≤ ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£:

${dueDetails || '‚Ä¢ ‡¶ö‡¶≤‡¶Æ‡¶æ‡¶® ‡¶ö‡¶ø‡¶ï‡¶ø‡ßé‡¶∏‡¶æ: ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ ‡¶Ü‡¶õ‡ßá\n'}
${totalDue > 0 ? `‡¶∏‡¶∞‡ßç‡¶¨‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ: ‡ß≥${totalDue}` : ''}
${totalPaid > 0 ? `‡¶Æ‡ßã‡¶ü ‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß‡¶ø‡¶§: ‡ß≥${totalPaid}` : ''}

‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß ‡¶ï‡¶∞‡ßá ‡¶ö‡¶ø‡¶ï‡¶ø‡ßé‡¶∏‡¶æ ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§

‡¶ß‡¶®‡ßç‡¶Ø‡¶¨‡¶æ‡¶¶
‡¶ö‡ßå‡¶ß‡ßÅ‡¶∞‡ßÄ ‡¶°‡ßá‡¶®‡ßç‡¶ü‡¶æ‡¶≤ ‡¶ï‡ßá‡¶Ø‡¶º‡¶æ‡¶∞
üìû ‡ß¶‡ßß‡ß≠‡ßß‡ß®-‡ß©‡ß™‡ß´‡ß¨‡ß≠‡ßÆ`;
                    break;

                default:
                    message = '‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶ü‡¶æ‡¶á‡¶™ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®';
            }

            return message;
        }

        // ========== Send Message ==========
        async function sendMessage() {
            if (!currentPatient) {
                showMessage('‡¶∞‡ßã‡¶ó‡ßÄ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡¶®‡¶ø', 'error');
                return;
            }

            if (!selectedMessageType) {
                showMessage('‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶ü‡¶æ‡¶á‡¶™ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®', 'warning');
                return;
            }

            const customText = document.getElementById('customMessage')?.value.trim() || '';
            let messageText = generateMessage(selectedMessageType, currentPatient.data, allTreatments);

            if (customText) {
                messageText = customText + '\n\n' + messageText;
            }

            const patientPhone = currentPatient.data.phone;
            
            if (!patientPhone || patientPhone === '‚Äî') {
                showMessage('‡¶∞‡ßã‡¶ó‡ßÄ‡¶∞ ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶®‡ßá‡¶á!', 'error');
                return;
            }

            const cleanPhone = patientPhone.replace(/\D/g, '');
            if (cleanPhone.length < 11) {
                showMessage('‡¶∏‡¶†‡¶ø‡¶ï ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶®‡¶Ø‡¶º!', 'error');
                return;
            }
            
            const messagePreview = encodeURIComponent(messageText);
            const whatsappUrl = `https://wa.me/${cleanPhone}?text=${messagePreview}`;
            
            const action = confirm('‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø WhatsApp ‡¶è ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶™‡¶æ‡¶†‡¶æ‡¶§‡ßá ‡¶ö‡¶æ‡¶®?\n"OK" ‡¶ö‡¶æ‡¶™‡¶≤‡ßá WhatsApp ‡¶ñ‡ßÅ‡¶≤‡¶¨‡ßá,\n"Cancel" ‡¶ö‡¶æ‡¶™‡¶≤‡ßá ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶ï‡¶™‡¶ø ‡¶π‡¶¨‡ßá‡•§');
            
            if (action) {
                window.open(whatsappUrl, '_blank');
                closeModal('messageModal');
            } else {
                try {
                    await navigator.clipboard.writeText(messageText);
                    showMessage('üìã ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶ï‡¶™‡¶ø ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá! ‡¶è‡¶ñ‡¶® ‡¶Ü‡¶™‡¶®‡¶ø ‡¶Ø‡ßá‡¶ï‡ßã‡¶®‡ßã ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡ßá ‡¶™‡ßá‡¶∏‡ßç‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®‡•§', 'success');
                    closeModal('messageModal');
                } catch (err) {
                    showMessage('‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ!', 'error');
                }
            }
        }

        // ========== ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® (‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶†‡¶ø‡¶ï ‡¶ï‡¶∞‡¶æ) ==========
        async function processPayment(e) {
            e.preventDefault();
            
            const amount = parseFloat(document.getElementById('paymentAmount').value);
            const notes = document.getElementById('paymentNotes').value.trim();
            
            if (!amount || amount <= 0) {
                showMessage('‡¶∏‡¶†‡¶ø‡¶ï ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶¶‡¶ø‡¶®', 'error');
                return;
            }
            
            if (!currentPatient) {
                showMessage('‡¶∞‡ßã‡¶ó‡ßÄ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡¶®‡¶ø', 'error');
                return;
            }
            
            try {
                showLoading();
                
                const patientRef = doc(db, "patients", currentPatient.id);
                const patientSnap = await getDoc(patientRef);
                
                if (!patientSnap.exists()) {
                    showMessage('‡¶∞‡ßã‡¶ó‡ßÄ‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø', 'error');
                    return;
                }
                
                const patientData = patientSnap.data();
                const treatments = patientData.treatments || [];
                
                // ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡¶ø (‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡¶ø ‡¶•‡ßá‡¶ï‡ßá ‡¶ï‡ßç‡¶Ø‡¶æ‡¶≤‡¶ï‡ßÅ‡¶≤‡ßá‡¶ü ‡¶ï‡¶∞‡ßá)
                let totalDue = 0;
                treatments.forEach(t => {
                    const bill = t.bill || 
                               (t.problems ? t.problems.reduce((sum, p) => sum + (parseFloat(p.cost) || 0), 0) : 0);
                    
                    // ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡¶ø ‡¶•‡ßá‡¶ï‡ßá ‡¶™‡ßá‡¶á‡¶° ‡¶ï‡ßç‡¶Ø‡¶æ‡¶≤‡¶ï‡ßÅ‡¶≤‡ßá‡¶ü ‡¶ï‡¶∞‡¶ø
                    let paid = 0;
                    if (t.paymentHistory && t.paymentHistory.length) {
                        paid = t.paymentHistory.reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);
                    } else {
                        paid = parseFloat(t.paid || 0);
                    }
                    
                    // ‡¶°‡¶ø‡¶∏‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡¶ø ‡¶•‡ßá‡¶ï‡ßá ‡¶°‡¶ø‡¶∏‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶ï‡ßç‡¶Ø‡¶æ‡¶≤‡¶ï‡ßÅ‡¶≤‡ßá‡¶ü ‡¶ï‡¶∞‡¶ø
                    let discount = 0;
                    if (t.discountHistory && t.discountHistory.length) {
                        discount = t.discountHistory.reduce((sum, d) => sum + (parseFloat(d.amount) || 0), 0);
                    } else {
                        discount = parseFloat(t.discount || 0);
                    }
                    
                    const due = Math.max(0, bill - (paid + discount));
                    totalDue += due;
                });
                
                // ‡¶Ø‡¶¶‡¶ø ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡ßá
                if (totalDue <= 0) {
                    showMessage('‡¶è‡¶á ‡¶∞‡ßã‡¶ó‡ßÄ‡¶∞ ‡¶ï‡ßã‡¶®‡ßã ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ ‡¶®‡ßá‡¶á!', 'warning');
                    hideLoading();
                    closeModal('paymentModal');
                    return;
                }
                
                // ‡¶Ø‡¶¶‡¶ø ‡¶¶‡ßá‡¶ì‡¶Ø‡¶º‡¶æ ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶ö‡ßá‡¶Ø‡¶º‡ßá ‡¶¨‡ßá‡¶∂‡¶ø ‡¶π‡¶Ø‡¶º
                if (amount > totalDue) {
                    showMessage(`‡¶Ü‡¶™‡¶®‡¶ø ‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶ö‡ßá‡¶Ø‡¶º‡ßá ‡¶¨‡ßá‡¶∂‡¶ø ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶¶‡¶ø‡¶§‡ßá ‡¶ö‡¶æ‡¶ö‡ßç‡¶õ‡ßá‡¶®! ‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ: ‡ß≥${totalDue}`, 'error');
                    hideLoading();
                    return;
                }
                
                let remainingAmount = amount;
                
                // ‡¶ü‡ßç‡¶∞‡¶ø‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶ø
                const updatedTreatments = treatments.map(treatment => {
                    if (remainingAmount <= 0) return treatment;
                    
                    // ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶¨‡¶ø‡¶≤ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶≤‡¶ï‡ßÅ‡¶≤‡ßá‡¶ü ‡¶ï‡¶∞‡¶ø
                    const currentBill = treatment.bill || 
                                       (treatment.problems ? treatment.problems.reduce((sum, p) => sum + (parseFloat(p.cost) || 0), 0) : 0);
                    
                    // ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶™‡ßá‡¶á‡¶° ‡¶ï‡ßç‡¶Ø‡¶æ‡¶≤‡¶ï‡ßÅ‡¶≤‡ßá‡¶ü ‡¶ï‡¶∞‡¶ø (‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡¶ø ‡¶•‡ßá‡¶ï‡ßá)
                    let currentPaid = 0;
                    if (treatment.paymentHistory && treatment.paymentHistory.length) {
                        currentPaid = treatment.paymentHistory.reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);
                    } else {
                        currentPaid = parseFloat(treatment.paid || 0);
                    }
                    
                    // ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶°‡¶ø‡¶∏‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶ï‡ßç‡¶Ø‡¶æ‡¶≤‡¶ï‡ßÅ‡¶≤‡ßá‡¶ü ‡¶ï‡¶∞‡¶ø (‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡¶ø ‡¶•‡ßá‡¶ï‡ßá)
                    let currentDiscount = 0;
                    if (treatment.discountHistory && treatment.discountHistory.length) {
                        currentDiscount = treatment.discountHistory.reduce((sum, d) => sum + (parseFloat(d.amount) || 0), 0);
                    } else {
                        currentDiscount = parseFloat(treatment.discount || 0);
                    }
                    
                    const currentDue = Math.max(0, currentBill - (currentPaid + currentDiscount));
                    
                    if (currentDue <= 0) return treatment;
                    
                    // ‡¶è‡¶á ‡¶ü‡ßç‡¶∞‡¶ø‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ï‡¶§ ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶¶‡ßá‡¶¨‡ßá‡¶®
                    const paymentForThis = Math.min(remainingAmount, currentDue);
                    remainingAmount -= paymentForThis;
                    
                    // ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶≤‡¶ó ‡¶§‡ßà‡¶∞‡¶ø
                    const paymentLog = {
                        amount: paymentForThis,
                        date: new Date().toLocaleDateString('bn-BD'),
                        time: new Date().toLocaleTimeString('bn-BD'),
                        notes: notes || '‡¶ü‡¶æ‡¶ï‡¶æ ‡¶ú‡¶Æ‡¶æ',
                        timestamp: new Date().toISOString()
                    };
                    
                    // ‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡¶ø
                    const paymentHistory = [...(treatment.paymentHistory || []), paymentLog];
                    
                    // ‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡ßá‡¶á‡¶° ‡¶ü‡ßã‡¶ü‡¶æ‡¶≤
                    const newPaid = currentPaid + paymentForThis;
                    
                    // ‡¶®‡¶§‡ßÅ‡¶® ‡¶°‡¶ø‡¶â (‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡¶ø ‡¶•‡ßá‡¶ï‡ßá ‡¶ï‡ßç‡¶Ø‡¶æ‡¶≤‡¶ï‡ßÅ‡¶≤‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶¨‡ßá, ‡¶Ü‡¶≤‡¶æ‡¶¶‡¶æ due ‡¶´‡¶ø‡¶≤‡ßç‡¶° ‡¶®‡¶æ ‡¶∞‡¶æ‡¶ñ‡¶≤‡ßá‡¶ì ‡¶ö‡¶≤‡ßá)
                    const newDue = currentBill - (newPaid + currentDiscount);
                    
                    return {
                        ...treatment,
                        paymentHistory: paymentHistory,
                        // due ‡¶´‡¶ø‡¶≤‡ßç‡¶° ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ (‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡¶ø ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡¶Ø‡¶º‡ßÄ)
                        due: newDue > 0 ? newDue : 0
                    };
                });
                
                // ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶∏ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
                await updateDoc(patientRef, { 
                    treatments: updatedTreatments,
                    lastUpdated: new Date().toISOString(),
                    lastPayment: {
                        amount: amount,
                        date: new Date().toISOString(),
                        notes: notes
                    }
                });
                
                showMessage(`‚úÖ ‡ß≥${amount} ‡¶ú‡¶Æ‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá`, 'success');
                closeModal('paymentModal');
                document.getElementById('paymentForm').reset();
                
                // ‡¶∞‡¶ø‡¶≤‡ßã‡¶° ‡¶™‡ßá‡¶∂‡ßá‡¶®‡ßç‡¶ü ‡¶°‡¶æ‡¶ü‡¶æ
                await loadPatientsByPhone(currentPatient.data.phone, currentPatient.id);
                
            } catch (error) {
                console.error("Payment error:", error);
                showMessage('‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶®‡¶ø‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ! ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // ========== ‡¶°‡¶ø‡¶∏‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® (‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶†‡¶ø‡¶ï ‡¶ï‡¶∞‡¶æ) ==========
        async function applyDiscount(e) {
            e.preventDefault();
            
            const treatmentIndex = parseInt(document.getElementById('treatmentSelect').value);
            const discount = parseFloat(document.getElementById('discountAmount').value);
            
            if (isNaN(treatmentIndex) || !discount || discount <= 0) {
                showMessage('‡¶∏‡¶¨ ‡¶§‡¶•‡ßç‡¶Ø ‡¶¶‡¶ø‡¶®', 'error');
                return;
            }
            
            if (!currentPatient) {
                showMessage('‡¶∞‡ßã‡¶ó‡ßÄ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡¶®‡¶ø', 'error');
                return;
            }
            
            try {
                showLoading();
                
                const patientRef = doc(db, "patients", currentPatient.id);
                const patientSnap = await getDoc(patientRef);
                
                if (!patientSnap.exists()) {
                    showMessage('‡¶∞‡ßã‡¶ó‡ßÄ‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø', 'error');
                    return;
                }
                
                const patientData = patientSnap.data();
                const treatments = patientData.treatments || [];
                
                if (treatmentIndex >= treatments.length) {
                    showMessage('‡¶≠‡ßÅ‡¶≤ ‡¶ö‡¶ø‡¶ï‡¶ø‡ßé‡¶∏‡¶æ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶®', 'error');
                    return;
                }
                
                const treatment = treatments[treatmentIndex];
                
                // ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶¨‡¶ø‡¶≤ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶≤‡¶ï‡ßÅ‡¶≤‡ßá‡¶ü ‡¶ï‡¶∞‡¶ø
                const currentBill = treatment.bill || 
                                   (treatment.problems ? treatment.problems.reduce((sum, p) => sum + (parseFloat(p.cost) || 0), 0) : 0);
                
                // ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶™‡ßá‡¶á‡¶° ‡¶ï‡ßç‡¶Ø‡¶æ‡¶≤‡¶ï‡ßÅ‡¶≤‡ßá‡¶ü ‡¶ï‡¶∞‡¶ø (‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡¶ø ‡¶•‡ßá‡¶ï‡ßá)
                let currentPaid = 0;
                if (treatment.paymentHistory && treatment.paymentHistory.length) {
                    currentPaid = treatment.paymentHistory.reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);
                } else {
                    currentPaid = parseFloat(treatment.paid || 0);
                }
                
                // ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶°‡¶ø‡¶∏‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶ï‡ßç‡¶Ø‡¶æ‡¶≤‡¶ï‡ßÅ‡¶≤‡ßá‡¶ü ‡¶ï‡¶∞‡¶ø (‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡¶ø ‡¶•‡ßá‡¶ï‡ßá)
                let currentDiscount = 0;
                if (treatment.discountHistory && treatment.discountHistory.length) {
                    currentDiscount = treatment.discountHistory.reduce((sum, d) => sum + (parseFloat(d.amount) || 0), 0);
                } else {
                    currentDiscount = parseFloat(treatment.discount || 0);
                }
                
                const currentDue = Math.max(0, currentBill - (currentPaid + currentDiscount));
                
                if (currentDue <= 0) {
                    showMessage('‡¶è‡¶á ‡¶ö‡¶ø‡¶ï‡¶ø‡ßé‡¶∏‡¶æ‡¶∞ ‡¶ï‡ßã‡¶®‡ßã ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ ‡¶®‡ßá‡¶á!', 'warning');
                    hideLoading();
                    return;
                }
                
                if (discount > currentDue) {
                    showMessage(`‡¶°‡¶ø‡¶∏‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶¨‡ßá‡¶∂‡¶ø ‡¶π‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá ‡¶®‡¶æ! ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ: ‡ß≥${currentDue}`, 'error');
                    return;
                }
                
                // ‡¶°‡¶ø‡¶∏‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶≤‡¶ó ‡¶§‡ßà‡¶∞‡¶ø
                const discountLog = {
                    amount: discount,
                    date: new Date().toLocaleDateString('bn-BD'),
                    time: new Date().toLocaleTimeString('bn-BD'),
                    type: '‡¶°‡¶ø‡¶∏‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü',
                    timestamp: new Date().toISOString()
                };
                
                // ‡¶°‡¶ø‡¶∏‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡¶ø
                const discountHistory = [...(treatment.discountHistory || []), discountLog];
                
                // ‡¶®‡¶§‡ßÅ‡¶® ‡¶°‡¶ø‡¶∏‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶ü‡ßã‡¶ü‡¶æ‡¶≤
                const newDiscount = currentDiscount + discount;
                
                // ‡¶®‡¶§‡ßÅ‡¶® ‡¶°‡¶ø‡¶â
                const newDue = currentDue - discount;
                
                const updatedTreatments = treatments.map((t, idx) => {
                    if (idx === treatmentIndex) {
                        return { 
                            ...t, 
                            discountHistory: discountHistory,
                            due: newDue
                        };
                    }
                    return t;
                });
                
                await updateDoc(patientRef, { 
                    treatments: updatedTreatments,
                    lastUpdated: new Date().toISOString()
                });
                
                showMessage(`‚úÖ ‡ß≥${discount} ‡¶°‡¶ø‡¶∏‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶¶‡ßá‡¶ì‡¶Ø‡¶º‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá`, 'success');
                closeModal('discountModal');
                document.getElementById('discountAmount').value = '';
                document.getElementById('treatmentSelect').value = '';
                
                // ‡¶∞‡¶ø‡¶≤‡ßã‡¶° ‡¶™‡ßá‡¶∂‡ßá‡¶®‡ßç‡¶ü ‡¶°‡¶æ‡¶ü‡¶æ
                await loadPatientsByPhone(currentPatient.data.phone, currentPatient.id);
                
            } catch (error) {
                console.error("Discount error:", error);
                showMessage('‡¶°‡¶ø‡¶∏‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶¶‡¶ø‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ! ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // ========== ‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶∞‡ßã‡¶ó‡ßÄ ‡¶≤‡ßã‡¶° ==========
        async function loadPatientsByPhone(phone, selectedProfileId = null) {
            try {
                showLoading();
                
                if (!phone) {
                    showMessage('‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶®‡ßá‡¶á!', 'error');
                    return;
                }
                
                const q = query(collection(db, "patients"), where("phone", "==", phone));
                const snapshot = await getDocs(q);
                
                allPatientsWithSamePhone = [];
                snapshot.forEach(doc => {
                    allPatientsWithSamePhone.push({ id: doc.id, data: doc.data() });
                });
                
                if (allPatientsWithSamePhone.length === 0) {
                    showMessage('‡¶ï‡ßã‡¶®‡ßã ‡¶∞‡ßã‡¶ó‡ßÄ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø!', 'error');
                    hideLoading();
                    return;
                }
                
                // ‡¶∏‡¶∞‡ßç‡¶¨‡¶∂‡ßá‡¶∑ ‡¶ü‡ßç‡¶∞‡¶ø‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡¶Ø‡¶º‡ßÄ ‡¶∏‡¶æ‡¶ú‡¶æ‡¶á
                allPatientsWithSamePhone.sort((a, b) => {
                    const aTreatments = a.data.treatments || [];
                    const bTreatments = b.data.treatments || [];
                    
                    const aLastDate = aTreatments.length > 0 ? 
                        (aTreatments[aTreatments.length-1].timestamp || aTreatments[aTreatments.length-1].date || 0) : 0;
                    const bLastDate = bTreatments.length > 0 ? 
                        (bTreatments[bTreatments.length-1].timestamp || bTreatments[bTreatments.length-1].date || 0) : 0;
                    
                    return new Date(bLastDate) - new Date(aLastDate);
                });
                
                if (selectedProfileId) {
                    const index = allPatientsWithSamePhone.findIndex(p => p.id === selectedProfileId);
                    if (index !== -1) currentPatientIndex = index;
                    else currentPatientIndex = 0;
                } else {
                    currentPatientIndex = 0;
                }
                
                await loadCurrentPatient();
                updatePatientSwitcher();
                
            } catch (error) {
                console.error("Load patients error:", error);
                showMessage("‡¶∞‡ßã‡¶ó‡ßÄ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ! " + error.message, "error");
            } finally {
                hideLoading();
            }
        }

        // ========== ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶∞‡ßã‡¶ó‡ßÄ ‡¶≤‡ßã‡¶° ==========
        async function loadCurrentPatient() {
            if (!allPatientsWithSamePhone.length) return;
            currentPatient = allPatientsWithSamePhone[currentPatientIndex];
            displayPatientData(currentPatient.data);
        }

        // ========== ‡¶™‡ßá‡¶∂‡ßá‡¶®‡ßç‡¶ü ‡¶°‡¶æ‡¶ü‡¶æ ‡¶°‡¶ø‡¶∏‡¶™‡ßç‡¶≤‡ßá (‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶†‡¶ø‡¶ï ‡¶ï‡¶∞‡¶æ) ==========
        function displayPatientData(data) {
            document.getElementById('patientName').textContent = data.name || '‚Äî';
            document.getElementById('patientPhone').textContent = `‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤: ${data.phone || '‚Äî'}`;
            document.getElementById('patientAddress').textContent = `‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ: ${data.address || '‚Äî'}`;
            document.getElementById('patientAge').textContent = `‡¶¨‡¶Ø‡¶º‡¶∏: ${data.age || '‚Äî'} ‡¶¨‡¶õ‡¶∞`;
            
            let totalBill = 0, totalPaid = 0, totalDue = 0;
            
            allTreatments = (data.treatments || []).map((t, originalIndex) => {
                // ‡¶¨‡¶ø‡¶≤ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶≤‡¶ï‡ßÅ‡¶≤‡ßá‡¶∂‡¶®
                let bill = 0;
                if (t.problems && t.problems.length) {
                    bill = t.problems.reduce((sum, p) => sum + (parseFloat(p.cost) || 0), 0);
                } else {
                    bill = parseFloat(t.bill || t.netBill || t.total || 0);
                }
                
                // ‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß‡¶ø‡¶§ ‡¶ü‡¶æ‡¶ï‡¶æ - ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡¶ø ‡¶•‡ßá‡¶ï‡ßá ‡¶ï‡ßç‡¶Ø‡¶æ‡¶≤‡¶ï‡ßÅ‡¶≤‡ßá‡¶ü ‡¶ï‡¶∞‡¶ø
                let paid = 0;
                if (t.paymentHistory && t.paymentHistory.length) {
                    paid = t.paymentHistory.reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);
                } else {
                    paid = parseFloat(t.paid || 0);
                }
                
                // ‡¶°‡¶ø‡¶∏‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü - ‡¶°‡¶ø‡¶∏‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡¶ø ‡¶•‡ßá‡¶ï‡ßá ‡¶ï‡ßç‡¶Ø‡¶æ‡¶≤‡¶ï‡ßÅ‡¶≤‡ßá‡¶ü ‡¶ï‡¶∞‡¶ø
                let discount = 0;
                if (t.discountHistory && t.discountHistory.length) {
                    discount = t.discountHistory.reduce((sum, d) => sum + (parseFloat(d.amount) || 0), 0);
                } else {
                    discount = parseFloat(t.discount || 0);
                }
                
                // ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ = ‡¶¨‡¶ø‡¶≤ - (‡¶™‡ßá‡¶á‡¶° + ‡¶°‡¶ø‡¶∏‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü)
                const due = Math.max(0, bill - (paid + discount));
                
                const hasCrown = t.problems?.some(p => p.crownType) || t.crownType ? true : false;
                
                totalBill += bill;
                totalPaid += paid;
                totalDue += due;
                
                return { 
                    ...t, 
                    originalIndex: originalIndex,
                    bill, 
                    paid, 
                    due, 
                    discount,
                    isPaid: due <= 0,
                    hasCrown
                };
            }).reverse(); // ‡¶®‡¶§‡ßÅ‡¶®‡¶ó‡ßÅ‡¶≤‡ßã ‡¶Ü‡¶ó‡ßá ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶∞‡¶ø‡¶≠‡¶æ‡¶∞‡ßç‡¶∏
            
            document.getElementById('totalBill').textContent = `‡ß≥${totalBill}`;
            document.getElementById('totalPaid').textContent = `‡ß≥${totalPaid}`;
            document.getElementById('totalDue').textContent = `‡ß≥${totalDue}`;
            document.getElementById('totalTreatments').textContent = allTreatments.length;
            document.getElementById('historyCount').textContent = `${allTreatments.length} ‡¶ü‡¶ø`;
            
            updateTreatmentHistory();
            loadMonthlyStats();
            populateTreatmentSelect();
        }

        // ========== ‡¶ö‡¶ø‡¶ï‡¶ø‡ßé‡¶∏‡¶æ‡¶∞ ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ==========
        function updateTreatmentHistory() {
            let filtered = allTreatments;
            
            if (currentFilter === 'due') filtered = allTreatments.filter(t => t.due > 0);
            else if (currentFilter === 'paid') filtered = allTreatments.filter(t => t.due <= 0);
            else if (currentFilter === 'crown') filtered = allTreatments.filter(t => t.hasCrown);
            
            const container = document.getElementById('treatmentHistory');
            
            if (!filtered.length) {
                container.innerHTML = '<div class="empty-state"><i class="fas fa-search"></i><p>‡¶ï‡ßã‡¶®‡ßã ‡¶ö‡¶ø‡¶ï‡¶ø‡ßé‡¶∏‡¶æ ‡¶®‡ßá‡¶á</p></div>';
                return;
            }
            
            let html = '';
            filtered.forEach(t => {
                const cardClass = t.due <= 0 ? 'paid' : (t.hasCrown ? 'crown' : 'due');
                
                html += `
                    <div class="treatment-card ${cardClass}">
                        <div class="card-header">
                            <span class="card-date"><i class="far fa-calendar-alt"></i> ${t.date || '‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶®‡ßá‡¶á'}</span>
                            <span class="card-amount">‡ß≥${t.bill}</span>
                        </div>
                        
                        <div class="problem-list">
                            ${(t.problems && t.problems.length ? t.problems : [{
                                problem: t.name || t.problem || '‡¶ö‡¶ø‡¶ï‡¶ø‡ßé‡¶∏‡¶æ',
                                cost: t.cost || t.bill || 0,
                                discount: t.discount || 0,
                                crownType: t.crownType,
                                crownShade: t.crownShade,
                                crownQty: t.crownQty || 1
                            }]).map(p => `
                                <div class="problem-item">
                                    <div class="problem-name">${p.problem || p.name || '‡¶ö‡¶ø‡¶ï‡¶ø‡ßé‡¶∏‡¶æ'}</div>
                                    <div class="problem-detail">
                                        <span>‡¶¨‡¶ø‡¶≤: ‡ß≥${p.cost || 0}</span>
                                        <span>‡¶°‡¶ø‡¶∏‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü: ‡ß≥${p.discount || 0}</span>
                                    </div>
                                    ${p.crownType ? `
                                        <div class="crown-info">
                                            <i class="fas fa-crown"></i> ${p.crownType} | ‡¶∂‡ßá‡¶°: ${p.crownShade || 'A2'} | √ó${p.crownQty || 1}
                                        </div>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; margin-top: 10px; padding: 0 5px;">
                            <span><strong>‡¶ú‡¶Æ‡¶æ:</strong> ‡ß≥${t.paid}</span>
                            <span><strong>‡¶°‡¶ø‡¶∏‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü:</strong> ‡ß≥${t.discount || 0}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 5px; padding: 0 5px; font-weight: bold;">
                            <span style="color: ${t.due > 0 ? 'var(--danger)' : 'var(--success)'};">‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ: ‡ß≥${t.due}</span>
                        </div>
                        
                        ${t.paymentHistory?.length ? `
                            <div class="payment-log">
                                <div style="font-weight:600; margin-bottom:8px;">üìù ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶≤‡¶ó:</div>
                                ${t.paymentHistory.map(log => `
                                    <div class="log-item">
                                        <span>${log.time || log.date}</span>
                                        <span style="color:var(--success);">+ ‡ß≥${log.amount}</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        ${t.discountHistory?.length ? `
                            <div class="payment-log" style="background: var(--warning-light);">
                                <div style="font-weight:600; margin-bottom:8px;">üè∑Ô∏è ‡¶°‡¶ø‡¶∏‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶≤‡¶ó:</div>
                                ${t.discountHistory.map(log => `
                                    <div class="log-item">
                                        <span>${log.time || log.date}</span>
                                        <span style="color:var(--warning);">- ‡ß≥${log.amount}</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // ========== ‡¶™‡ßá‡¶∂‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡ßç‡¶Ø‡ßÅ‡¶á‡¶ö‡¶æ‡¶∞ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ==========
        function updatePatientSwitcher() {
            const switcher = document.getElementById('patientSwitcher');
            if (allPatientsWithSamePhone.length > 1) {
                switcher.style.display = 'flex';
                document.getElementById('patientCount').textContent = `${currentPatientIndex+1}/${allPatientsWithSamePhone.length}`;
            } else {
                switcher.style.display = 'none';
            }
        }

        // ========== ‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶™‡¶∞‡¶ø‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ‡¶® ‡¶≤‡ßã‡¶° ==========
        async function loadMonthlyStats() {
            try {
                const snapshot = await getDocs(collection(db, "patients"));
                const months = {};
                const monthNames = ['‡¶ú‡¶æ‡¶®‡ßÅ‡¶Ø‡¶º‡¶æ‡¶∞‡¶ø', '‡¶´‡ßá‡¶¨‡ßç‡¶∞‡ßÅ‡¶Ø‡¶º‡¶æ‡¶∞‡¶ø', '‡¶Æ‡¶æ‡¶∞‡ßç‡¶ö', '‡¶è‡¶™‡ßç‡¶∞‡¶ø‡¶≤', '‡¶Æ‡ßá', '‡¶ú‡ßÅ‡¶®', 
                                   '‡¶ú‡ßÅ‡¶≤‡¶æ‡¶á', '‡¶Ü‡¶ó‡¶∏‡ßç‡¶ü', '‡¶∏‡ßá‡¶™‡ßç‡¶ü‡ßá‡¶Æ‡ßç‡¶¨‡¶∞', '‡¶Ö‡¶ï‡ßç‡¶ü‡ßã‡¶¨‡¶∞', '‡¶®‡¶≠‡ßá‡¶Æ‡ßç‡¶¨‡¶∞', '‡¶°‡¶ø‡¶∏‡ßá‡¶Æ‡ßç‡¶¨‡¶∞'];
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    (data.treatments || []).forEach(t => {
                        if (t.timestamp || t.date) {
                            const date = new Date(t.timestamp || t.date);
                            if (!isNaN(date.getTime())) {
                                const monthKey = `${date.getFullYear()}-${date.getMonth()}`;
                                
                                if (!months[monthKey]) {
                                    months[monthKey] = { 
                                        name: `${monthNames[date.getMonth()]} ${date.getFullYear()}`, 
                                        patients: 0, 
                                        bill: 0,
                                        paid: 0
                                    };
                                }
                                
                                months[monthKey].patients++;
                                
                                const bill = t.bill || 
                                           (t.problems ? t.problems.reduce((sum, p) => sum + (parseFloat(p.cost) || 0), 0) : 0);
                                months[monthKey].bill += bill;
                                
                                // ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡¶ø ‡¶•‡ßá‡¶ï‡ßá ‡¶™‡ßá‡¶á‡¶° ‡¶ï‡ßç‡¶Ø‡¶æ‡¶≤‡¶ï‡ßÅ‡¶≤‡ßá‡¶ü ‡¶ï‡¶∞‡¶ø
                                if (t.paymentHistory && t.paymentHistory.length) {
                                    const paid = t.paymentHistory.reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);
                                    months[monthKey].paid += paid;
                                } else {
                                    months[monthKey].paid += (parseFloat(t.paid || 0));
                                }
                            }
                        }
                    });
                });
                
                const sortedMonths = Object.values(months).sort((a, b) => {
                    return new Date(b.name) - new Date(a.name);
                }).slice(0, 6);
                
                const container = document.getElementById('monthlyData');
                container.innerHTML = sortedMonths.map(m => `
                    <div class="month-card">
                        <div class="month-name">${m.name}</div>
                        <div class="month-value">${m.patients}</div>
                        <div class="month-small">‡¶∞‡ßã‡¶ó‡ßÄ</div>
                        <div class="month-value" style="font-size:1rem;">‡ß≥${m.bill}</div>
                        <div class="month-small">‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ø‡¶≤</div>
                        <div class="month-value" style="font-size:0.9rem; color:var(--success);">‡ß≥${m.paid}</div>
                        <div class="month-small">‡¶Ü‡¶¶‡¶æ‡ßü</div>
                    </div>
                `).join('') || '<div class="empty-state">‡¶ï‡ßã‡¶®‡ßã ‡¶°‡ßá‡¶ü‡¶æ ‡¶®‡ßá‡¶á</div>';
                
            } catch (error) {
                console.error("Monthly stats error:", error);
            }
        }

        // ========== ‡¶°‡¶ø‡¶∏‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ü‡ßç‡¶∞‡¶ø‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ==========
        function populateTreatmentSelect() {
            const select = document.getElementById('treatmentSelect');
            if (!select) return;
            
            select.innerHTML = '<option value="">‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</option>';
            
            // ‡¶Ö‡¶∞‡¶ø‡¶ú‡¶ø‡¶®‡¶æ‡¶≤ ‡¶á‡¶®‡¶°‡ßá‡¶ï‡ßç‡¶∏ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶ø
            const treatmentsWithDue = allTreatments.filter(t => t.due > 0);
            
            treatmentsWithDue.forEach(t => {
                const option = document.createElement('option');
                option.value = t.originalIndex; // ‡¶Ö‡¶∞‡¶ø‡¶ú‡¶ø‡¶®‡¶æ‡¶≤ ‡¶á‡¶®‡¶°‡ßá‡¶ï‡ßç‡¶∏ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞
                option.textContent = `${t.date || '‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶®‡ßá‡¶á'} - ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ: ‡ß≥${t.due}`;
                select.appendChild(option);
            });
            
            if (treatmentsWithDue.length === 0) {
                const option = document.createElement('option');
                option.value = "";
                option.textContent = "‡¶ï‡ßã‡¶®‡ßã ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ ‡¶®‡ßá‡¶á";
                option.disabled = true;
                select.appendChild(option);
            }
        }

        // ========== ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® ==========
        async function searchPatient() {
            const phone = document.getElementById('searchPhone').value.trim();
            
            if (!phone) {
                showMessage('‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¶‡¶ø‡¶®', 'warning');
                return;
            }
            
            try {
                showLoading();
                
                const q = query(collection(db, "patients"), where("phone", "==", phone));
                const snapshot = await getDocs(q);
                
                const results = [];
                snapshot.forEach(doc => {
                    results.push({ id: doc.id, data: doc.data() });
                });
                
                const resultDiv = document.getElementById('searchResult');
                
                if (results.length === 0) {
                    resultDiv.style.display = 'block';
                    resultDiv.innerHTML = `
                        <div style="background: #fff3cd; padding: 15px; border-radius: 18px;">
                            <p><i class="fas fa-exclamation-triangle" style="color: #856404;"></i> ‡¶è‡¶á ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶∞‡ßã‡¶ó‡ßÄ ‡¶®‡ßá‡¶á</p>
                            <button class="btn btn-primary" style="margin-top: 10px;" onclick="window.location.href='amarghor.html?phone=${phone}'">
                                <i class="fas fa-plus"></i> ‡¶®‡¶§‡ßÅ‡¶® ‡¶∞‡ßã‡¶ó‡ßÄ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®
                            </button>
                        </div>
                    `;
                } else {
                    resultDiv.style.display = 'block';
                    let html = '<div style="background: #d4edda; padding: 15px; border-radius: 18px;">';
                    html += `<p><i class="fas fa-check-circle" style="color: #155724;"></i> ${results.length} ‡¶ú‡¶® ‡¶∞‡ßã‡¶ó‡ßÄ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶ó‡ßá‡¶õ‡ßá</p>`;
                    
                    results.forEach(r => {
                        html += `
                            <div style="background: white; padding: 10px; border-radius: 12px; margin-top: 10px; cursor: pointer;" 
                                 onclick="window.location.href='?profileId=${r.id}'">
                                <strong>${r.data.name}</strong><br>
                                <small>üìû ${r.data.phone} | üè† ${r.data.address || '‚Äî'}</small>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                    resultDiv.innerHTML = html;
                }
                
            } catch (error) {
                console.error("Search error:", error);
                showMessage('‡¶ñ‡ßÅ‡¶Å‡¶ú‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ!', 'error');
            } finally {
                hideLoading();
            }
        }

        // ========== ‡¶á‡¶®‡¶ø‡¶∂‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤‡¶æ‡¶á‡¶ú ==========
        async function init() {
            const urlParams = new URLSearchParams(window.location.search);
            const profileId = urlParams.get('profileId');
            
            if (!profileId) {
                window.location.href = "amarghor.html";
                return;
            }
            
            try {
                const patientDoc = doc(db, "patients", profileId);
                const patientSnap = await getDoc(patientDoc);
                
                if (patientSnap.exists()) {
                    const data = patientSnap.data();
                    await loadPatientsByPhone(data.phone, profileId);
                } else {
                    showMessage("‡¶∞‡ßã‡¶ó‡ßÄ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø!", "error");
                    setTimeout(() => {
                        window.location.href = "amarghor.html";
                    }, 2000);
                }
            } catch (error) {
                console.error("Init error:", error);
                showMessage("‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ! " + error.message, "error");
            }
        }

        // ========== ‡¶∏‡¶¨ ‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü ‡¶≤‡¶ø‡¶∏‡ßá‡¶®‡¶æ‡¶∞ ==========
        document.addEventListener('DOMContentLoaded', () => {
            // ‡¶®‡ßá‡¶≠‡¶ø‡¶ó‡ßá‡¶∂‡¶®
            document.getElementById('backBtn')?.addEventListener('click', () => window.history.back());
            document.getElementById('homeBtn')?.addEventListener('click', () => window.location.href = 'amarghor.html');
            
            // ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶¨‡¶æ‡¶ü‡¶®
            document.getElementById('addPaymentBtn')?.addEventListener('click', () => {
                const totalDueText = document.getElementById('totalDue').textContent.replace('‡ß≥', '');
                const totalDue = parseFloat(totalDueText) || 0;
                
                if (totalDue <= 0) {
                    showMessage('‡¶è‡¶á ‡¶∞‡ßã‡¶ó‡ßÄ‡¶∞ ‡¶ï‡ßã‡¶®‡ßã ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ ‡¶®‡ßá‡¶á!', 'warning');
                    return;
                }
                
                document.getElementById('paymentForm').reset();
                document.getElementById('paymentModal')?.classList.add('active');
            });
            
            // ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶´‡¶∞‡ßç‡¶Æ ‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü
            document.getElementById('paymentForm')?.addEventListener('submit', processPayment);
            
            // ‡¶°‡¶ø‡¶∏‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶¨‡¶æ‡¶ü‡¶®
            document.getElementById('discountBtn')?.addEventListener('click', () => {
                const hasDue = allTreatments.some(t => t.due > 0);
                if (hasDue) {
                    populateTreatmentSelect();
                    document.getElementById('discountModal')?.classList.add('active');
                } else {
                    showMessage('‡¶ï‡ßã‡¶®‡ßã ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ ‡¶®‡ßá‡¶á!', 'warning');
                }
            });
            
            // ‡¶°‡¶ø‡¶∏‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶´‡¶∞‡ßç‡¶Æ ‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü
            document.getElementById('discountForm')?.addEventListener('submit', applyDiscount);
            
            // ‡¶®‡¶§‡ßÅ‡¶® ‡¶ö‡¶ø‡¶ï‡¶ø‡ßé‡¶∏‡¶æ ‡¶Ø‡ßã‡¶ó
            document.getElementById('addTreatmentBtn')?.addEventListener('click', () => {
                if (currentPatient) {
                    const patientData = currentPatient.data;
                    const params = new URLSearchParams({
                        name: patientData.name || '',
                        phone: patientData.phone || '',
                        address: patientData.address || '',
                        age: patientData.age || '',
                        fromProfile: currentPatient.id
                    });
                    
                    window.location.href = `amarghor.html?${params.toString()}`;
                }
            });
            
            // ‡¶∞‡ßã‡¶ó‡ßÄ ‡¶§‡¶•‡ßç‡¶Ø ‡¶∏‡¶Æ‡ßç‡¶™‡¶æ‡¶¶‡¶®‡¶æ
            document.getElementById('editPatientBtn')?.addEventListener('click', () => {
                if (currentPatient) {
                    const patientData = currentPatient.data;
                    const params = new URLSearchParams({
                        edit: currentPatient.id,
                        name: patientData.name || '',
                        phone: patientData.phone || '',
                        address: patientData.address || '',
                        age: patientData.age || ''
                    });
                    
                    window.location.href = `amarghor.html?${params.toString()}`;
                }
            });
            
            // ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶Æ‡¶°‡¶æ‡¶≤
            document.getElementById('openMessageModalBtn')?.addEventListener('click', () => {
                const modal = document.getElementById('messageModal');
                if (!modal) return;
                
                modal.classList.add('active');
                
                selectedMessageType = '';
                document.querySelectorAll('.message-option').forEach(opt => opt.classList.remove('selected'));
                document.getElementById('customMessage').value = '';
                
                const previewElement = document.getElementById('previewText');
                if (previewElement && currentPatient) {
                    previewElement.innerText = `‡¶™‡ßç‡¶∞‡¶ø‡¶Ø‡¶º ${currentPatient.data.name},

‡¶è‡¶ï‡¶ü‡¶ø ‡¶Ö‡¶™‡¶∂‡¶® ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§

‡¶â‡¶™‡¶∞‡ßá ‡¶§‡¶ø‡¶®‡¶ü‡¶ø ‡¶Ö‡¶™‡¶∂‡¶® ‡¶•‡ßá‡¶ï‡ßá ‡¶Ø‡ßá‡¶ï‡ßã‡¶®‡ßã ‡¶è‡¶ï‡¶ü‡¶ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®:

‡ßß. ‡¶ï‡ßç‡¶∞‡¶æ‡¶â‡¶®/‡¶ï‡ßç‡¶Ø‡¶æ‡¶™ ‡¶§‡ßà‡¶∞‡¶ø ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá
‡ß®. ‡¶ö‡¶ø‡¶ï‡¶ø‡ßé‡¶∏‡¶æ ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶ì ‡¶¨‡¶ø‡¶≤ ‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß
‡ß©. ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ ‡¶ü‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø`;
                }
            });
            
            // ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶Ö‡¶™‡¶∂‡¶®
            document.querySelectorAll('.message-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.message-option').forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedMessageType = this.dataset.message;
                    
                    if (currentPatient) {
                        const message = generateMessage(selectedMessageType, currentPatient.data, allTreatments);
                        document.getElementById('previewText').innerText = message;
                    }
                });
            });
            
            // ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶™‡¶æ‡¶†‡¶æ‡¶®
            document.getElementById('sendMessageBtn')?.addEventListener('click', sendMessage);
            
            // ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶ü‡ßç‡¶Ø‡¶æ‡¶¨
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    currentFilter = this.dataset.filter;
                    updateTreatmentHistory();
                });
            });
            
            // ‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶™‡¶∞‡¶ø‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ‡¶® ‡¶ü‡¶ó‡¶≤
            document.getElementById('toggleMonthlyStats')?.addEventListener('click', () => {
                document.getElementById('monthlyContent')?.classList.toggle('active');
                const icon = document.getElementById('toggleIcon');
                if (icon) {
                    icon.classList.toggle('fa-chevron-down');
                    icon.classList.toggle('fa-chevron-up');
                }
            });
            
            // ‡¶™‡ßá‡¶∂‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡ßç‡¶Ø‡ßÅ‡¶á‡¶ö‡¶æ‡¶∞
            document.getElementById('switchPatientBtn')?.addEventListener('click', () => {
                if (allPatientsWithSamePhone.length > 1) {
                    currentPatientIndex = (currentPatientIndex + 1) % allPatientsWithSamePhone.length;
                    loadCurrentPatient();
                    updatePatientSwitcher();
                    
                    // ‡¶á‡¶â‡¶Ü‡¶∞‡¶è‡¶≤ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
                    const url = new URL(window.location);
                    url.searchParams.set('profileId', allPatientsWithSamePhone[currentPatientIndex].id);
                    window.history.pushState({}, '', url);
                }
            });
            
            // ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶¨‡¶æ‡¶ü‡¶®
            document.getElementById('searchBtn')?.addEventListener('click', searchPatient);
            
            // ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶á‡¶®‡¶™‡ßÅ‡¶ü‡ßá ‡¶è‡¶®‡ßç‡¶ü‡¶æ‡¶∞ ‡¶ö‡¶æ‡¶™‡¶≤‡ßá
            document.getElementById('searchPhone')?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    searchPatient();
                }
            });
            
            // ‡¶®‡ßá‡¶≠‡¶ø‡¶ó‡ßá‡¶∂‡¶® ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö
            document.getElementById('searchNav')?.addEventListener('click', (e) => {
                e.preventDefault();
                document.querySelector('.search-section').scrollIntoView({ behavior: 'smooth' });
                document.getElementById('searchPhone').focus();
            });
        });

        // ========== ‡¶Ö‡¶• ‡¶ö‡ßá‡¶ï ==========
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = "log.html";
            } else {
                init();
            }
        });
    </script> 

</body>
</html>
